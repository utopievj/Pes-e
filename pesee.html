<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pesée</title>
<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:900px;margin:auto;padding:18px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:10px 0 6px;font-size:12px;color:#a8b3d6}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff}
button{width:100%;padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800}
button:hover{background:#d32f2f}
.big{font-size:34px;font-weight:900}
.net{margin-top:14px;padding:14px;border:1px solid #222634;border-radius:14px;background:#0f1118}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}
.col-2{grid-column:span 2}
.col-6{grid-column:span 6}
.col-12{grid-column:span 12}
@media(max-width:760px){.col-4,.col-2,.col-6{grid-column:span 12}}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #222634}
th{font-size:12px;color:#a8b3d6}
.warn{margin-top:8px;color:#ffcc66;font-size:12px;display:none}
</style>
</head>
<body>

<div id="login" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
  <div class="card" style="max-width:320px;width:100%">
    <h2 style="text-align:center">Code PIN</h2>
    <input id="pinInput" type="password" inputmode="numeric" placeholder="••••">
    <button onclick="checkPin()">ENTRER</button>
    <div id="errPin" style="display:none;color:#ff5a6a;text-align:center;margin-top:10px">Code incorrect</div>
  </div>
</div>

<div id="app" style="display:none">
<div class="wrap">
<div class="card">

<h2>Pesée</h2>

<div class="grid">
  <div class="col-4">
    <label>Ville</label>
    <select id="ville">
      <option>Boulanger Tarbes</option>
      <option>Pau</option>
      <option>Envie</option>
      <option>Assat</option>
      <option>Coaraze</option>
      <option>Espoey</option>
    </select>
  </div>

  <div class="col-4">
    <label>Type de bac</label>
    <select id="type">
      <option value="PAM">PAM</option>
      <option value="ASL">ASL</option>
      <option value="ABJ">ABJ</option>
      <option value="FRIGO">Frigo</option>
      <option value="HF">Hors froid</option>
    </select>
  </div>

  <div class="col-2">
    <label>Nombre</label>
    <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
  </div>

  <div class="col-2">
    <label>Poids brut (kg)</label>
    <input id="brut" type="number" step="0.1" value="" placeholder="Ex: 120.5">
  </div>

  <div class="col-12">
    <div class="net">
      <div>Tare : <b id="tare">0</b> kg</div>
      <div class="big">Net : <span id="net">0</span> kg</div>
      <div id="warn" class="warn">⚠️ Brut inférieur à la tare : net forcé à 0 (enregistrement bloqué)</div>
    </div>
  </div>

  <div class="col-6"><button onclick="save()">ENREGISTRER</button></div>
  <div class="col-6"><button onclick="resetForm()">RÉINITIALISER</button></div>
</div>

<h3>Historique (Google Sheets)</h3>
<table>
  <thead><tr><th>Date</th><th>Ville</th><th>Type</th><th>Nb</th><th>Net</th></tr></thead>
  <tbody id="hist"><tr><td colspan="5">Chargement…</td></tr></tbody>
</table>

</div>
</div>
</div>

<script>
/* CONFIG */
const PIN = "2580";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxw6o5ETWDo1PhWue9WlMs8IWojkV1ugxb3ICe7qse85IWwrtf7mrqehPKdc2x8noIo/exec";
const API_KEY = "sirmet2025";

/* PESÉE */
const T={PAM:59,ASL:45,ABJ:43,FRIGO:0,HF:0};
const A={PAM:"PAM",ASL:"ASL",ABJ:"ABJ",FRIGO:"F",HF:"HF"};
const r1=x=>Math.round(x*10)/10;
const num=x=>{const v=Number(String(x).replace(",", ".")); return Number.isFinite(v)?v:0; };

function checkPin(){
  if(pinInput.value===PIN){
    login.style.display="none";
    app.style.display="block";
    render();
  } else errPin.style.display="block";
}

function calc(){
  const n=Number(nb.value);
  const b=num(brut.value);
  const t=(T[type.value]||0)*n;
  tare.textContent=r1(t);
  let nnet=b-t;
  const neg=nnet<0;
  if(neg) nnet=0;
  net.textContent=r1(nnet);
  warn.style.display=neg?"block":"none";
}
["input","change"].forEach(ev=>{
  type.addEventListener(ev,calc);
  nb.addEventListener(ev,calc);
  brut.addEventListener(ev,calc);
});

function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{cleanup(); resolve(data);};
    const s=document.createElement("script");
    s.src=url+(url.includes("?")?"&":"?")+"callback="+cb+"&ts="+Date.now();
    s.onerror=()=>{cleanup(); reject("Load failed (Apps Script non public ou mauvaise version)");};
    document.body.appendChild(s);
    function cleanup(){
      try{delete window[cb];}catch{}
      if(s.parentNode) s.parentNode.removeChild(s);
    }
  });
}

async function render(){
  hist.innerHTML="<tr><td colspan='5'>Chargement…</td></tr>";
  try{
    const data=await jsonp(`${SCRIPT_URL}?key=${encodeURIComponent(API_KEY)}`);
    if(!data.ok){ hist.innerHTML=`<tr><td colspan='5'>Erreur: ${data.error||"inconnue"}</td></tr>`; return; }
    hist.innerHTML="";
    (data.rows||[]).forEach(e=>{
      hist.innerHTML+=`<tr>
        <td>${e.date??""}</td><td>${e.ville??""}</td><td>${e.type??""}</td><td>${e.nb??""}</td><td>${e.net??""}</td>
      </tr>`;
    });
  }catch(err){
    hist.innerHTML=`<tr><td colspan='5'>Erreur réseau: ${err}</td></tr>`;
  }
}

async function save(){
  calc();
  const n=Number(nb.value);
  const b=num(brut.value);
  const t=(T[type.value]||0)*n;
  if(b<=0){ alert("Entre un poids brut."); return; }
  if(b<t){ alert("Brut inférieur à la tare. Corrige le brut."); return; }

  const url = `${SCRIPT_URL}?key=${encodeURIComponent(API_KEY)}&action=add`+
    `&date=${encodeURIComponent(new Date().toLocaleString())}`+
    `&ville=${encodeURIComponent(ville.value)}`+
    `&type=${encodeURIComponent(A[type.value])}`+
    `&nb=${encodeURIComponent(n)}`+
    `&brut=${encodeURIComponent(r1(b))}`+
    `&tare=${encodeURIComponent(r1(t))}`+
    `&net=${encodeURIComponent(r1(b-t))}`;

  try{
    const data=await jsonp(url);
    if(!data.ok){ alert("Erreur Sheets: "+(data.error||"inconnue")); return; }
    await render();
    resetForm();
  }catch(err){
    alert("Erreur réseau: "+err);
  }
}

function resetForm(){ type.value="PAM"; nb.value="1"; brut.value=""; calc(); }
calc();
</script>

</body>
</html>
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pes√©e</title>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:900px;margin:auto;padding:18px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:10px 0 6px;font-size:12px;color:#a8b3d6}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
button{width:100%;padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
.smallBtn{width:auto;padding:10px 12px;border-radius:10px;font-size:12px}
.danger{background:#8b0000;border-color:#5c0000}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}
.col-2{grid-column:span 2}
.col-6{grid-column:span 6}
.col-12{grid-column:span 12}
@media(max-width:760px){.col-4,.col-2,.col-6{grid-column:span 12}}
.big{font-size:34px;font-weight:900}
.net{margin-top:14px;padding:14px;border:1px solid #222634;border-radius:14px;background:#0f1118}
.warn{margin-top:8px;color:#ffcc66;font-size:12px;display:none}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:14px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634;vertical-align:middle}
th{font-size:12px;color:#a8b3d6;text-align:left;white-space:nowrap}
.right{text-align:right}
.topbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.topbar button{width:auto}
.muted{color:#a8b3d6;font-size:12px}
</style>
</head>

<body>

<!-- üîê √âCRAN PIN -->
<div id="login" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
  <div class="card" style="max-width:320px;width:100%">
    <h2 style="text-align:center">Code PIN</h2>
    <input id="pinInput" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button id="pinBtn">ENTRER</button>
    <div id="errPin" style="display:none;color:#ff5a6a;text-align:center;margin-top:10px">Code incorrect</div>
  </div>
</div>

<!-- ‚úÖ APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <!-- TOP BAR -->
      <div class="topbar">
        <button class="smallBtn" id="goPesee">PES√âE</button>
        <button class="smallBtn" id="goHist">HISTORIQUE</button>
      </div>

      <!-- PAGE PES√âE -->
      <div id="pagePesee">
        <h2>Pes√©e</h2>

        <div class="grid">
          <div class="col-4">
            <label>Ville</label>
            <select id="ville"></select>
          </div>

          <div class="col-4">
            <label>Type de bac</label>
            <select id="type">
              <option value="PAM">PAM</option>
              <option value="ASL">ASL</option>
              <option value="ABJ">ABJ</option>
              <option value="FRIGO">Frigo</option>
              <option value="HF">Hors froid</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nombre</label>
            <select id="nb">
              <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            </select>
          </div>

          <div class="col-2">
            <label>Poids brut (kg)</label>
            <input id="brut" type="number" step="0.1" value="" placeholder="Ex : 120.5">
          </div>

          <div class="col-12">
            <div class="net">
              <div>Tare : <b id="tare">0</b> kg</div>
              <div class="big">Net : <span id="net">0</span> kg</div>
              <div id="warn" class="warn">‚ö†Ô∏è Brut inf√©rieur √† la tare (enregistrement bloqu√©)</div>
            </div>
          </div>

          <div class="col-6"><button id="saveBtn">ENREGISTRER</button></div>
          <div class="col-6"><button id="resetBtn">R√âINITIALISER</button></div>
        </div>
      </div>

      <!-- PAGE HISTORIQUE -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>

        <div class="topbar">
          <button id="clearAllBtn" class="smallBtn danger">VIDER L‚ÄôHISTORIQUE</button>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Ville</th><th>Type</th><th>Nb</th><th class="right">Net</th><th></th>
              </tr>
            </thead>
            <tbody id="hist"></tbody>
          </table>
        </div>

        <h3 style="margin-top:18px">Totaux net par ville</h3>
        <div class="muted">Somme des <b>poids nets</b> enregistr√©s, regroup√©e par ville et par type.</div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Ville</th>
                <th class="right">PAM</th>
                <th class="right">ASL</th>
                <th class="right">ABJ</th>
                <th class="right">F</th>
                <th class="right">HF</th>
                <th class="right">TOTAL</th>
              </tr>
            </thead>
            <tbody id="totauxVille"></tbody>
          </table>
        </div>

        <h3 style="margin-top:18px">Gestion des villes</h3>
        <div class="grid">
          <div class="col-6">
            <label>Ajouter une ville</label>
            <input id="newCity" placeholder="Nom de la ville">
            <button class="smallBtn" id="addCityBtn">‚ûï Ajouter</button>
          </div>
          <div class="col-6">
            <label>Supprimer la ville s√©lectionn√©e</label>
            <button class="smallBtn danger" id="removeCityBtn">‚ûñ Supprimer</button>
            <div class="muted">Impossible si la ville est d√©j√† utilis√©e dans l‚Äôhistorique.</div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const PIN = "2580";
const KEY_DATA = "pesee_data_v1";
const KEY_CITIES = "pesee_cities_v1";
/* ========================================= */

const $ = (id)=>document.getElementById(id);

const T = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const AFF = { PAM:"PAM", ASL:"ASL", ABJ:"ABJ", FRIGO:"F", HF:"HF" };
const TYPES_AFF = ["PAM","ASL","ABJ","F","HF"];

const r1 = (x)=> Math.round(x*10)/10;
const num = (x)=> {
  const v = Number(String(x).replace(",", "."));
  return Number.isFinite(v) ? v : 0;
};

/* ---------- NAV (pages) ---------- */
function showPage(name){
  $("pagePesee").style.display = (name==="pesee") ? "block" : "none";
  $("pageHist").style.display  = (name==="hist")  ? "block" : "none";
  if(name==="hist") renderAll();
}

/* ---------- PIN ---------- */
function checkPin(){
  if ($("pinInput").value === PIN){
    $("login").style.display="none";
    $("app").style.display="block";
    loadCitiesIntoSelect();
    calc();
    showPage("pesee");
  } else {
    $("errPin").style.display="block";
  }
}

/* ---------- CITIES ---------- */
function defaultCities(){
  return ["Boulanger Tarbes","Pau","Envie","Assat","Coaraze","Espoey"];
}
function getCities(){
  try { return JSON.parse(localStorage.getItem(KEY_CITIES) || "null") || defaultCities(); }
  catch { return defaultCities(); }
}
function saveCities(cities){
  localStorage.setItem(KEY_CITIES, JSON.stringify(cities));
}
function loadCitiesIntoSelect(){
  const v = $("ville");
  const current = v.value;
  v.innerHTML = "";
  const cities = getCities();
  cities.forEach(c=>{
    const o = document.createElement("option");
    o.value = c; o.textContent = c;
    v.appendChild(o);
  });
  // tente de garder la s√©lection
  if(cities.includes(current)) v.value = current;
}

/* ---------- DATA ---------- */
function loadData(){
  try { return JSON.parse(localStorage.getItem(KEY_DATA) || "[]"); }
  catch { return []; }
}
function saveData(arr){
  localStorage.setItem(KEY_DATA, JSON.stringify(arr));
}

/* ---------- CALC ---------- */
function calc(){
  const n = Number($("nb").value);
  const b = num($("brut").value);
  const t = (T[$("type").value] || 0) * n;

  $("tare").textContent = r1(t);

  const netv = b - t;
  $("warn").style.display = (b>0 && netv<0) ? "block" : "none";
  $("net").textContent = r1(Math.max(0, netv));
}

/* ---------- SAVE ---------- */
function save(){
  calc();
  const n = Number($("nb").value);
  const b = num($("brut").value);
  const t = (T[$("type").value] || 0) * n;
  if (b <= 0) return alert("Entre un poids brut.");
  if (b < t)  return alert("Brut inf√©rieur √† la tare. Corrige le brut.");

  const entry = {
    id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random()),
    date: new Date().toLocaleString(),
    ville: $("ville").value,
    type: AFF[$("type").value], // PAM/ASL/ABJ/F/HF
    nb: n,
    net: r1(b - t)
  };

  const data = loadData();
  data.push(entry);
  saveData(data);
  resetForm();
}

function resetForm(){
  $("type").value = "PAM";
  $("nb").value = "1";
  $("brut").value = "";
  calc();
}

/* ---------- HIST + TOTALS ---------- */
function renderHistorique(data){
  const tb = $("hist");
  tb.innerHTML = "";

  if(data.length === 0){
    tb.innerHTML = `<tr><td colspan="6" style="color:#a8b3d6">Aucune pes√©e</td></tr>`;
    return;
  }

  for(const e of data.slice().reverse()){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.ville}</td>
      <td>${e.type}</td>
      <td>${e.nb}</td>
      <td class="right"><b>${e.net}</b></td>
      <td><button class="smallBtn danger" data-del="${e.id}">X</button></td>
    `;
    tb.appendChild(tr);
  }
}

function renderTotauxParVille(data){
  const totals = {};
  for(const e of data){
    const v = e.ville || "";
    const ty = e.type || "";
    const n = num(e.net);
    if(!totals[v]) totals[v] = { PAM:0, ASL:0, ABJ:0, F:0, HF:0 };
    if(totals[v][ty] === undefined) continue;
    totals[v][ty] += n;
  }

  const villes = Object.keys(totals).sort((a,b)=>a.localeCompare(b,"fr"));
  const tb = $("totauxVille");
  tb.innerHTML = "";

  if(villes.length === 0){
    tb.innerHTML = `<tr><td colspan="7" style="color:#a8b3d6">Aucune donn√©e</td></tr>`;
    return;
  }

  for(const v of villes){
    const row = totals[v];
    const total = TYPES_AFF.reduce((s,t)=> s + (row[t]||0), 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v}</td>
      <td class="right">${r1(row.PAM)}</td>
      <td class="right">${r1(row.ASL)}</td>
      <td class="right">${r1(row.ABJ)}</td>
      <td class="right">${r1(row.F)}</td>
      <td class="right">${r1(row.HF)}</td>
      <td class="right"><b>${r1(total)}</b></td>
    `;
    tb.appendChild(tr);
  }
}

function renderAll(){
  loadCitiesIntoSelect();
  const data = loadData();
  renderHistorique(data);
  renderTotauxParVille(data);
}

/* ---------- villes add/remove ---------- */
function addCity(){
  const name = $("newCity").value.trim();
  if(!name) return alert("Nom vide");
  const cities = getCities();
  if(cities.includes(name)) return alert("Existe d√©j√†");
  cities.push(name);
  saveCities(cities);
  $("newCity").value = "";
  renderAll();
}

function removeCity(){
  const city = $("ville").value;
  const data = loadData();
  if(data.some(e=>e.ville===city)){
    return alert("Impossible : ville utilis√©e dans l‚Äôhistorique");
  }
  const cities = getCities().filter(c=>c!==city);
  saveCities(cities);
  renderAll();
}

/* ---------- clear / delete ---------- */
function clearAll(){
  if(confirm("Vider tout l‚Äôhistorique ?")){
    localStorage.removeItem(KEY_DATA);
    renderAll();
  }
}
function deleteEntry(id){
  const arr = loadData().filter(x=>x.id!==id);
  saveData(arr);
  renderAll();
}

/* ---------- events ---------- */
$("pinBtn").addEventListener("click", checkPin);
$("pinInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") checkPin(); });

$("goPesee").addEventListener("click", ()=>showPage("pesee"));
$("goHist").addEventListener("click", ()=>showPage("hist"));

["input","change"].forEach(ev=>{
  $("type").addEventListener(ev, calc);
  $("nb").addEventListener(ev, calc);
  $("brut").addEventListener(ev, calc);
});

$("saveBtn").addEventListener("click", save);
$("resetBtn").addEventListener("click", resetForm);

$("addCityBtn").addEventListener("click", addCity);
$("removeCityBtn").addEventListener("click", removeCity);

$("clearAllBtn").addEventListener("click", clearAll);

$("hist").addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-del]");
  if(!btn) return;
  const id = btn.getAttribute("data-del");
  if(!confirm("Supprimer cette pes√©e ?")) return;
  deleteEntry(id);
});

/* init */
calc();
</script>

</body>
</html>
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pes√©e</title>

<!-- PWA -->
<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px;color:#a8b3d6}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
.smallBtn{padding:10px 12px;font-size:12px}
.danger{background:#8b0000;border-color:#5c0000}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:820px){.col-4,.col-3,.col-2,.col-6{grid-column:span 12}}
.big{font-size:34px;font-weight:900;margin:8px 0}
.badge{display:inline-block;padding:4px 10px;border:1px solid #222634;border-radius:999px;font-size:12px;color:#a8b3d6}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
th{font-size:12px;color:#a8b3d6;white-space:nowrap;text-align:left}
.right{text-align:right}
.center{min-height:90vh;display:flex;align-items:center;justify-content:center}
.max420{max-width:420px;width:100%}
#status{margin:10px 0;font-size:12px;white-space:pre-wrap;color:#ffd27a}
.muted{color:#a8b3d6;font-size:12px}
hr{border:0;border-top:1px solid #222634;margin:14px 0}
.tag{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #222634;color:#a8b3d6}
.tagOk{border-color:#1f6f3a;color:#a7f3c6}
.tagWait{border-color:#7a1f1f;color:#ffd27a}
.tagCache{border-color:#3a4a7a;color:#b7c6ff}

/* CLEAN */
label, th, .badge { color:#ffffff !important; }
.muted, .tag { display:none !important; }
#status { display:none !important; }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card max420">
    <h2 style="margin-top:0">Connexion</h2>

    <label>Email</label>
    <input id="email" type="email" autocomplete="username">

    <label>Mot de passe</label>
    <input id="password" type="password" autocomplete="current-password">

    <div style="margin-top:12px;display:grid;gap:10px">
      <button onclick="login()">SE CONNECTER</button>
    </div>

    <div id="loginMsg" style="margin-top:10px;font-size:12px;white-space:pre-wrap;color:#ffd27a"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="smallBtn" onclick="show('pesee')">PES√âE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="show('trie')">TRIE</button>

        <button class="smallBtn" onclick="loadData()">üîÑ Rafra√Æchir</button>
        <button class="smallBtn" onclick="syncPending()">‚ü≥ SYNC PES√âE (<span id="pendingCount">0</span>)</button>

        <button class="smallBtn" onclick="syncTrieAll()">‚ü≥ SYNC TRIE</button>

        <button class="smallBtn" onclick="logout()">üö™ D√©connexion</button>

        <span class="badge" id="badgeUser">Connect√©</span>
        <span class="badge" id="badgeNet">R√©seau : ?</span>
        <span class="badge" id="badgeAdmin">Utilisateur</span>
        <span class="badge" id="badgeStore">Donn√©es : ?</span>
      </div>

      <div id="status">Pr√™t.</div>

      <!-- PAGE PES√âE -->
      <div id="pagePesee">
        <h2>Pes√©e</h2>

        <div class="grid">
          <div class="col-4">
            <label>Ville</label>
            <select id="ville"></select>
          </div>

          <div class="col-4">
            <label>Type</label>
            <select id="type">
              <option value="PAM">PAM</option>
              <option value="ASL">ASL</option>
              <option value="ABJ">ABJ</option>
              <option value="FRIGO">Frigo</option>
              <option value="HF">Hors froid</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nb bacs</label>
            <input id="nb" type="number" inputmode="numeric" min="1" value="1">
          </div>

          <div class="col-2">
            <label>Brut (kg)</label>
            <input id="brut" type="number" inputmode="decimal" step="0.1" placeholder="Ex: 120.5">
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="net">0</span> kg</div>
          </div>

          <div class="col-12">
            <button onclick="saveSafe()">ENREGISTRER</button>
          </div>
        </div>
      </div>

      <!-- PAGE HIST -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>

        <div id="adminPanel" style="display:none">
          <hr>
          <h3>Admin</h3>
          <button class="smallBtn danger" onclick="clearAll()">üßπ Vider tout l‚Äôhistorique (SQL admin)</button>
        </div>

        <hr>

        <h3>En attente (hors-ligne) ‚Äì Pes√©e</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th>Date</th><th>Ville</th><th>Type</th><th class="right">Nb</th><th class="right">Net</th><th class="right">Action</th></tr>
            </thead>
            <tbody id="pendingTable"></tbody>
          </table>
        </div>

        <hr>

        <h3>Historique pes√©es (Supabase + Cache + En attente)</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Ville</th><th>Type</th><th class="right">Nb</th><th class="right">Net</th><th>Op√©rateur</th><th>Source</th>
                <th id="thAdmin" style="display:none">Admin</th>
              </tr>
            </thead>
            <tbody id="histMix"></tbody>
          </table>
        </div>

        <hr>

        <h2>Trie (r√©sum√© dans Historique)</h2>

        <h3>PAM tri√© (+/-1)</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="pamTrieTotalsHist"></tbody>
          </table>
        </div>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">Œî</th><th>Op√©rateur</th><th>Source</th></tr></thead>
            <tbody id="pamTrieHistHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>ASL tri√© (+/-1)</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="aslTrieTotalsHist"></tbody>
          </table>
        </div>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">Œî</th><th>Op√©rateur</th><th>Source</th></tr></thead>
            <tbody id="aslTrieHistHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>Trie au poids (kg) ‚Äì Totaux par jour</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th>Cat√©gorie</th><th class="right">Total net (kg)</th></tr></thead>
            <tbody id="triePoidsTotalsHist"></tbody>
          </table>
        </div>

        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th>Cat√©gorie</th><th>Bac</th><th class="right">Nb</th><th class="right">Net</th><th>Op√©rateur</th><th>Source</th></tr></thead>
            <tbody id="triePoidsHistHist"></tbody>
          </table>
        </div>
      </div>

      <!-- PAGE TRIE -->
      <div id="pageTrie" style="display:none">
        <h2>Trie</h2>

        <h3>PAM tri√©</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button onclick="addPamTrie(+1)">+1 PAM tri√©</button>
          <button class="danger" onclick="addPamTrie(-1)">-1 PAM tri√©</button>
          <button class="smallBtn" onclick="syncPamTriePending()">‚ü≥ SYNC PAM (<span id="pamTriePendingCount">0</span>)</button>
        </div>

        <h3>ASL tri√©</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button onclick="addAslTrie(+1)">+1 ASL tri√©</button>
          <button class="danger" onclick="addAslTrie(-1)">-1 ASL tri√©</button>
          <button class="smallBtn" onclick="syncAslTriePending()">‚ü≥ SYNC ASL (<span id="aslTriePendingCount">0</span>)</button>
        </div>

        <hr>

        <h3>Trie au poids (kg)</h3>

        <div class="grid">
          <div class="col-4">
            <label>Cat√©gorie</label>
            <select id="trieCat">
              <option value="PLASTIQUE_DUR">Plastique dur</option>
              <option value="PLASTIQUE_MOU">Plastique mou</option>
              <option value="ASL_AUTRE">ASL autre</option>
              <option value="N_DIB">N-DIB</option>
              <option value="NREP_ECOMAISON">NREP ecomaison</option>
              <option value="NREP_REFASHION">NREP refashion</option>
              <option value="PAM_PILE">PAM pile</option>
              <option value="PAM_BAC">PAM bac</option>
            </select>
          </div>

          <div class="col-4">
            <label>Type de bac (tare)</label>
            <select id="trieBac">
              <option value="ABJ">ABJ (43 kg)</option>
              <option value="ASL">ASL (45 kg)</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nb bacs</label>
            <input id="trieNb" type="number" inputmode="numeric" min="1" value="1">
          </div>

          <div class="col-2">
            <label>Brut (kg)</label>
            <input id="trieBrut" type="number" inputmode="decimal" step="0.1">
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="trieNet">0</span> kg</div>
          </div>

          <div class="col-12">
            <button onclick="saveTriePoids()">ENREGISTRER (kg)</button>
            <button class="smallBtn" onclick="syncTriePoidsPending()">‚ü≥ SYNC POIDS (<span id="triePoidsPendingCount">0</span>)</button>
          </div>
        </div>

        <hr>

        <h3>Totaux (aujourd‚Äôhui)</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Cat√©gorie</th><th class="right">Total net (kg)</th></tr></thead>
            <tbody id="triePoidsToday"></tbody>
          </table>
        </div>

        <hr>

        <h3>Historique Trie (poids)</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Date/Heure</th><th>Cat√©gorie</th><th>Bac</th><th class="right">Nb</th><th class="right">Net</th><th>Op√©rateur</th><th>Source</th></tr></thead>
            <tbody id="triePoidsHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>Totaux PAM tri√© / jour</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="pamTrieTotals"></tbody>
          </table>
        </div>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">Œî</th><th>Op√©rateur</th><th>Source</th></tr></thead>
            <tbody id="pamTrieHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>Totaux ASL tri√© / jour</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="aslTrieTotals"></tbody>
          </table>
        </div>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">Œî</th><th>Op√©rateur</th><th>Source</th></tr></thead>
            <tbody id="aslTrieHist"></tbody>
          </table>
        </div>

      </div>

    </div>
  </div>
</div>
<script>
/* ‚úÖ SUPABASE */
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0"
);

/* TARES */
const T = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const A = { PAM:"PAM", ASL:"ASL", ABJ:"ABJ", FRIGO:"F", HF:"HF" };

const $ = (id)=>document.getElementById(id);
const r1 = (x)=>Math.round(x*10)/10;
const num = (x)=>{ const v=Number(String(x).replace(",", ".")); return Number.isFinite(v)?v:0; };

let currentUser = null;
let isAdminUser = false;
let lastHistorySource = "CACHE";

/* OFFLINE KEYS (PES√âE) */
const PENDING_KEY = "pesees_pending_v5";
const HISTORY_CACHE_KEY = "pesees_history_cache_v2";
const CACHE_META_KEY = "pesees_history_cache_meta_v2";

/* OFFLINE KEYS (TRIE +/-) */
const PAM_TRIE_PENDING_KEY = "pam_trie_pending_v2";
const PAM_TRIE_CACHE_KEY   = "pam_trie_cache_v2";
const PAM_TRIE_META_KEY    = "pam_trie_cache_meta_v2";
let lastPamTrieSource = "CACHE";

const ASL_TRIE_PENDING_KEY = "asl_trie_pending_v2";
const ASL_TRIE_CACHE_KEY   = "asl_trie_cache_v2";
const ASL_TRIE_META_KEY    = "asl_trie_cache_meta_v2";
let lastAslTrieSource = "CACHE";

/* OFFLINE KEYS (TRIE POIDS) */
const TRIE_POIDS_PENDING_KEY = "trie_poids_pending_v1";
const TRIE_POIDS_CACHE_KEY   = "trie_poids_cache_v1";
const TRIE_POIDS_META_KEY    = "trie_poids_cache_meta_v1";
let lastTriePoidsSource = "CACHE";

/* UI */
function setStatus(msg){ if($("status")) $("status").textContent = msg || ""; }
function setLoginMsg(msg){ $("loginMsg").textContent = msg || ""; }
function refreshNetwork(){ $("badgeNet").textContent = "R√©seau : " + (navigator.onLine ? "OK" : "HORS-LIGNE"); }
function setStoreBadge(){
  const meta = getHistoryMeta();
  const info = meta?.updatedAt ? new Date(meta.updatedAt).toLocaleString() : "‚Äî";
  $("badgeStore").textContent = `Donn√©es : ${lastHistorySource} (${info})`;
}
window.addEventListener("online", ()=>{
  refreshNetwork();
  syncPending();
  syncTrieAll();
});
window.addEventListener("offline", refreshNetwork);

/* Admin */
async function checkAdmin(){
  const { data, error } = await supabase.rpc("is_admin");
  if(error) throw error;
  return !!data;
}
function setAdminUI(){
  $("badgeAdmin").textContent = isAdminUser ? "ADMIN" : "Utilisateur";
  $("adminPanel").style.display = isAdminUser ? "block" : "none";
  $("thAdmin").style.display = isAdminUser ? "table-cell" : "none";
}

/* Pages */
function show(p){
  $("pagePesee").style.display = (p==="pesee") ? "block" : "none";
  $("pageHist").style.display  = (p==="hist")  ? "block" : "none";
  $("pageTrie").style.display  = (p==="trie")  ? "block" : "none";

  if(p==="hist"){
    loadCities();
    loadData();
    renderPending();
    renderMixedHistory();
    loadTrieAll();
  }
  if(p==="trie"){
    loadTrieAll();
  }
}

/* ======================
   PES√âE
====================== */
function calc(){
  const nb = Math.max(1, Math.floor(num($("nb").value)));
  const brut = num($("brut").value);
  const tare = (T[$("type").value] || 0) * nb;
  const net = Math.max(0, brut - tare);
  $("net").textContent = r1(net);
}
["input","change"].forEach(ev=>{
  $("type").addEventListener(ev, calc);
  $("nb").addEventListener(ev, calc);
  $("brut").addEventListener(ev, calc);
});

/* Pending */
function getPending(){ try{ return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]"); } catch{ return []; } }
function setPending(arr){ localStorage.setItem(PENDING_KEY, JSON.stringify(arr)); $("pendingCount").textContent = String(arr.length); }
function addPending(row){ const arr=getPending(); arr.unshift(row); setPending(arr); }
function removePending(client_id){ setPending(getPending().filter(x=>x.client_id !== client_id)); }

function renderPending(){
  const arr = getPending();
  $("pendingCount").textContent = String(arr.length);
  const tb = $("pendingTable");
  tb.innerHTML = "";
  if(!arr.length){
    tb.innerHTML = `<tr><td colspan="6" class="muted">Aucune ligne en attente</td></tr>`;
    return;
  }
  arr.forEach(x=>{
    tb.innerHTML += `
      <tr>
        <td>${new Date(x.local_created_at).toLocaleString()}</td>
        <td>${x.ville}</td>
        <td>${x.type}</td>
        <td class="right">${x.nb}</td>
        <td class="right">${x.net}</td>
        <td class="right"><button class="smallBtn danger" onclick="deletePending('${x.client_id}')">Suppr</button></td>
      </tr>`;
  });
}
function deletePending(client_id){
  if(!confirm("Supprimer cette ligne en attente ?")) return;
  removePending(client_id);
  renderPending();
  renderMixedHistory();
}

/* Cache */
function getHistoryCache(){ try{ return JSON.parse(localStorage.getItem(HISTORY_CACHE_KEY) || "[]"); } catch{ return []; } }
function setHistoryCache(rows, source){
  localStorage.setItem(HISTORY_CACHE_KEY, JSON.stringify(rows || []));
  localStorage.setItem(CACHE_META_KEY, JSON.stringify({ updatedAt: Date.now(), source: source || "LIVE" }));
}
function getHistoryMeta(){ try{ return JSON.parse(localStorage.getItem(CACHE_META_KEY) || "null"); } catch{ return null; } }

/* Render mixed history */
function renderMixedHistory(){
  const pending = getPending().map(p=>({
    id: null,
    created_at: new Date(p.local_created_at).toISOString(),
    ville: p.ville,
    type: p.type,
    nb: p.nb,
    net: p.net,
    operateur: p.operateur || "",
    _source: "ATTENTE",
    _client_id: p.client_id
  }));

  const cached = getHistoryCache().map(r=>({
    ...r,
    _source: (lastHistorySource === "LIVE" ? "LIVE" : "CACHE")
  }));

  const all = [...pending, ...cached].sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));

  const tb = $("histMix");
  tb.innerHTML = "";

  if(!all.length){
    tb.innerHTML = `<tr><td colspan="${isAdminUser?8:7}" class="muted">Aucune donn√©e</td></tr>`;
    return;
  }

  all.forEach(r=>{
    const src = r._source;
    const adminCell = isAdminUser
      ? (src==="ATTENTE" ? `<td class="muted">‚Äî</td>` : `<td><button class="smallBtn danger" onclick="deleteRow(${r.id})">Suppr</button></td>`)
      : "";

    tb.innerHTML += `
      <tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.ville}</td>
        <td>${r.type}</td>
        <td class="right">${r.nb}</td>
        <td class="right">${r.net}</td>
        <td>${r.operateur || ""}</td>
        <td>${src}</td>
        ${adminCell}
      </tr>`;
  });
}

/* SYNC pending -> supabase */
async function syncPending(){
  const arr = getPending();
  $("pendingCount").textContent = String(arr.length);
  if(!arr.length) return;
  if(!navigator.onLine) return;

  const { data: u } = await supabase.auth.getUser();
  if(!u?.user) return;

  const toSend = [...arr].reverse();
  for(const row of toSend){
    try{
      const payload = {
        client_id: row.client_id,
        ville: row.ville,
        type: row.type,
        nb: row.nb,
        brut: row.brut,
        tare: row.tare,
        net: row.net,
        operateur: row.operateur || (u.user.email||null)
      };
      const { error } = await supabase.from("pesees").upsert(payload, { onConflict: "client_id" });
      if(error) throw error;
      removePending(row.client_id);
    }catch{
      break;
    }
  }
  renderPending();
  await loadData();
  renderMixedHistory();
}

async function saveSafe(){
  try{
    calc();
    const nb = Math.max(1, Math.floor(num($("nb").value)));
    const brut = num($("brut").value);
    const tare = (T[$("type").value] || 0) * nb;
    const net = Math.max(0, brut - tare);
    const ville = ($("ville").value || "").trim();
    const type = A[$("type").value];

    if(!ville || ville==="‚Äî") return alert("Choisis une ville.");
    if(brut<=0) return alert("Entre un poids brut.");
    if(brut<tare) return alert("Brut inf√©rieur √† la tare.");

    const { data: u } = await supabase.auth.getUser();
    const operateur = u?.user?.email || "";

    const client_id = "p_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    const payload = { client_id, ville, type, nb, brut:r1(brut), tare:r1(tare), net:r1(net), operateur };

    const { error } = await supabase.from("pesees").upsert(payload, { onConflict: "client_id" });
    if(error) throw error;

    $("brut").value = "";
    calc();
    await loadData();
    renderMixedHistory();
    show("pesee");
  }catch{
    const nb = Math.max(1, Math.floor(num($("nb").value)));
    const brut = num($("brut").value);
    const tare = (T[$("type").value] || 0) * nb;
    const net = Math.max(0, brut - tare);
    const ville = ($("ville").value || "").trim();
    const type = A[$("type").value];

    const { data: u } = await supabase.auth.getUser();
    const operateur = u?.user?.email || "";

    const client_id = "p_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    addPending({ client_id, local_created_at: Date.now(), ville, type, nb, brut:r1(brut), tare:r1(tare), net:r1(net), operateur });

    $("brut").value = "";
    calc();
    renderPending();
    renderMixedHistory();
    show("pesee");
  }
}

async function loadData(){
  try{
    const { data, error } = await supabase
      .from("pesees")
      .select("id, created_at, ville, type, nb, net, client_id, operateur")
      .order("created_at", { ascending:false })
      .limit(2000);

    if(error) throw error;

    lastHistorySource = "LIVE";
    setHistoryCache(data || [], "LIVE");
    setStoreBadge();
    renderMixedHistory();
  }catch{
    lastHistorySource = "CACHE";
    setStoreBadge();
    renderMixedHistory();
  }
}

/* Admin delete single */
async function deleteRow(id){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("Supprimer cette ligne ?")) return;
  await supabase.from("pesees").delete().eq("id", id);
  await loadData();
  renderMixedHistory();
}

/* ‚úÖ FIX: vider tout l'historique -> RPC admin */
async function clearAll(){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("‚ö†Ô∏è Vider TOUT ?")) return;
  const { error } = await supabase.rpc("admin_clear_all");
  if(error) return alert("Erreur: " + error.message);
  await loadData();
  renderMixedHistory();
  alert("‚úÖ Tout vid√©");
}

/* Villes */
async function loadCities(){
  try{
    const { data, error } = await supabase.from("villes").select("id, nom").order("nom", { ascending:true }).limit(500);
    if(error) throw error;

    const sel = $("ville");
    sel.innerHTML = "";
    (data||[]).forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v.nom;
      opt.textContent = v.nom;
      sel.appendChild(opt);
    });
    if(!sel.options.length) sel.innerHTML = "<option>‚Äî</option>";
  }catch{}
}

/* Login/logout */
async function login(){
  try{
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password) return setLoginMsg("Email + mot de passe.");

    setLoginMsg("Connexion‚Ä¶");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;

    const { data } = await supabase.auth.getUser();
    currentUser = data?.user || null;

    try { isAdminUser = await checkAdmin(); } catch { isAdminUser = false; }
    setAdminUI();

    $("badgeUser").textContent = currentUser?.email ? ("Connect√© : " + currentUser.email) : "Connect√©";
    $("loginScreen").style.display = "none";
    $("app").style.display = "block";

    refreshNetwork();
    await loadCities();
    await loadData();

    await loadPamTrieData();
    await loadAslTrieData();
    await loadTriePoidsData();
    loadTrieAll();

    syncPending();
    syncTrieAll();

    show("pesee");
    setLoginMsg("");
  }catch(e){
    setLoginMsg("‚ùå " + (e?.message || String(e)));
  }
}

async function logout(){
  try{
    await supabase.auth.signOut();
    location.reload();
  }catch{}
}

/* ======================
   TRIE +/- (PAM/ASL)
====================== */
function ymdLocalFromISO(iso){
  const d=new Date(iso);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

/* PAM +/- */
function getPamTriePending(){ try{ return JSON.parse(localStorage.getItem(PAM_TRIE_PENDING_KEY)||"[]"); }catch{ return []; } }
function setPamTriePending(arr){ localStorage.setItem(PAM_TRIE_PENDING_KEY, JSON.stringify(arr)); $("pamTriePendingCount").textContent = String(arr.length); }
function addPamTriePending(row){ const arr=getPamTriePending(); arr.unshift(row); setPamTriePending(arr); }
function removePamTriePending(client_id){ setPamTriePending(getPamTriePending().filter(x=>x.client_id!==client_id)); }
function getPamTrieCache(){ try{ return JSON.parse(localStorage.getItem(PAM_TRIE_CACHE_KEY)||"[]"); }catch{ return []; } }
function setPamTrieCache(rows, source){ localStorage.setItem(PAM_TRIE_CACHE_KEY, JSON.stringify(rows||[])); localStorage.setItem(PAM_TRIE_META_KEY, JSON.stringify({updatedAt:Date.now(), source})); }
function getPamTrieMeta(){ try{ return JSON.parse(localStorage.getItem(PAM_TRIE_META_KEY)||"null"); }catch{ return null; } }

async function addPamTrie(delta){
  if(delta!==1 && delta!==-1) return;
  const client_id="t_pam_"+Date.now()+"_"+Math.random().toString(16).slice(2);
  try{
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user) return alert("Connecte-toi.");
    if(!navigator.onLine) throw 1;

    const payload={ client_id, delta, operateur: u.user.email||null };
    const { error } = await supabase.from("pam_trie").upsert(payload,{ onConflict:"client_id" });
    if(error) throw error;

    await loadPamTrieData();
    loadTrieAll();
  }catch{
    const { data: u } = await supabase.auth.getUser();
    addPamTriePending({ client_id, local_created_at: Date.now(), delta, operateur: u?.user?.email||"" });
    loadTrieAll();
  }
}

async function syncPamTriePending(){
  const arr=getPamTriePending();
  $("pamTriePendingCount").textContent = String(arr.length);
  if(!arr.length || !navigator.onLine) return;

  const { data: u } = await supabase.auth.getUser();
  if(!u?.user) return;

  const toSend=[...arr].reverse();
  for(const row of toSend){
    try{
      const payload={ client_id: row.client_id, delta: row.delta, operateur: row.operateur || (u.user.email||null) };
      const { error } = await supabase.from("pam_trie").upsert(payload,{ onConflict:"client_id" });
      if(error) throw error;
      removePamTriePending(row.client_id);
    }catch{ break; }
  }
  await loadPamTrieData();
  loadTrieAll();
}

async function loadPamTrieData(){
  try{
    const { data, error } = await supabase
      .from("pam_trie")
      .select("id, created_at, delta, client_id, operateur")
      .order("created_at",{ ascending:false })
      .limit(3000);
    if(error) throw error;
    lastPamTrieSource="LIVE";
    setPamTrieCache(data||[], "LIVE");
  }catch{
    lastPamTrieSource="CACHE";
  }
}

function buildPamTrieMerged(){
  const pending=getPamTriePending().map(p=>({ created_at:new Date(p.local_created_at).toISOString(), delta:p.delta, operateur:p.operateur||"", _source:"ATTENTE" }));
  const cached=getPamTrieCache().map(r=>({ ...r, _source:(lastPamTrieSource==="LIVE"?"LIVE":"CACHE") }));
  const all=[...pending,...cached].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  const totals={};
  for(const r of all){
    const day=ymdLocalFromISO(r.created_at);
    totals[day]=(totals[day]||0)+(Number(r.delta)||0);
  }
  const totalsArr=Object.keys(totals).sort((a,b)=>b.localeCompare(a)).map(day=>({ day, total: totals[day] }));
  return { all, totalsArr };
}

function renderPamTrieTables(totalsId, histId){
  const { all, totalsArr } = buildPamTrieMerged();

  const tbT=$(totalsId); tbT.innerHTML="";
  tbT.innerHTML = totalsArr.length
    ? totalsArr.map(r=>`<tr><td>${r.day}</td><td class="right"><b>${r.total}</b></td></tr>`).join("")
    : `<tr><td colspan="2" class="muted">Aucune donn√©e</td></tr>`;

  const tbH=$(histId); tbH.innerHTML="";
  tbH.innerHTML = all.length
    ? all.slice(0,400).map(r=>{
        const dt=new Date(r.created_at).toLocaleString();
        const v=(r.delta>0?("+"+r.delta):String(r.delta));
        return `<tr><td>${dt}</td><td class="right"><b>${v}</b></td><td>${r.operateur||""}</td><td>${r._source}</td></tr>`;
      }).join("")
    : `<tr><td colspan="4" class="muted">Aucune donn√©e</td></tr>`;
}

/* ASL +/- */
function getAslTriePending(){ try{ return JSON.parse(localStorage.getItem(ASL_TRIE_PENDING_KEY)||"[]"); }catch{ return []; } }
function setAslTriePending(arr){ localStorage.setItem(ASL_TRIE_PENDING_KEY, JSON.stringify(arr)); $("aslTriePendingCount").textContent = String(arr.length); }
function addAslTriePending(row){ const arr=getAslTriePending(); arr.unshift(row); setAslTriePending(arr); }
function removeAslTriePending(client_id){ setAslTriePending(getAslTriePending().filter(x=>x.client_id!==client_id)); }
function getAslTrieCache(){ try{ return JSON.parse(localStorage.getItem(ASL_TRIE_CACHE_KEY)||"[]"); }catch{ return []; } }
function setAslTrieCache(rows, source){ localStorage.setItem(ASL_TRIE_CACHE_KEY, JSON.stringify(rows||[])); localStorage.setItem(ASL_TRIE_META_KEY, JSON.stringify({updatedAt:Date.now(), source})); }
function getAslTrieMeta(){ try{ return JSON.parse(localStorage.getItem(ASL_TRIE_META_KEY)||"null"); }catch{ return null; } }

async function addAslTrie(delta){
  if(delta!==1 && delta!==-1) return;
  const client_id="t_asl_"+Date.now()+"_"+Math.random().toString(16).slice(2);
  try{
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user) return alert("Connecte-toi.");
    if(!navigator.onLine) throw 1;

    const payload={ client_id, delta, operateur: u.user.email||null };
    const { error } = await supabase.from("asl_trie").upsert(payload,{ onConflict:"client_id" });
    if(error) throw error;

    await loadAslTrieData();
    loadTrieAll();
  }catch{
    const { data: u } = await supabase.auth.getUser();
    addAslTriePending({ client_id, local_created_at: Date.now(), delta, operateur: u?.user?.email||"" });
    loadTrieAll();
  }
}

async function syncAslTriePending(){
  const arr=getAslTriePending();
  $("aslTriePendingCount").textContent = String(arr.length);
  if(!arr.length || !navigator.onLine) return;

  const { data: u } = await supabase.auth.getUser();
  if(!u?.user) return;

  const toSend=[...arr].reverse();
  for(const row of toSend){
    try{
      const payload={ client_id: row.client_id, delta: row.delta, operateur: row.operateur || (u.user.email||null) };
      const { error } = await supabase.from("asl_trie").upsert(payload,{ onConflict:"client_id" });
      if(error) throw error;
      removeAslTriePending(row.client_id);
    }catch{ break; }
  }
  await loadAslTrieData();
  loadTrieAll();
}

async function loadAslTrieData(){
  try{
    const { data, error } = await supabase
      .from("asl_trie")
      .select("id, created_at, delta, client_id, operateur")
      .order("created_at",{ ascending:false })
      .limit(3000);
    if(error) throw error;
    lastAslTrieSource="LIVE";
    setAslTrieCache(data||[], "LIVE");
  }catch{
    lastAslTrieSource="CACHE";
  }
}

function buildAslTrieMerged(){
  const pending=getAslTriePending().map(p=>({ created_at:new Date(p.local_created_at).toISOString(), delta:p.delta, operateur:p.operateur||"", _source:"ATTENTE" }));
  const cached=getAslTrieCache().map(r=>({ ...r, _source:(lastAslTrieSource==="LIVE"?"LIVE":"CACHE") }));
  const all=[...pending,...cached].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  const totals={};
  for(const r of all){
    const day=ymdLocalFromISO(r.created_at);
    totals[day]=(totals[day]||0)+(Number(r.delta)||0);
  }
  const totalsArr=Object.keys(totals).sort((a,b)=>b.localeCompare(a)).map(day=>({ day, total: totals[day] }));
  return { all, totalsArr };
}

function renderAslTrieTables(totalsId, histId){
  const { all, totalsArr } = buildAslTrieMerged();

  const tbT=$(totalsId); tbT.innerHTML="";
  tbT.innerHTML = totalsArr.length
    ? totalsArr.map(r=>`<tr><td>${r.day}</td><td class="right"><b>${r.total}</b></td></tr>`).join("")
    : `<tr><td colspan="2" class="muted">Aucune donn√©e</td></tr>`;

  const tbH=$(histId); tbH.innerHTML="";
  tbH.innerHTML = all.length
    ? all.slice(0,400).map(r=>{
        const dt=new Date(r.created_at).toLocaleString();
        const v=(r.delta>0?("+"+r.delta):String(r.delta));
        return `<tr><td>${dt}</td><td class="right"><b>${v}</b></td><td>${r.operateur||""}</td><td>${r._source}</td></tr>`;
      }).join("")
    : `<tr><td colspan="4" class="muted">Aucune donn√©e</td></tr>`;
}

/* ======================
   TRIE POIDS (kg, tare)
====================== */
function calcTriePoids(){
  const nb = Math.max(1, Math.floor(num($("trieNb").value)));
  const brut = num($("trieBrut").value);
  const bac = $("trieBac").value; // ABJ or ASL
  const tare = (T[bac]||0) * nb;
  const net = Math.max(0, brut - tare);
  $("trieNet").textContent = r1(net);
}
["input","change"].forEach(ev=>{
  $("trieCat").addEventListener(ev, calcTriePoids);
  $("trieBac").addEventListener(ev, calcTriePoids);
  $("trieNb").addEventListener(ev, calcTriePoids);
  $("trieBrut").addEventListener(ev, calcTriePoids);
});

function getTriePoidsPending(){ try{ return JSON.parse(localStorage.getItem(TRIE_POIDS_PENDING_KEY)||"[]"); }catch{ return []; } }
function setTriePoidsPending(arr){
  localStorage.setItem(TRIE_POIDS_PENDING_KEY, JSON.stringify(arr));
  $("triePoidsPendingCount").textContent = String(arr.length);
}
function addTriePoidsPending(row){ const arr=getTriePoidsPending(); arr.unshift(row); setTriePoidsPending(arr); }
function removeTriePoidsPending(client_id){ setTriePoidsPending(getTriePoidsPending().filter(x=>x.client_id!==client_id)); }
function getTriePoidsCache(){ try{ return JSON.parse(localStorage.getItem(TRIE_POIDS_CACHE_KEY)||"[]"); }catch{ return []; } }
function setTriePoidsCache(rows, source){
  localStorage.setItem(TRIE_POIDS_CACHE_KEY, JSON.stringify(rows||[]));
  localStorage.setItem(TRIE_POIDS_META_KEY, JSON.stringify({updatedAt:Date.now(), source}));
}
function getTriePoidsMeta(){ try{ return JSON.parse(localStorage.getItem(TRIE_POIDS_META_KEY)||"null"); }catch{ return null; } }

async function saveTriePoids(){
  try{
    calcTriePoids();
    const cat = $("trieCat").value;
    const bac = $("trieBac").value;
    const nb = Math.max(1, Math.floor(num($("trieNb").value)));
    const brut = num($("trieBrut").value);
    const tare = (T[bac]||0)*nb;
    const net = Math.max(0, brut - tare);
    if(brut<=0) return alert("Entre un brut.");
    if(brut<tare) return alert("Brut < tare.");

    const { data: u } = await supabase.auth.getUser();
    const operateur = u?.user?.email || "";
    const client_id="tp_"+Date.now()+"_"+Math.random().toString(16).slice(2);

    if(!navigator.onLine) throw 1;

    const payload = { client_id, categorie: cat, bac_type: bac, nb, brut:r1(brut), tare:r1(tare), net:r1(net), operateur };
    const { error } = await supabase.from("trie_poids").upsert(payload, { onConflict:"client_id" });
    if(error) throw error;

    $("trieBrut").value = "";
    calcTriePoids();
    await loadTriePoidsData();
    loadTrieAll();
  }catch{
    const cat = $("trieCat").value;
    const bac = $("trieBac").value;
    const nb = Math.max(1, Math.floor(num($("trieNb").value)));
    const brut = num($("trieBrut").value);
    const tare = (T[bac]||0)*nb;
    const net = Math.max(0, brut - tare);
    const { data: u } = await supabase.auth.getUser();
    const operateur = u?.user?.email || "";
    const client_id="tp_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    addTriePoidsPending({ client_id, local_created_at: Date.now(), categorie:cat, bac_type:bac, nb, brut:r1(brut), tare:r1(tare), net:r1(net), operateur });
    $("trieBrut").value = "";
    calcTriePoids();
    loadTrieAll();
  }
}

async function syncTriePoidsPending(){
  const arr=getTriePoidsPending();
  $("triePoidsPendingCount").textContent = String(arr.length);
  if(!arr.length || !navigator.onLine) return;

  const { data: u } = await supabase.auth.getUser();
  if(!u?.user) return;

  const toSend=[...arr].reverse();
  for(const row of toSend){
    try{
      const payload = {
        client_id: row.client_id,
        categorie: row.categorie,
        bac_type: row.bac_type,
        nb: row.nb,
        brut: row.brut,
        tare: row.tare,
        net: row.net,
        operateur: row.operateur || (u.user.email||null)
      };
      const { error } = await supabase.from("trie_poids").upsert(payload, { onConflict:"client_id" });
      if(error) throw error;
      removeTriePoidsPending(row.client_id);
    }catch{ break; }
  }
  await loadTriePoidsData();
  loadTrieAll();
}

async function loadTriePoidsData(){
  try{
    const { data, error } = await supabase
      .from("trie_poids")
      .select("id, created_at, categorie, bac_type, nb, net, client_id, operateur")
      .order("created_at",{ ascending:false })
      .limit(5000);
    if(error) throw error;
    lastTriePoidsSource="LIVE";
    setTriePoidsCache(data||[], "LIVE");
  }catch{
    lastTriePoidsSource="CACHE";
  }
}

function buildTriePoidsMerged(){
  const pending=getTriePoidsPending().map(p=>({
    created_at:new Date(p.local_created_at).toISOString(),
    categorie:p.categorie,
    bac_type:p.bac_type,
    nb:p.nb,
    net:p.net,
    operateur:p.operateur||"",
    _source:"ATTENTE"
  }));
  const cached=getTriePoidsCache().map(r=>({ ...r, _source:(lastTriePoidsSource==="LIVE"?"LIVE":"CACHE") }));
  const all=[...pending,...cached].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  return all;
}

function renderTriePoidsTables(){
  const all = buildTriePoidsMerged();

  // Today totals
  const today = ymdLocalFromISO(new Date().toISOString());
  const totalsToday = {};
  all.forEach(r=>{
    if(ymdLocalFromISO(r.created_at)!==today) return;
    totalsToday[r.categorie]=(totalsToday[r.categorie]||0)+num(r.net);
  });
  $("triePoidsToday").innerHTML = Object.keys(totalsToday).length
    ? Object.keys(totalsToday).sort().map(k=>`<tr><td>${k}</td><td class="right"><b>${r1(totalsToday[k])}</b></td></tr>`).join("")
    : `<tr><td colspan="2" class="muted">Aucune donn√©e</td></tr>`;

  // History list (Trie page)
  $("triePoidsHist").innerHTML = all.length
    ? all.slice(0,400).map(r=>{
      return `<tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.categorie}</td>
        <td>${r.bac_type}</td>
        <td class="right">${r.nb}</td>
        <td class="right">${r1(r.net)}</td>
        <td>${r.operateur||""}</td>
        <td>${r._source}</td>
      </tr>`;
    }).join("")
    : `<tr><td colspan="7" class="muted">Aucune donn√©e</td></tr>`;

  // Historique page totals by day+category
  const totalsBy = {};
  all.forEach(r=>{
    const day=ymdLocalFromISO(r.created_at);
    const key=day+"|"+r.categorie;
    totalsBy[key]=(totalsBy[key]||0)+num(r.net);
  });
  const keys = Object.keys(totalsBy).sort((a,b)=>b.localeCompare(a));
  $("triePoidsTotalsHist").innerHTML = keys.length
    ? keys.map(k=>{
      const [day, cat]=k.split("|");
      return `<tr><td>${day}</td><td>${cat}</td><td class="right"><b>${r1(totalsBy[k])}</b></td></tr>`;
    }).join("")
    : `<tr><td colspan="3" class="muted">Aucune donn√©e</td></tr>`;

  $("triePoidsHistHist").innerHTML = all.length
    ? all.slice(0,500).map(r=>{
      return `<tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.categorie}</td>
        <td>${r.bac_type}</td>
        <td class="right">${r.nb}</td>
        <td class="right">${r1(r.net)}</td>
        <td>${r.operateur||""}</td>
        <td>${r._source}</td>
      </tr>`;
    }).join("")
    : `<tr><td colspan="7" class="muted">Aucune donn√©e</td></tr>`;
}

/* Render ALL */
function loadTrieAll(){
  $("pamTriePendingCount").textContent = String(getPamTriePending().length);
  $("aslTriePendingCount").textContent = String(getAslTriePending().length);
  $("triePoidsPendingCount").textContent = String(getTriePoidsPending().length);

  renderPamTrieTables("pamTrieTotals", "pamTrieHist");
  renderAslTrieTables("aslTrieTotals", "aslTrieHist");

  renderPamTrieTables("pamTrieTotalsHist", "pamTrieHistHist");
  renderAslTrieTables("aslTrieTotalsHist", "aslTrieHistHist");

  renderTriePoidsTables();
}

async function syncTrieAll(){
  await syncPamTriePending();
  await syncAslTriePending();
  await syncTriePoidsPending();
}

/* Init */
(async ()=>{
  refreshNetwork();

  setPending(getPending());
  renderPending();
  calc();
  calcTriePoids();

  // meta sources
  const meta = getHistoryMeta();
  lastHistorySource = meta?.source || "CACHE";
  setStoreBadge();

  const pmeta = getPamTrieMeta(); lastPamTrieSource = pmeta?.source || "CACHE";
  const ameta = getAslTrieMeta(); lastAslTrieSource = ameta?.source || "CACHE";
  const tpmeta = getTriePoidsMeta(); lastTriePoidsSource = tpmeta?.source || "CACHE";

  // offline counts
  setPamTriePending(getPamTriePending());
  setAslTriePending(getAslTriePending());
  setTriePoidsPending(getTriePoidsPending());

  // auto login if session
  const { data } = await supabase.auth.getUser();
  if(data?.user){
    currentUser = data.user;
    $("badgeUser").textContent = currentUser?.email ? ("Connect√© : " + currentUser.email) : "Connect√©";
    try { isAdminUser = await checkAdmin(); } catch { isAdminUser = false; }
    setAdminUI();

    $("loginScreen").style.display = "none";
    $("app").style.display = "block";

    await loadCities();
    await loadData();

    await loadPamTrieData();
    await loadAslTrieData();
    await loadTriePoidsData();
    loadTrieAll();

    syncPending();
    syncTrieAll();

    show("pesee");
  }else{
    // offline mode w/o login
    $("pendingCount").textContent = String(getPending().length);
    loadTrieAll();
  }
})();

/* Service worker */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/Pes-e/sw.js");
}
</script>

</body>
</html>

<!-- ==========================
SQL (Supabase) - √Ä COLLER DANS "SQL Editor"
==========================

-- 1) TABLES
create table if not exists public.villes (
  id bigserial primary key,
  nom text not null unique
);

create table if not exists public.pesees (
  id bigserial primary key,
  created_at timestamptz not null default now(),
  client_id text unique,
  ville text not null,
  type text not null,
  nb integer not null,
  brut numeric,
  tare numeric,
  net numeric not null,
  operateur text
);

create table if not exists public.pam_trie (
  id bigserial primary key,
  created_at timestamptz not null default now(),
  client_id text unique,
  delta integer not null,
  operateur text
);

create table if not exists public.asl_trie (
  id bigserial primary key,
  created_at timestamptz not null default now(),
  client_id text unique,
  delta integer not null,
  operateur text
);

create table if not exists public.trie_poids (
  id bigserial primary key,
  created_at timestamptz not null default now(),
  client_id text unique,
  categorie text not null,
  bac_type text not null,
  nb integer not null,
  brut numeric,
  tare numeric,
  net numeric not null,
  operateur text
);

-- index utiles
create index if not exists idx_pesees_created_at on public.pesees(created_at desc);
create index if not exists idx_trie_poids_created_at on public.trie_poids(created_at desc);

-- 2) ADMIN (liste emails)
create table if not exists public.admins (
  email text primary key
);

-- 3) RLS
alter table public.villes enable row level security;
alter table public.pesees enable row level security;
alter table public.pam_trie enable row level security;
alter table public.asl_trie enable row level security;
alter table public.trie_poids enable row level security;
alter table public.admins enable row level security;

-- 4) fonction is_admin()
create or replace function public.is_admin()
returns boolean
language sql
stable
as $$
  select exists(
    select 1 from public.admins a
    where lower(a.email) = lower(coalesce(auth.jwt() ->> 'email',''))
  );
$$;

-- 5) policies (lecture pour users connect√©s)
drop policy if exists "read villes" on public.villes;
create policy "read villes" on public.villes for select to authenticated using (true);

drop policy if exists "read pesees" on public.pesees;
create policy "read pesees" on public.pesees for select to authenticated using (true);

drop policy if exists "write pesees" on public.pesees;
create policy "write pesees" on public.pesees for insert to authenticated with check (true);

drop policy if exists "upsert pesees" on public.pesees;
create policy "upsert pesees" on public.pesees for update to authenticated using (true) with check (true);

-- trie +/- select/insert/update
drop policy if exists "read pam_trie" on public.pam_trie;
create policy "read pam_trie" on public.pam_trie for select to authenticated using (true);
drop policy if exists "write pam_trie" on public.pam_trie;
create policy "write pam_trie" on public.pam_trie for insert to authenticated with check (true);
drop policy if exists "update pam_trie" on public.pam_trie;
create policy "update pam_trie" on public.pam_trie for update to authenticated using (true) with check (true);

drop policy if exists "read asl_trie" on public.asl_trie;
create policy "read asl_trie" on public.asl_trie for select to authenticated using (true);
drop policy if exists "write asl_trie" on public.asl_trie;
create policy "write asl_trie" on public.asl_trie for insert to authenticated with check (true);
drop policy if exists "update asl_trie" on public.asl_trie;
create policy "update asl_trie" on public.asl_trie for update to authenticated using (true) with check (true);

-- trie poids select/insert/update
drop policy if exists "read trie_poids" on public.trie_poids;
create policy "read trie_poids" on public.trie_poids for select to authenticated using (true);
drop policy if exists "write trie_poids" on public.trie_poids;
create policy "write trie_poids" on public.trie_poids for insert to authenticated with check (true);
drop policy if exists "update trie_poids" on public.trie_poids;
create policy "update trie_poids" on public.trie_poids for update to authenticated using (true) with check (true);

-- admins table: lecture uniquement pour admin
drop policy if exists "read admins for admin" on public.admins;
create policy "read admins for admin" on public.admins for select to authenticated using (public.is_admin());

-- DELETE pes√©es uniquement admin
drop policy if exists "delete pesees admin" on public.pesees;
create policy "delete pesees admin" on public.pesees for delete to authenticated using (public.is_admin());

-- 6) RPC vider tout (admin only)
create or replace function public.admin_clear_all()
returns void
language plpgsql
security definer
as $$
begin
  if not public.is_admin() then
    raise exception 'not admin';
  end if;

  delete from public.pesees;
  delete from public.pam_trie;
  delete from public.asl_trie;
  delete from public.trie_poids;
end;
$$;

-->
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pes√©e</title>

<!-- PWA -->
<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0c10; --card:#12141b; --border:#222634; --ink:#e9eef6;
  --muted:#a8b3d6; --btn:#b22222; --btn2:#8b0000; --btnBorder:#7a1f1f;
  --ok:#1f6f3a; --warn:#7a1f1f; --cache:#3a4a7a;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px;color:#fff}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff}
button{padding:14px;border-radius:12px;border:1px solid var(--btnBorder);background:var(--btn);color:#fff;font-weight:800;cursor:pointer}
button:hover{filter:brightness(1.1)}
.smallBtn{padding:10px 12px;font-size:12px}
.danger{background:var(--btn2);border-color:#5c0000}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:820px){.col-4,.col-3,.col-2,.col-6{grid-column:span 12}}
.big{font-size:34px;font-weight:900;margin:8px 0}
.badge{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#fff}
.tableWrap{overflow:auto;border:1px solid var(--border);border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--border)}
th{font-size:12px;color:#fff;white-space:nowrap;text-align:left}
.right{text-align:right}
.center{min-height:90vh;display:flex;align-items:center;justify-content:center}
.max420{max-width:420px;width:100%}
#status{margin:10px 0;font-size:12px;white-space:pre-wrap;color:#ffd27a}
hr{border:0;border-top:1px solid var(--border);margin:14px 0}
.tag{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:#fff}
.tagOk{border-color:var(--ok)} .tagWait{border-color:var(--warn)} .tagCache{border-color:var(--cache)}
/* bandeau infos */
.banner{margin-top:8px;padding:10px;border-radius:10px;background:#1a1d27;border:1px solid var(--border);font-size:13px}
.banner.warn{background:#2a1d1d;border-color:#5a2d2d}
.banner .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.banner .chip{padding:6px 10px;border-radius:999px;background:#0d0f16;border:1px solid var(--border)}
/* Clean: pas de textes bleus r√©siduels */
label, th, .badge, .tag{color:#fff}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card max420">
    <h2 style="margin-top:0">Connexion</h2>

    <label>Email</label>
    <input id="email" type="email" autocomplete="username">

    <label>Mot de passe</label>
    <input id="password" type="password" autocomplete="current-password">

    <div style="margin-top:12px;display:grid;gap:10px">
      <button onclick="login()">SE CONNECTER</button>
      <button class="danger" onclick="resetAllCaches()">RESET CACHE (si √ßa bloque)</button>
    </div>

    <div id="loginMsg" style="margin-top:10px;font-size:12px;white-space:pre-wrap;color:#ffd27a"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <!-- Bandeau / Nav -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="smallBtn" onclick="show('pesee')">PES√âE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="show('trie')">TRIE</button>
        <button class="smallBtn" onclick="loadData()">üñ¥ Rafra√Æchir</button>
        <button class="smallBtn" onclick="syncAll()">‚ü≥ SYNC (<span id="pendingCount">0</span>)</button>
        <button class="smallBtn" onclick="logout()">üß± D√©connexion</button>
      </div>

      <div class="banner" id="topBanner">
        <div class="row">
          <span class="chip" id="badgeUser">Connect√© : ‚Äî</span>
          <span class="chip" id="badgeNet">R√©seau : ?</span>
          <span class="chip" id="badgeAdmin">Utilisateur</span>
          <span class="chip" id="badgeStore">Donn√©es : ?</span>
        </div>
        <div id="sdkWarn" style="margin-top:6px;color:#ffd27a;display:none">
          ‚ö†Ô∏è Supabase SDK non charg√© (bloqueur / DNS / cache). Essaie ‚ÄúRESET CACHE‚Äù.
        </div>
        <div id="liveWarn" class="banner warn" style="display:none;margin-top:8px">
          ‚ö†Ô∏è Supabase indisponible : affichage depuis le CACHE local.
        </div>
      </div>

      <div id="status">Pr√™t.</div>

      <!-- PAGE PES√âE -->
      <div id="pagePesee">
        <h2>Pes√©e</h2>

        <div class="grid">
          <div class="col-4">
            <label>Ville</label>
            <select id="ville"></select>
          </div>

          <div class="col-4">
            <label>Type</label>
            <select id="type">
              <option value="PAM">PAM</option>
              <option value="ASL">ASL</option>
              <option value="ABJ">ABJ</option>
              <option value="FRIGO">Frigo</option>
              <option value="HF">Hors froid</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nb bacs</label>
            <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>

          <div class="col-2">
            <label>Brut (kg)</label>
            <input id="brut" type="number" step="0.1" inputmode="decimal" placeholder="Ex: 120.5">
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="net">0</span> kg</div>
            <div style="color:#a8b3d6">Tares : PAM 59, ASL 45, ABJ 43, F 0, HF 0</div>
          </div>

          <div class="col-12">
            <button onclick="saveSafe()">ENREGISTRER</button>
          </div>
        </div>
      </div>

      <!-- PAGE HIST -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>

        <div class="grid">
          <div class="col-4">
            <label>Date</label>
            <input id="recapDate" type="date">
          </div>
          <div class="col-2" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
            <button class="smallBtn" onclick="recapToday()">Aujourd‚Äôhui</button>
            <button class="smallBtn" onclick="buildRecap()">Afficher</button>
          </div>
          <div class="col-6" style="display:flex;align-items:end;color:#a8b3d6">
            LIVE si possible sinon cache + en attente.
          </div>
        </div>

        <h4>Total (toutes villes)</h4>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th class="right">PAM</th><th class="right">ASL</th><th class="right">ABJ</th><th class="right">F</th><th class="right">HF</th><th class="right">TOTAL</th></tr>
            </thead>
            <tbody id="recapAll"></tbody>
          </table>
        </div>

        <h4 style="margin-top:14px">Par ville</h4>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th>Ville</th><th class="right">PAM</th><th class="right">ASL</th><th class="right">ABJ</th><th class="right">F</th><th class="right">HF</th><th class="right">TOTAL</th></tr>
            </thead>
            <tbody id="recapByCity"></tbody>
          </table>
        </div>

        <hr>

        <h3>En attente (hors-ligne)</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th>Date</th><th>Ville</th><th>Type</th><th class="right">Nb</th><th class="right">Net</th><th>Action</th></tr>
            </thead>
            <tbody id="pendingTable"></tbody>
          </table>
        </div>

        <hr>

        <h3>Historique (LIVE + CACHE + ATTENTE)</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Ville</th><th>Type</th><th class="right">Nb</th><th class="right">Net</th><th>Op√©rateur</th><th>Source</th>
                <th id="thAdmin" style="display:none">Admin</th>
              </tr>
            </thead>
            <tbody id="histMix"></tbody>
          </table>
        </div>

        <hr>

        <h2>Trie</h2>

        <h3>PAM tri√©</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="pamTrieTotalsHist"></tbody>
          </table>
        </div>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+ / -</th><th>Source</th></tr></thead>
            <tbody id="pamTrieHistHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>ASL tri√©</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="aslTrieTotalsHist"></tbody>
          </table>
        </div>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+ / -</th><th>Source</th></tr></thead>
            <tbody id="aslTrieHistHist"></tbody>
          </table>
        </div>
      </div>

      <!-- PAGE TRIE -->
      <div id="pageTrie" style="display:none">
        <h2>Trie</h2>

        <h3>Trie (PAM)</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button onclick="addPamTrie(+1)">+1 PAM tri√©</button>
          <button class="danger" onclick="addPamTrie(-1)">-1 PAM tri√©</button>
          <button class="smallBtn" onclick="syncPamTriePending()">‚ü≥ SYNC PAM (<span id="pamTriePendingCount">0</span>)</button>
          <button class="smallBtn" onclick="loadTrieAll()">üîÑ Rafra√Æchir</button>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="pamTrieTotals"></tbody>
          </table>
        </div>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+ / -</th><th>Source</th></tr></thead>
            <tbody id="pamTrieHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>Trie (ASL)</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button onclick="addAslTrie(+1)">+1 ASL tri√©</button>
          <button class="danger" onclick="addAslTrie(-1)">-1 ASL tri√©</button>
          <button class="smallBtn" onclick="syncAslTriePending()">‚ü≥ SYNC ASL (<span id="aslTriePendingCount">0</span>)</button>
          <button class="smallBtn" onclick="loadTrieAll()">üîÑ Rafra√Æchir</button>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="aslTrieTotals"></tbody>
          </table>
        </div>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+ / -</th><th>Source</th></tr></thead>
            <tbody id="aslTrieHist"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ========= CONFIG SUPABASE ========= */
const SUPABASE_URL = "https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";

/* ========= HELPERS ========= */
const $ = (id)=>document.getElementById(id);
const r1 = (x)=>Math.round(x*10)/10;
const num = (x)=>{ const v=Number(String(x).replace(",", ".")); return Number.isFinite(v)?v:0; };

function setStatus(msg){ const el=$("status"); if(el) el.textContent = msg || ""; }
function setLoginMsg(msg){ const el=$("loginMsg"); if(el) el.textContent = msg || ""; }
function refreshNetwork(){ $("badgeNet").textContent = "R√©seau : " + (navigator.onLine ? "OK" : "HORS-LIGNE"); }
function showLiveWarn(b){ $("liveWarn").style.display = b?"block":"none"; }

/* ‚úÖ si SDK non charg√© */
document.addEventListener("DOMContentLoaded", ()=>{ if(!window.supabase){ $("sdkWarn").style.display="block"; }});

/* ========= SUPABASE CLIENT (unique) ========= */
const sb = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);
if(!sb){ console.warn("Supabase client not created (SDK?)"); }
/* ====== App state ====== */
const T = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const A = { PAM:"PAM", ASL:"ASL", ABJ:"ABJ", FRIGO:"F", HF:"HF" };
const TYPES = ["PAM","ASL","ABJ","F","HF"];

const PENDING_KEY = "pesees_pending_v4";
const HISTORY_CACHE_KEY = "pesees_history_cache_v1";
const CACHE_META_KEY = "pesees_history_cache_meta_v1";

let currentUser = null;
let isAdminUser = false;
let lastHistorySource = "LIVE";

/* ===== UI / Admin ===== */
function setAdminUI(){
  $("badgeAdmin").textContent = isAdminUser ? "ADMIN" : "Utilisateur";
  $("thAdmin").style.display = isAdminUser ? "table-cell" : "none";
}
async function checkAdmin(){
  try{
    const { data, error } = await sb.rpc("is_admin");
    if(error) throw error;
    return !!data;
  }catch{ return false; }
}

/* ===== Pages ===== */
function show(p){
  $("pagePesee").style.display = (p==="pesee");
  $("pageHist").style.display  = (p==="hist");
  $("pageTrie").style.display  = (p==="trie");
  if(p==="hist"){
    if(!$("recapDate").value) $("recapDate").value = ymdToday();
    buildRecap();
    loadCities();
    loadData();
    renderPending();
    renderMixedHistory();
    loadTrieAll();
  }
  if(p==="trie"){ loadTrieAll(); }
}

/* ===== Calcul net ===== */
function calc(){
  const nb = Number($("nb").value);
  const brut = num($("brut").value);
  const tare = (T[$("type").value] || 0) * nb;
  const net = Math.max(0, brut - tare);
  $("net").textContent = r1(net);
}
["input","change"].forEach(ev=>{
  $("type").addEventListener(ev, calc);
  $("nb").addEventListener(ev, calc);
  $("brut").addEventListener(ev, calc);
});

/* ===== Pending (offline) ===== */
const getPending = ()=>{ try{return JSON.parse(localStorage.getItem(PENDING_KEY)||"[]");}catch{return[]} };
function setPending(arr){ localStorage.setItem(PENDING_KEY, JSON.stringify(arr)); $("pendingCount").textContent=String(arr.length); }
function addPending(row){ const arr=getPending(); arr.unshift(row); setPending(arr); }
function removePending(id){ setPending(getPending().filter(x=>x.client_id!==id)); }
function renderPending(){
  const arr=getPending(); $("pendingCount").textContent=String(arr.length);
  const tb=$("pendingTable"); tb.innerHTML="";
  if(!arr.length){ tb.innerHTML=`<tr><td colspan="6" style="color:#a8b3d6">Aucune ligne</td></tr>`; return; }
  arr.forEach(x=>{
    tb.innerHTML+=`<tr>
      <td>${new Date(x.local_created_at).toLocaleString()}</td>
      <td>${x.ville}</td>
      <td>${x.type}</td>
      <td class="right">${x.nb}</td>
      <td class="right">${x.net}</td>
      <td class="right"><button class="smallBtn danger" onclick="deletePending('${x.client_id}')">Suppr</button></td>
    </tr>`;
  });
}
function deletePending(id){ if(!confirm("Supprimer ?"))return; removePending(id); renderPending(); renderMixedHistory(); buildRecap(); }

/* ===== History cache ===== */
const getHistoryCache=()=>{ try{return JSON.parse(localStorage.getItem(HISTORY_CACHE_KEY)||"[]");}catch{return[]} };
function setHistoryCache(rows, source){ localStorage.setItem(HISTORY_CACHE_KEY, JSON.stringify(rows||[])); localStorage.setItem(CACHE_META_KEY, JSON.stringify({updatedAt:Date.now(),source:source||"LIVE"})); setStoreBadge(); }
const getHistoryMeta=()=>{ try{return JSON.parse(localStorage.getItem(CACHE_META_KEY)||"null");}catch{return null} };
function setStoreBadge(){
  const meta=getHistoryMeta();
  const info=meta?.updatedAt ? new Date(meta.updatedAt).toLocaleString() : "‚Äî";
  $("badgeStore").textContent = `Donn√©es : ${lastHistorySource} (${info})`;
}

/* ===== Mixed render (avec operator) ===== */
function renderMixedHistory(){
  const pending = getPending().map(p=>({
    id:null, created_at:new Date(p.local_created_at).toISOString(),
    ville:p.ville, type:p.type, nb:p.nb, net:p.net, operator:p.operator||"",
    _source:"ATTENTE", _client_id:p.client_id
  }));
  const cached = getHistoryCache().map(r=>({
    ...r, _source:(lastHistorySource==="LIVE"?"LIVE":"CACHE")
  }));
  const all=[...pending,...cached].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  const tb=$("histMix"); tb.innerHTML="";
  if(!all.length){ tb.innerHTML=`<tr><td colspan="${isAdminUser?8:7}" style="color:#a8b3d6">Aucune donn√©e</td></tr>`; return; }
  all.forEach(r=>{
    const tag = r._source==="ATTENTE"?`<span class="tag tagWait">ATTENTE</span>`:(lastHistorySource==="LIVE"?`<span class="tag tagOk">LIVE</span>`:`<span class="tag tagCache">CACHE</span>`);
    const admin = isAdminUser ? (r._source==="ATTENTE" ? `<td class="muted">‚Äî</td>` : `<td><button class="smallBtn danger" onclick="deleteRow(${r.id})">Suppr</button></td>`) : "";
    tb.innerHTML+=`<tr>
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.ville||""}</td>
      <td>${r.type||""}</td>
      <td class="right">${r.nb}</td>
      <td class="right">${r.net}</td>
      <td>${r.operator||""}</td>
      <td>${tag}</td>
      ${admin}
    </tr>`;
  });
}

/* ===== SYNC pending -> Supabase ===== */
async function syncPending(){
  const arr=getPending(); $("pendingCount").textContent=String(arr.length);
  if(!arr.length||!navigator.onLine) return;
  const { data:u } = await sb.auth.getUser(); if(!u?.user) return;
  const toSend=[...arr].reverse();
  for(const row of toSend){
    try{
      const payload={ client_id:row.client_id, ville:row.ville, type:row.type, nb:row.nb, brut:row.brut, tare:row.tare, net:row.net, operator:row.operator||u.user.email||null };
      const { error } = await sb.from("pesees").upsert(payload,{ onConflict:"client_id" });
      if(error) throw error;
      removePending(row.client_id);
    }catch(e){ setStatus("‚ùå SYNC: "+(e?.message||e)); break; }
  }
  await loadData(); await buildRecap(); renderMixedHistory();
}
async function syncAll(){ await syncPending(); await syncPamTriePending(); await syncAslTriePending(); }

/* ===== Auth ===== */
async function login(){
  try{
    setLoginMsg("Connexion‚Ä¶");
    const email=$("email").value.trim(); const password=$("password").value;
    if(!email||!password){ setLoginMsg("Email + mot de passe."); return; }
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) throw error;
    const { data } = await sb.auth.getUser();
    currentUser=data?.user||null;
    try{ isAdminUser=await checkAdmin(); }catch{ isAdminUser=false; }
    setAdminUI();
    $("badgeUser").textContent = currentUser?.email ? ("Connect√© : "+currentUser.email) : "Connect√©";
    $("loginScreen").style.display="none"; $("app").style.display="block";
    await loadCities(); await loadData(); $("recapDate").value=ymdToday(); await buildRecap();
    await loadPamTrieData(); await loadAslTrieData(); loadTrieAll();
    setLoginMsg(""); setStatus("‚úÖ Connect√©"); refreshNetwork(); syncAll(); show("pesee");
  }catch(e){ setLoginMsg("‚ùå "+(e?.message||String(e))); }
}
async function logout(){ try{ await sb.auth.signOut(); location.reload(); }catch(e){ setStatus("‚ùå "+(e?.message||e)); } }

/* ===== Villes ===== */
async function loadCities(){
  try{
    const { data, error } = await sb.from("villes").select("nom").order("nom",{ascending:true}).limit(500);
    if(error) throw error;
    const sel=$("ville"); sel.innerHTML="";
    (data||[]).forEach(v=>{ const o=document.createElement("option"); o.value=v.nom; o.textContent=v.nom; sel.appendChild(o); });
    if(!sel.options.length) sel.innerHTML="<option>‚Äî</option>";
  }catch(e){ setStatus("‚ùå VILLES: "+(e?.message||e)); }
}

/* ===== Save (avec operator) ===== */
async function saveSafe(){
  try{
    calc();
    const nb=Number($("nb").value); const brut=num($("brut").value);
    const tare=(T[$("type").value]||0)*nb; const net=Math.max(0, brut-tare);
    const ville=($("ville").value||"").trim(); const type=A[$("type").value];
    if(!ville||ville==="‚Äî") return alert("Choisis une ville.");
    if(brut<=0) return alert("Entre un poids brut."); if(brut<tare) return alert("Brut < tare.");
    const ok=confirm(`Confirmer ?\n\nVille: ${ville}\nType: ${type} | Nb: ${nb}\nBrut: ${r1(brut)} kg\nTare: ${r1(tare)} kg\nNET: ${r1(net)} kg`); if(!ok) return;

    const { data:u } = await sb.auth.getUser(); const operator=u?.user?.email||null;
    const client_id="p_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    const payload={ client_id, ville, type, nb, brut:r1(brut), tare:r1(tare), net:r1(net), operator };

    setStatus("Insertion‚Ä¶");
    const { error } = await sb.from("pesees").upsert(payload,{ onConflict:"client_id" });
    if(error) throw error;

    $("brut").value=""; calc(); setStatus("‚úÖ Enregistr√©");
    await loadData(); await buildRecap(); renderMixedHistory(); show("pesee");
  }catch(e){
    // offline/pb -> pending
    const nb=Number($("nb").value); const brut=num($("brut").value);
    const tare=(T[$("type").value]||0)*nb; const net=Math.max(0,brut-tare);
    const ville=($("ville").value||"").trim(); const type=A[$("type").value];
    const { data:u } = await sb.auth.getUser(); const operator=u?.user?.email||null;
    const client_id="p_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    addPending({ client_id, local_created_at:Date.now(), ville, type, nb, brut:r1(brut), tare:r1(tare), net:r1(net), operator });
    $("brut").value=""; calc();
    setStatus("‚ö†Ô∏è Hors-ligne / erreur : enregistr√© EN ATTENTE. Clique SYNC.");
    renderPending(); renderMixedHistory(); buildRecap(); show("pesee");
  }
}

/* ===== Load history (incl. operator) ===== */
async function loadData(){
  try{
    const { data, error } = await sb.from("pesees")
      .select("id, created_at, ville, type, nb, net, client_id, operator")
      .order("created_at",{ascending:false})
      .limit(1200);
    if(error) throw error;
    lastHistorySource="LIVE"; setHistoryCache(data||[],"LIVE"); showLiveWarn(false);
    renderMixedHistory();
  }catch(e){
    lastHistorySource="CACHE"; setStoreBadge(); showLiveWarn(true);
    setStatus("‚ö†Ô∏è Supabase indisponible : affichage depuis le CACHE local.");
    renderMixedHistory();
  }
}

/* ===== Admin delete ===== */
async function deleteRow(id){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("Supprimer cette ligne ?")) return;
  try{ const { error } = await sb.from("pesees").delete().eq("id",id); if(error) throw error;
    await loadData(); await buildRecap(); renderMixedHistory();
  }catch(e){ setStatus("‚ùå "+(e?.message||e)); }
}

/* ===== R√©cap ===== */
function ymdToday(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function recapToday(){ $("recapDate").value=ymdToday(); buildRecap(); }
function dayRangeLocal(ymd){ const [y,m,d]=ymd.split("-").map(Number); return { start:+new Date(y,m-1,d,0,0,0,0), end:+new Date(y,m-1,d+1,0,0,0,0) }; }
function inLocalDay(ts,start,end){ const t=typeof ts==="number"?ts:+new Date(ts); return (t>=start && t<end); }
function recapFromRows(rows, pendingRows){
  const totalAll={PAM:0,ASL:0,ABJ:0,F:0,HF:0}; const byCity={};
  const add=(ville,type,net)=>{ const t=String(type||"").toUpperCase(); if(!TYPES.includes(t)) return;
    const n=num(net); totalAll[t]+=n; const v=ville||"‚Äî"; if(!byCity[v]) byCity[v]={PAM:0,ASL:0,ABJ:0,F:0,HF:0}; byCity[v][t]+=n; };
  (rows||[]).forEach(r=>add(r.ville,r.type,r.net));
  (pendingRows||[]).forEach(p=>add(p.ville,p.type,p.net));
  return { totalAll, byCity };
}
function renderRecapTables(totalAll, byCity){
  const sumAll=TYPES.reduce((s,k)=>s+totalAll[k],0);
  $("recapAll").innerHTML=`<tr>
    <td class="right">${r1(totalAll.PAM)}</td>
    <td class="right">${r1(totalAll.ASL)}</td>
    <td class="right">${r1(totalAll.ABJ)}</td>
    <td class="right">${r1(totalAll.F)}</td>
    <td class="right">${r1(totalAll.HF)}</td>
    <td class="right"><b>${r1(sumAll)}</b></td></tr>`;
  const villes=Object.keys(byCity).sort((a,b)=>a.localeCompare(b,"fr"));
  $("recapByCity").innerHTML = villes.length ? villes.map(v=>{
    const o=byCity[v]; const sum=TYPES.reduce((s,k)=>s+o[k],0);
    return `<tr><td>${v}</td>
      <td class="right">${r1(o.PAM)}</td><td class="right">${r1(o.ASL)}</td>
      <td class="right">${r1(o.ABJ)}</td><td class="right">${r1(o.F)}</td>
      <td class="right">${r1(o.HF)}</td><td class="right"><b>${r1(sum)}</b></td></tr>`;
  }).join("") : `<tr><td colspan="7" style="color:#a8b3d6">Aucune donn√©e</td></tr>`;
}
async function buildRecap(){
  try{
    const date=$("recapDate").value||ymdToday(); $("recapDate").value=date;
    const [y,m,d]=date.split("-").map(Number); const s=new Date(y,m-1,d,0,0,0,0); const e=new Date(y,m-1,d+1,0,0,0,0);
    try{
      const { data, error } = await sb.from("pesees")
        .select("ville,type,net,created_at")
        .gte("created_at", s.toISOString()).lt("created_at", e.toISOString()).limit(5000);
      if(error) throw error;
      const { start,end }=dayRangeLocal(date);
      const pend=getPending().filter(p=>inLocalDay(p.local_created_at,start,end));
      const recap=recapFromRows(data||[], pend); renderRecapTables(recap.totalAll, recap.byCity);
    }catch{
      const { start,end }=dayRangeLocal(date);
      const cache=getHistoryCache().filter(r=>inLocalDay(r.created_at,start,end));
      const pend=getPending().filter(p=>inLocalDay(p.local_created_at,start,end));
      const recap=recapFromRows(cache, pend); renderRecapTables(recap.totalAll, recap.byCity);
    }
  }catch(e){
    $("recapAll").innerHTML=`<tr><td colspan="6">Erreur: ${(e?.message||e)}</td></tr>`;
    $("recapByCity").innerHTML="";
  }
}

/* ===== TRIE PAM & ASL ===== */
function ymdLocalFromISO(iso){ const d=new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }

/* PAM */
const PAM_TRIE_PENDING_KEY="pam_trie_pending_v1", PAM_TRIE_CACHE_KEY="pam_trie_cache_v1", PAM_TRIE_META_KEY="pam_trie_cache_meta_v1";
let lastPamTrieSource="LIVE";
const getPamTriePending=()=>{try{return JSON.parse(localStorage.getItem(PAM_TRIE_PENDING_KEY)||"[]")}catch{return[]}};
function setPamTriePending(a){localStorage.setItem(PAM_TRIE_PENDING_KEY,JSON.stringify(a));$("pamTriePendingCount").textContent=String(a.length)}
function addPamTriePending(r){const a=getPamTriePending();a.unshift(r);setPamTriePending(a)}
function removePamTriePending(id){setPamTriePending(getPamTriePending().filter(x=>x.client_id!==id))}
const getPamTrieCache=()=>{try{return JSON.parse(localStorage.getItem(PAM_TRIE_CACHE_KEY)||"[]")}catch{return[]}};
function setPamTrieCache(rows,source){localStorage.setItem(PAM_TRIE_CACHE_KEY,JSON.stringify(rows||[]));localStorage.setItem(PAM_TRIE_META_KEY,JSON.stringify({updatedAt:Date.now(),source:source||"LIVE"}))}
async function addPamTrie(delta){
  if(delta!==1&&delta!==-1) return;
  const client_id="t_pam_"+Date.now()+"_"+Math.random().toString(16).slice(2);
  try{
    const { data:u } = await sb.auth.getUser(); if(!u?.user) return alert("Connecte-toi."); if(!navigator.onLine) throw new Error("offline");
    const payload={ client_id, delta, user_email:u.user.email||null };
    const { error } = await sb.from("pam_trie").upsert(payload,{ onConflict:"client_id" }); if(error) throw error;
    await loadPamTrieData(); loadTrieAll();
  }catch{ addPamTriePending({ client_id, local_created_at:Date.now(), delta }); loadTrieAll(); }
}
async function syncPamTriePending(){
  const arr=getPamTriePending(); if(!arr.length||!navigator.onLine) return;
  const { data:u } = await sb.auth.getUser(); if(!u?.user) return;
  const toSend=[...arr].reverse();
  for(const row of toSend){
    try{ const payload={ client_id:row.client_id, delta:row.delta, user_email:u.user.email||null };
      const { error } = await sb.from("pam_trie").upsert(payload,{ onConflict:"client_id" }); if(error) throw error;
      removePamTriePending(row.client_id);
    }catch{ break; }
  }
  await loadPamTrieData(); loadTrieAll();
}
async function loadPamTrieData(){
  try{ const { data, error } = await sb.from("pam_trie").select("id,created_at,delta,client_id").order("created_at",{ascending:false}).limit(2000);
    if(error) throw error; lastPamTrieSource="LIVE"; setPamTrieCache(data||[],"LIVE");
  }catch{ lastPamTrieSource="CACHE"; }
}
function buildPamTrieMerged(){
  const pending=getPamTriePending().map(p=>({ created_at:new Date(p.local_created_at).toISOString(), delta:p.delta, _source:"ATTENTE" }));
  const cached=getPamTrieCache().map(r=>({ ...r, _source:(lastPamTrieSource==="LIVE"?"LIVE":"CACHE") }));
  const all=[...pending,...cached].sort((a,b)=>+new Date(b.created_at)-+new Date(a.created_at));
  const totals={}; for(const r of all){ const day=ymdLocalFromISO(r.created_at); totals[day]=(totals[day]||0)+(Number(r.delta)||0); }
  const totalsArr=Object.keys(totals).sort((a,b)=>b.localeCompare(a)).map(day=>({day,total:totals[day]}));
  return { all, totalsArr };
}
function renderPamTrieTables(totalsId,histId){
  const { all, totalsArr }=buildPamTrieMerged();
  $(totalsId).innerHTML = totalsArr.length ? totalsArr.map(r=>`<tr><td>${r.day}</td><td class="right"><b>${r.total}</b></td></tr>`).join("") : `<tr><td colspan="2" style="color:#a8b3d6">Aucune donn√©e</td></tr>`;
  $(histId).innerHTML = all.length ? all.slice(0,400).map(r=>{
    const dt=new Date(r.created_at).toLocaleString(); const v=(r.delta>0?("+"+r.delta):String(r.delta));
    return `<tr><td>${dt}</td><td class="right"><b>${v}</b></td><td>${r._source}</td></tr>`;
  }).join("") : `<tr><td colspan="3" style="color:#a8b3d6">Aucune donn√©e</td></tr>`;
}

/* ASL */
const ASL_TRIE_PENDING_KEY="asl_trie_pending_v1", ASL_TRIE_CACHE_KEY="asl_trie_cache_v1", ASL_TRIE_META_KEY="asl_trie_cache_meta_v1";
let lastAslTrieSource="LIVE";
const getAslTriePending=()=>{try{return JSON.parse(localStorage.getItem(ASL_TRIE_PENDING_KEY)||"[]")}catch{return[]}};
function setAslTriePending(a){localStorage.setItem(ASL_TRIE_PENDING_KEY,JSON.stringify(a));$("aslTriePendingCount").textContent=String(a.length)}
function addAslTriePending(r){const a=getAslTriePending();a.unshift(r);setAslTriePending(a)}
function removeAslTriePending(id){setAslTriePending(getAslTriePending().filter(x=>x.client_id!==id))}
const getAslTrieCache=()=>{try{return JSON.parse(localStorage.getItem(ASL_TRIE_CACHE_KEY)||"[]")}catch{return[]}};
function setAslTrieCache(rows,source){localStorage.setItem(ASL_TRIE_CACHE_KEY,JSON.stringify(rows||[]));localStorage.setItem(ASL_TRIE_META_KEY,JSON.stringify({updatedAt:Date.now(),source:source||"LIVE"}))}
async function addAslTrie(delta){
  if(delta!==1&&delta!==-1) return;
  const client_id="t_asl_"+Date.now()+"_"+Math.random().toString(16).slice(2);
  try{
    const { data:u } = await sb.auth.getUser(); if(!u?.user) return alert("Connecte-toi."); if(!navigator.onLine) throw new Error("offline");
    const payload={ client_id, delta, user_email:u.user.email||null };
    const { error } = await sb.from("asl_trie").upsert(payload,{ onConflict:"client_id" }); if(error) throw error;
    await loadAslTrieData(); loadTrieAll();
  }catch{ addAslTriePending({ client_id, local_created_at:Date.now(), delta }); loadTrieAll(); }
}
async function syncAslTriePending(){
  const arr=getAslTriePending(); if(!arr.length||!navigator.onLine) return;
  const { data:u } = await sb.auth.getUser(); if(!u?.user) return;
  const toSend=[...arr].reverse();
  for(const row of toSend){
    try{ const payload={ client_id:row.client_id, delta:row.delta, user_email:u.user.email||null };
      const { error } = await sb.from("asl_trie").upsert(payload,{ onConflict:"client_id" }); if(error) throw error;
      removeAslTriePending(row.client_id);
    }catch{ break; }
  }
  await loadAslTrieData(); loadTrieAll();
}
async function loadAslTrieData(){
  try{ const { data, error } = await sb.from("asl_trie").select("id,created_at,delta,client_id").order("created_at",{ascending:false}).limit(2000);
    if(error) throw error; lastAslTrieSource="LIVE"; setAslTrieCache(data||[],"LIVE");
  }catch{ lastAslTrieSource="CACHE"; }
}
function buildAslTrieMerged(){
  const pending=getAslTriePending().map(p=>({ created_at:new Date(p.local_created_at).toISOString(), delta:p.delta, _source:"ATTENTE" }));
  const cached=getAslTrieCache().map(r=>({ ...r, _source:(lastAslTrieSource==="LIVE"?"LIVE":"CACHE") }));
  const all=[...pending,...cached].sort((a,b)=>+new Date(b.created_at)-+new Date(a.created_at));
  const totals={}; for(const r of all){ const day=ymdLocalFromISO(r.created_at); totals[day]=(totals[day]||0)+(Number(r.delta)||0); }
  const totalsArr=Object.keys(totals).sort((a,b)=>b.localeCompare(a)).map(day=>({day,total:totals[day]}));
  return { all, totalsArr };
}
function renderAslTrieTables(totalsId,histId){
  const { all, totalsArr }=buildAslTrieMerged();
  $(totalsId).innerHTML = totalsArr.length ? totalsArr.map(r=>`<tr><td>${r.day}</td><td class="right"><b>${r.total}</b></td></tr>`).join("") : `<tr><td colspan="2" style="color:#a8b3d6">Aucune donn√©e</td></tr>`;
  $(histId).innerHTML = all.length ? all.slice(0,400).map(r=>{
    const dt=new Date(r.created_at).toLocaleString(); const v=(r.delta>0?("+"+r.delta):String(r.delta));
    return `<tr><td>${dt}</td><td class="right"><b>${v}</b></td><td>${r._source}</td></tr>`;
  }).join("") : `<tr><td colspan="3" style="color:#a8b3d6">Aucune donn√©e</td></tr>`;
}

/* ===== Render all Trie ===== */
function loadTrieAll(){
  // pending counters
  $("pamTriePendingCount").textContent=String(getPamTriePending().length);
  $("aslTriePendingCount").textContent=String(getAslTriePending().length);
  // TRIE page
  renderPamTrieTables("pamTrieTotals","pamTrieHist");
  renderAslTrieTables("aslTrieTotals","aslTrieHist");
  // HIST page
  renderPamTrieTables("pamTrieTotalsHist","pamTrieHistHist");
  renderAslTrieTables("aslTrieTotalsHist","aslTrieHistHist");
}

/* ===== Reset cache rapide ===== */
function resetAllCaches(){
  localStorage.clear();
  caches?.keys?.().then(keys=>keys.forEach(k=>caches.delete(k)));
  location.reload();
}

/* ===== Init ===== */
(async ()=>{
  refreshNetwork();
  setPending(getPending());
  renderPending();
  calc();

  const meta=getHistoryMeta(); lastHistorySource=meta?.source||"CACHE"; setStoreBadge();

  const { data } = await sb.auth.getUser();
  if(data?.user){
    currentUser=data.user; $("badgeUser").textContent="Connect√© : "+(currentUser.email||"");
    try{ isAdminUser=await checkAdmin(); }catch{ isAdminUser=false; } setAdminUI();

    $("loginScreen").style.display="none"; $("app").style.display="block";
    await loadCities(); await loadData(); $("recapDate").value=ymdToday(); await buildRecap();
    await loadPamTrieData(); await loadAslTrieData(); loadTrieAll();
    show("pesee");
  }else{
    $("pendingCount").textContent=String(getPending().length);
    loadTrieAll();
  }

  window.addEventListener("online", ()=>{ refreshNetwork(); syncAll(); });
  window.addEventListener("offline", refreshNetwork);
})();

<!-- Service worker -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/Pes-e/sw.js");
}
</script>

</body>
</html>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/Pes-e/sw.js");
}
</script>
</body>
</html>

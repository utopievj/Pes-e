<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pesée</title>

<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* === UI PRO ULTRA CLEAN === */
body{margin:0;font-family:system-ui;background:#0b0c10;color:#fff}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{background:#12141b;border-radius:16px;padding:16px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-2{grid-column:span 2}
@media(max-width:820px){.col-6,.col-4,.col-2{grid-column:span 12}}

h2{margin:0 0 12px 0}
label{display:block;font-size:14px;margin:8px 0 4px}

input,select{
  width:100%;
  padding:14px;
  font-size:18px;
  border-radius:12px;
  border:1px solid #333;
  background:#0f1118;
  color:#fff;
  box-sizing:border-box;
}

button{
  width:100%;
  padding:16px;
  font-size:18px;
  font-weight:800;
  border-radius:14px;
  border:none;
  background:#b22222;
  color:#fff;
}
button:hover{background:#d32f2f}

.rowBtns{display:flex;gap:8px;flex-wrap:wrap}
.smallBtn{width:auto;padding:10px 14px;font-size:14px;border-radius:12px}
.danger{background:#8b0000}

.big{font-size:48px;font-weight:900;margin:10px 0}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #222;text-align:left;white-space:nowrap}
th{font-size:14px}
.right{text-align:right}
.hidden{display:none}

#loginMsg{margin-top:10px;font-size:14px;color:#ffd27a;white-space:pre-wrap}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="wrap">
  <div class="card">
    <h2>Connexion</h2>

    <label>Email</label>
    <input id="email" type="email" autocomplete="username" placeholder="email">

    <label>Mot de passe</label>
    <input id="password" type="password" autocomplete="current-password" placeholder="mot de passe">

    <div style="height:12px"></div>
    <button onclick="login()">SE CONNECTER</button>

    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap hidden">
  <div class="card">

    <div class="rowBtns" style="margin-bottom:12px">
      <button class="smallBtn" onclick="show('pesee')">PESÉE</button>
      <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
      <button class="smallBtn" onclick="syncPending()">SYNC (<span id="pendingCount">0</span>)</button>
      <button class="smallBtn danger" onclick="logout()">X</button>
    </div>

    <!-- PESÉE -->
    <div id="pagePesee">
      <div class="grid">
        <div class="col-4">
          <label>Ville</label>
          <select id="ville"></select>
        </div>

        <div class="col-4">
          <label>Type</label>
          <select id="type">
            <option value="PAM">PAM</option>
            <option value="ASL">ASL</option>
            <option value="ABJ">ABJ</option>
            <option value="FRIGO">F</option>
            <option value="HF">HF</option>
          </select>
        </div>

        <div class="col-2">
          <label>Nb</label>
          <select id="nb">
            <option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </div>

        <div class="col-2">
          <label>Brut (kg)</label>
          <input id="brut" type="number" step="0.1" inputmode="decimal" placeholder="0">
        </div>

        <div class="col-12">
          <div class="big">NET : <span id="net">0</span> kg</div>
        </div>

        <div class="col-12">
          <button onclick="saveSafe()">VALIDER</button>
        </div>
      </div>
    </div>

    <!-- HISTORIQUE -->
    <div id="pageHist" class="hidden">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Ville</th>
            <th>Type</th>
            <th class="right">Net</th>
          </tr>
        </thead>
        <tbody id="hist"></tbody>
      </table>
    </div>

  </div>
</div>

<script>
/* === SUPABASE (URL + KEY OK) === */
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0"
);

const $ = id => document.getElementById(id);
const PENDING_KEY = "pending_pesees_v1";

const TARE = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const MAP  = { FRIGO:"F", HF:"HF" };

function show(p){
  $("pagePesee").classList.toggle("hidden", p!=="pesee");
  $("pageHist").classList.toggle("hidden", p!=="hist");
  if(p==="hist") loadData();
}

function getPending(){ try{return JSON.parse(localStorage.getItem(PENDING_KEY)||"[]")}catch{return[]} }
function setPending(arr){ localStorage.setItem(PENDING_KEY, JSON.stringify(arr)); $("pendingCount").textContent = String(arr.length); }

function calc(){
  const nb = Number($("nb").value);
  const brut = Number(String($("brut").value).replace(",", "."));
  const tare = (TARE[$("type").value] || 0) * nb;
  const net = Math.max(0, (Number.isFinite(brut)?brut:0) - tare);
  $("net").textContent = (Math.round(net*10)/10).toFixed(1);
}

["change","input"].forEach(e=>{
  $("type").addEventListener(e, calc);
  $("nb").addEventListener(e, calc);
  $("brut").addEventListener(e, calc);
});

async function saveSafe(){
  calc();
  const nb = Number($("nb").value);
  const brut = Number(String($("brut").value).replace(",", "."));
  if(!Number.isFinite(brut) || brut<=0) return;

  const typeKey = $("type").value;
  const tare = (TARE[typeKey] || 0) * nb;
  const net = Math.max(0, brut - tare);

  const payload = {
    client_id: "p_" + Date.now() + "_" + Math.random().toString(16).slice(2),
    ville: $("ville").value,
    type: MAP[typeKey] || typeKey,
    nb,
    brut: Math.round(brut*10)/10,
    tare: Math.round(tare*10)/10,
    net: Math.round(net*10)/10
  };

  try{
    const { error } = await supabase
      .from("pesees")
      .upsert(payload, { onConflict: "client_id" });
    if(error) throw error;
  }catch{
    const p = getPending();
    p.push(payload);
    setPending(p);
  }

  $("brut").value = "";
  calc();
}

async function syncPending(){
  const p = getPending();
  if(!p.length) return;

  for(const row of p){
    const { error } = await supabase
      .from("pesees")
      .upsert(row, { onConflict: "client_id" });
    if(error) return; // on stoppe si erreur
  }
  setPending([]);
}

async function loadData(){
  const { data, error } = await supabase
    .from("pesees")
    .select("created_at, ville, type, net")
    .order("created_at", { ascending:false })
    .limit(300);

  if(error){
    $("hist").innerHTML = "";
    return;
  }

  $("hist").innerHTML = (data||[]).map(r => `
    <tr>
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.ville}</td>
      <td>${r.type}</td>
      <td class="right">${r.net}</td>
    </tr>
  `).join("");
}

async function loadCities(){
  const { data, error } = await supabase
    .from("villes")
    .select("nom")
    .order("nom", { ascending:true })
    .limit(500);

  if(error){
    $("ville").innerHTML = "<option>—</option>";
    return;
  }
  $("ville").innerHTML = (data||[]).map(v => `<option>${v.nom}</option>`).join("");
}

async function login(){
  const msg = $("loginMsg");
  msg.textContent = "Connexion…";

  const { error } = await supabase.auth.signInWithPassword({
    email: $("email").value.trim(),
    password: $("password").value
  });

  if(error){
    msg.textContent = "❌ " + error.message;
    return;
  }

  msg.textContent = "";
  $("loginScreen").classList.add("hidden");
  $("app").classList.remove("hidden");
  await loadCities();
  show("pesee");
  await syncPending();
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

(async()=>{
  setPending(getPending());
  calc();

  const { data } = await supabase.auth.getUser();
  if(data?.user){
    $("loginScreen").classList.add("hidden");
    $("app").classList.remove("hidden");
    await loadCities();
    show("pesee");
    await syncPending();
  }
})();
</script>
</body>
</html>
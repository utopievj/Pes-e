<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pes√©e</title>

<!-- PWA -->
<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px;color:#a8b3d6}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
.smallBtn{padding:10px 12px;font-size:12px}
.danger{background:#8b0000;border-color:#5c0000}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:820px){.col-4,.col-3,.col-2,.col-6{grid-column:span 12}}
.big{font-size:34px;font-weight:900;margin:8px 0}
.badge{display:inline-block;padding:4px 10px;border:1px solid #222634;border-radius:999px;font-size:12px;color:#a8b3d6}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
th{font-size:12px;color:#a8b3d6;white-space:nowrap;text-align:left}
.right{text-align:right}
.center{min-height:90vh;display:flex;align-items:center;justify-content:center}
.max420{max-width:420px;width:100%}
#status{margin:10px 0;font-size:12px;white-space:pre-wrap;color:#ffd27a}
.muted{color:#a8b3d6;font-size:12px}
hr{border:0;border-top:1px solid #222634;margin:14px 0}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card max420">
    <h2 style="margin-top:0">Connexion</h2>
    <p class="muted">Email + mot de passe (Supabase)</p>

    <label>Email</label>
    <input id="email" type="email" autocomplete="username">

    <label>Mot de passe</label>
    <input id="password" type="password" autocomplete="current-password">

    <div style="margin-top:12px;display:grid;gap:10px">
      <button onclick="login()">SE CONNECTER</button>
    </div>

    <div id="loginMsg" style="margin-top:10px;font-size:12px;white-space:pre-wrap;color:#ffd27a"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="smallBtn" onclick="show('pesee')">PES√âE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="loadData()">üîÑ Rafra√Æchir</button>
        <button class="smallBtn" onclick="logout()">üö™ D√©connexion</button>
        <span class="badge" id="badgeUser">Connect√©</span>
        <span class="badge" id="badgeNet">R√©seau : ?</span>
        <span class="badge" id="badgeAdmin">Utilisateur</span>
      </div>

      <div id="status">Pr√™t.</div>

      <!-- PAGE PES√âE -->
      <div id="pagePesee">
        <h2>Pes√©e</h2>

        <div class="grid">
          <div class="col-4">
            <label>Ville</label>
            <select id="ville"></select>
          </div>

          <div class="col-4">
            <label>Type</label>
            <select id="type">
              <option value="PAM">PAM</option>
              <option value="ASL">ASL</option>
              <option value="ABJ">ABJ</option>
              <option value="FRIGO">Frigo</option>
              <option value="HF">Hors froid</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nb</label>
            <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>

          <div class="col-2">
            <label>Brut (kg)</label>
            <input id="brut" type="number" step="0.1" placeholder="Ex: 120.5">
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="net">0</span> kg</div>
            <div class="muted">Tare : PAM 59, ASL 45, ABJ 43, F 0, HF 0</div>
          </div>

          <div class="col-12">
            <button onclick="saveSafe()">ENREGISTRER</button>
          </div>
        </div>
      </div>

      <!-- PAGE HIST -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" style="display:none">
          <hr>
          <h3>Admin ‚Äì Villes</h3>

          <div class="grid">
            <div class="col-6">
              <label>Ajouter une ville</label>
              <input id="newCity" type="text" placeholder="Ex: Toulouse">
            </div>
            <div class="col-6" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
              <button class="smallBtn" onclick="addCity()">‚ûï Ajouter</button>
              <button class="smallBtn" onclick="loadCities()">üîÑ Recharger</button>
            </div>
            <div class="col-12">
              <div class="tableWrap">
                <table>
                  <thead><tr><th>Ville</th><th class="right">Action</th></tr></thead>
                  <tbody id="citiesAdmin"></tbody>
                </table>
              </div>
            </div>
          </div>

          <hr>
          <h3>Admin ‚Äì Historique</h3>
          <button class="smallBtn danger" onclick="clearAll()">üßπ Vider tout l‚Äôhistorique</button>
          <p class="muted">‚ö†Ô∏è Action irr√©versible.</p>
        </div>

        <hr>

        <!-- R√©cap -->
        <h3>R√©cap du jour</h3>
        <div class="grid">
          <div class="col-4">
            <label>Date</label>
            <input id="recapDate" type="date">
          </div>
          <div class="col-2" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
            <button class="smallBtn" onclick="recapToday()">Aujourd‚Äôhui</button>
            <button class="smallBtn" onclick="buildRecap()">Afficher</button>
          </div>
          <div class="col-6" style="display:flex;align-items:end">
            <div class="muted">Totaux Net (kg) par type et par ville.</div>
          </div>
        </div>

        <h4>Total (toutes villes)</h4>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th class="right">PAM</th><th class="right">ASL</th><th class="right">ABJ</th><th class="right">F</th><th class="right">HF</th><th class="right">TOTAL</th></tr>
            </thead>
            <tbody id="recapAll"></tbody>
          </table>
        </div>

        <h4 style="margin-top:14px">Par ville</h4>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th>Ville</th><th class="right">PAM</th><th class="right">ASL</th><th class="right">ABJ</th><th class="right">F</th><th class="right">HF</th><th class="right">TOTAL</th></tr>
            </thead>
            <tbody id="recapByCity"></tbody>
          </table>
        </div>

        <hr>

        <!-- Liste -->
        <h3>Liste des pes√©es</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Ville</th><th>Type</th><th class="right">Nb</th><th class="right">Net</th>
                <th id="thAdmin" style="display:none">Admin</th>
              </tr>
            </thead>
            <tbody id="hist"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ‚úÖ SUPABASE */
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0"
);

/* TARES + TYPES */
const T = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const A = { PAM:"PAM", ASL:"ASL", ABJ:"ABJ", FRIGO:"F", HF:"HF" };
const TYPES = ["PAM","ASL","ABJ","F","HF"];

const $ = (id)=>document.getElementById(id);
const r1 = (x)=>Math.round(x*10)/10;
const num = (x)=>{ const v=Number(String(x).replace(",", ".")); return Number.isFinite(v)?v:0; };

let currentUser = null;
let isAdminUser = false;

/* UI */
function setStatus(msg){ $("status").textContent = msg || ""; }
function setLoginMsg(msg){ $("loginMsg").textContent = msg || ""; }
function refreshNetwork(){
  $("badgeNet").textContent = "R√©seau : " + (navigator.onLine ? "OK" : "HORS-LIGNE");
}
window.addEventListener("online", refreshNetwork);
window.addEventListener("offline", refreshNetwork);

function setAdminUI(){
  $("badgeAdmin").textContent = isAdminUser ? "ADMIN" : "Utilisateur";
  $("adminPanel").style.display = isAdminUser ? "block" : "none";
  $("thAdmin").style.display = isAdminUser ? "table-cell" : "none";
}

/* Admin check c√¥t√© Supabase */
async function checkAdmin(){
  const { data, error } = await supabase.rpc("is_admin");
  if(error) throw error;
  return !!data;
}

/* Pages */
function show(p){
  $("pagePesee").style.display = (p==="pesee") ? "block" : "none";
  $("pageHist").style.display  = (p==="hist")  ? "block" : "none";
  if(p==="hist"){
    if(!$("recapDate").value) $("recapDate").value = ymdToday();
    buildRecap();
    loadCities();
    loadData();
  }
}

/* Calcul net */
function calc(){
  const nb = Number($("nb").value);
  const brut = num($("brut").value);
  const tare = (T[$("type").value] || 0) * nb;
  const net = Math.max(0, brut - tare);
  $("net").textContent = r1(net);
}
["input","change"].forEach(ev=>{
  $("type").addEventListener(ev, calc);
  $("nb").addEventListener(ev, calc);
  $("brut").addEventListener(ev, calc);
});

/* Login / logout */
async function login(){
  try{
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password) return setLoginMsg("Email + mot de passe.");

    setLoginMsg("Connexion‚Ä¶");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;

    const { data } = await supabase.auth.getUser();
    currentUser = data?.user || null;

    isAdminUser = await checkAdmin();
    setAdminUI();

    $("badgeUser").textContent = currentUser?.email ? ("Connect√© : " + currentUser.email) : "Connect√©";
    $("loginScreen").style.display = "none";
    $("app").style.display = "block";

    await loadCities();
    await loadData();

    if(!$("recapDate").value) $("recapDate").value = ymdToday();
    show("pesee");
    setLoginMsg("");
    setStatus("‚úÖ Connect√©");
  }catch(e){
    setLoginMsg("‚ùå " + (e?.message || String(e)));
  }
}

async function logout(){
  try{
    setStatus("D√©connexion‚Ä¶");
    await supabase.auth.signOut();
    location.reload();
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

/* Villes */
async function loadCities(){
  try{
    const { data, error } = await supabase.from("villes").select("id, nom").order("nom", { ascending:true }).limit(500);
    if(error) throw error;

    // select
    const sel = $("ville");
    sel.innerHTML = "";
    (data||[]).forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v.nom;
      opt.textContent = v.nom;
      sel.appendChild(opt);
    });
    if(!sel.options.length) sel.innerHTML = "<option>‚Äî</option>";

    // admin list
    const tb = $("citiesAdmin");
    tb.innerHTML = "";
    if(!isAdminUser){
      tb.innerHTML = `<tr><td colspan="2" class="muted">Admin uniquement</td></tr>`;
      return;
    }
    (data||[]).forEach(v=>{
      tb.innerHTML += `
        <tr>
          <td>${v.nom}</td>
          <td class="right">
            <button class="smallBtn danger" onclick="deleteCity(${v.id}, '${String(v.nom).replace(/'/g,"&#39;")}')">Suppr</button>
          </td>
        </tr>`;
    });
    if(!(data||[]).length) tb.innerHTML = `<tr><td colspan="2" class="muted">Aucune ville</td></tr>`;
  }catch(e){
    setStatus("‚ùå VILLES: " + (e?.message || String(e)));
  }
}

async function addCity(){
  if(!isAdminUser) return alert("Admin uniquement");
  const name = ($("newCity").value || "").trim();
  if(!name) return alert("Entre un nom de ville.");
  try{
    setStatus("Ajout ville‚Ä¶");
    const { error } = await supabase.from("villes").insert({ nom: name });
    if(error) throw error;
    $("newCity").value = "";
    setStatus("‚úÖ Ville ajout√©e");
    await loadCities();
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

async function deleteCity(id, nom){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("Supprimer la ville : " + nom + " ?")) return;
  try{
    setStatus("Suppression ville‚Ä¶");
    const { error } = await supabase.from("villes").delete().eq("id", id);
    if(error) throw error;
    setStatus("‚úÖ Ville supprim√©e");
    await loadCities();
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

/* Enregistrer (‚úÖ reste sur PES√âE, ne va pas dans l'historique) */
async function saveSafe(){
  try{
    calc();
    const nb = Number($("nb").value);
    const brut = num($("brut").value);
    const tare = (T[$("type").value] || 0) * nb;
    const net = Math.max(0, brut - tare);
    const ville = ($("ville").value || "").trim();
    const type = A[$("type").value];

    if(!ville || ville==="‚Äî") return alert("Choisis une ville.");
    if(brut<=0) return alert("Entre un poids brut.");
    if(brut<tare) return alert("Brut inf√©rieur √† la tare.");

    const ok = confirm(
      "Confirmer ?\n\n" +
      "Ville: " + ville + "\n" +
      "Type: " + type + " | Nb: " + nb + "\n" +
      "Brut: " + r1(brut) + " kg\n" +
      "Tare: " + r1(tare) + " kg\n" +
      "NET:  " + r1(net) + " kg"
    );
    if(!ok) return;

    setStatus("Insertion‚Ä¶");
    const { error } = await supabase.from("pesees").insert({
      ville, type, nb,
      brut: r1(brut),
      tare: r1(tare),
      net: r1(net)
    });
    if(error) throw error;

    $("brut").value = "";
    calc();

    setStatus("‚úÖ Enregistr√©");
    await loadData();      // garde l'historique √† jour
    await buildRecap();    // met √† jour le r√©cap du jour si besoin
    show("pesee");         // ‚úÖ reste sur la page pes√©e
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

/* Historique */
async function loadData(){
  try{
    const { data, error } = await supabase
      .from("pesees")
      .select("id, created_at, ville, type, nb, net")
      .order("created_at", { ascending:false })
      .limit(500);
    if(error) throw error;

    const tb = $("hist");
    tb.innerHTML = "";
    const colspan = isAdminUser ? 6 : 5;

    if(!data || !data.length){
      tb.innerHTML = `<tr><td colspan="${colspan}" class="muted">Aucune donn√©e</td></tr>`;
      return;
    }

    data.forEach(r=>{
      tb.innerHTML += `
        <tr>
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${r.ville}</td>
          <td>${r.type}</td>
          <td class="right">${r.nb}</td>
          <td class="right">${r.net}</td>
          ${isAdminUser ? `<td><button class="smallBtn danger" onclick="deleteRow(${r.id})">Suppr</button></td>` : ``}
        </tr>`;
    });
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

async function deleteRow(id){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("Supprimer cette ligne ?")) return;
  try{
    setStatus("Suppression‚Ä¶");
    const { error } = await supabase.from("pesees").delete().eq("id", id);
    if(error) throw error;
    setStatus("‚úÖ Supprim√©");
    await loadData();
    await buildRecap();
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

async function clearAll(){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("‚ö†Ô∏è Vider TOUT l‚Äôhistorique ?")) return;
  try{
    setStatus("Suppression totale‚Ä¶");
    const { error } = await supabase.from("pesees").delete().gte("id", 0);
    if(error) throw error;
    setStatus("‚úÖ Historique vid√©");
    await loadData();
    await buildRecap();
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

/* --- R√âCAP JOUR / VILLE / TYPE --- */
function ymdToday(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function recapToday(){
  $("recapDate").value = ymdToday();
  buildRecap();
}
function dayRangeISO(ymd){
  const [y,m,d]=ymd.split("-").map(Number);
  const start=new Date(y,m-1,d,0,0,0,0);
  const end=new Date(y,m-1,d+1,0,0,0,0);
  return { startISO:start.toISOString(), endISO:end.toISOString() };
}

async function buildRecap(){
  try{
    if(!$("recapDate")) return; // si pas sur la page hist
    const date = $("recapDate").value || ymdToday();
    $("recapDate").value = date;
    const { startISO, endISO } = dayRangeISO(date);

    const { data, error } = await supabase
      .from("pesees")
      .select("ville,type,net,created_at")
      .gte("created_at", startISO)
      .lt("created_at", endISO)
      .limit(4000);

    if(error) throw error;

    const totalAll = {PAM:0,ASL:0,ABJ:0,F:0,HF:0};
    const byCity = {};

    (data||[]).forEach(r=>{
      const t = String(r.type||"").toUpperCase();
      if(!TYPES.includes(t)) return;
      const net = num(r.net);
      totalAll[t]+=net;

      const v = r.ville || "‚Äî";
      if(!byCity[v]) byCity[v]={PAM:0,ASL:0,ABJ:0,F:0,HF:0};
      byCity[v][t]+=net;
    });

    const sumAll = TYPES.reduce((s,k)=>s+totalAll[k],0);
    $("recapAll").innerHTML = `
      <tr>
        <td class="right">${r1(totalAll.PAM)}</td>
        <td class="right">${r1(totalAll.ASL)}</td>
        <td class="right">${r1(totalAll.ABJ)}</td>
        <td class="right">${r1(totalAll.F)}</td>
        <td class="right">${r1(totalAll.HF)}</td>
        <td class="right"><b>${r1(sumAll)}</b></td>
      </tr>`;

    const villes = Object.keys(byCity).sort((a,b)=>a.localeCompare(b,"fr"));
    if(!villes.length){
      $("recapByCity").innerHTML = `<tr><td colspan="7" class="muted">Aucune donn√©e</td></tr>`;
      return;
    }

    $("recapByCity").innerHTML = villes.map(v=>{
      const o = byCity[v];
      const sum = TYPES.reduce((s,k)=>s+o[k],0);
      return `
        <tr>
          <td>${v}</td>
          <td class="right">${r1(o.PAM)}</td>
          <td class="right">${r1(o.ASL)}</td>
          <td class="right">${r1(o.ABJ)}</td>
          <td class="right">${r1(o.F)}</td>
          <td class="right">${r1(o.HF)}</td>
          <td class="right"><b>${r1(sum)}</b></td>
        </tr>`;
    }).join("");

  }catch(e){
    if($("recapAll")) $("recapAll").innerHTML = `<tr><td colspan="6">Erreur: ${(e?.message||String(e))}</td></tr>`;
    if($("recapByCity")) $("recapByCity").innerHTML = "";
  }
}

/* Auto session */
(async ()=>{
  refreshNetwork();
  const { data } = await supabase.auth.getUser();
  if(data?.user){
    currentUser = data.user;
    $("badgeUser").textContent = currentUser?.email ? ("Connect√© : " + currentUser.email) : "Connect√©";

    try { isAdminUser = await checkAdmin(); } catch { isAdminUser = false; }
    setAdminUI();

    $("loginScreen").style.display = "none";
    $("app").style.display = "block";

    await loadCities();
    await loadData();
    if($("recapDate")) $("recapDate").value = ymdToday();
    buildRecap();
    show("pesee");
  }
})();

/* Service worker */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/Pes-e/sw.js");
}
</script>
</body>
</html>
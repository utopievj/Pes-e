<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pesée</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#fff}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border-radius:16px;padding:16px}
button{padding:14px;border-radius:12px;border:none;background:#b22222;color:#fff;font-weight:700}
button.danger{background:#8b0000}
.smallBtn{padding:8px 10px;font-size:12px}
input,select{width:100%;padding:12px;border-radius:10px;border:none}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:800px){.col-4,.col-6{grid-column:span 12}}
.tableWrap{overflow:auto;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px;border-bottom:1px solid #333}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center}
.badge{font-size:12px;border:1px solid #555;border-radius:20px;padding:4px 8px}
#status,#loginMsg{white-space:pre-wrap;color:#ffd27a;font-size:12px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card" style="max-width:420px;width:100%">
    <h2>Connexion</h2>

    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mot de passe">

    <button onclick="login()">SE CONNECTER</button>
    <button class="danger smallBtn" onclick="resetCache()">RESET CACHE</button>
    <button class="smallBtn" onclick="diag()">DIAG</button>

    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="smallBtn" onclick="show('pesee')">PESÉE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="show('trie')">TRIE</button>
        <button class="smallBtn" onclick="logout()">DÉCONNEXION</button>
        <span class="badge" id="badgeUser"></span>
        <span class="badge" id="badgeAdmin"></span>
      </div>

      <div id="status"></div>

      <div id="pagePesee">
        <h2>Pesée</h2>
        <div class="grid">
          <div class="col-4"><input id="ville" placeholder="Ville"></div>
          <div class="col-4">
            <select id="type">
              <option>PAM</option><option>ASL</option><option>ABJ</option>
            </select>
          </div>
          <div class="col-4"><input id="brut" type="number" placeholder="Poids brut"></div>
          <div class="col-12">
            <button onclick="savePesee()">ENREGISTRER</button>
          </div>
        </div>
      </div>

      <div id="pageHist" style="display:none">
        <h2>Historique</h2>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Date</th><th>Ville</th><th>Type</th><th>Net</th><th>Opérateur</th></tr></thead>
            <tbody id="histTable"></tbody>
          </table>
        </div>
      </div>

      <div id="pageTrie" style="display:none">
        <h2>Trie</h2>

        <h3>PAM</h3>
        <button onclick="addTrie('pam',1)">+1</button>
        <button class="danger" onclick="addTrie('pam',-1)">-1</button>
        <div id="pamTrie"></div>

        <h3>ASL</h3>
        <button onclick="addTrie('asl',1)">+1</button>
        <button class="danger" onclick="addTrie('asl',-1)">-1</button>
        <div id="aslTrie"></div>
      </div>

    </div>
  </div>
</div>
<script>
const SUPABASE_URL = "https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_EMAIL = "boyrieanthony2@gmail.com";

const $ = id => document.getElementById(id);

function showFatal(msg){
  $("status").textContent = "❌ " + msg;
  $("loginMsg").textContent = "❌ " + msg;
  alert(msg);
}

async function login(){
  try{
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password) return showFatal("Email ou mot de passe manquant");

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;

    const { data } = await supabase.auth.getUser();
    const user = data.user;

    $("loginScreen").style.display = "none";
    $("app").style.display = "block";
    $("badgeUser").textContent = user.email;

    const isAdmin = user.email === ADMIN_EMAIL;
    $("badgeAdmin").textContent = isAdmin ? "ADMIN" : "USER";

    loadHistorique();
    loadTrie();
  }catch(e){
    showFatal(e.message);
  }
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

function show(p){
  ["pagePesee","pageHist","pageTrie"].forEach(id=>$(id).style.display="none");
  $("page"+p.charAt(0).toUpperCase()+p.slice(1)).style.display="block";
}

function resetCache(){
  localStorage.clear();
  alert("Cache supprimé, recharge la page");
}

function diag(){
  alert(
    "Online: "+navigator.onLine+
    "\nSupabase SDK: "+!!window.supabase+
    "\nLocalStorage: "+(()=>{try{localStorage.setItem("t","1");localStorage.removeItem("t");return"OK"}catch{return"KO"}})()
  );
}
<script>
async function savePesee(){
  try{
    const ville = $("ville").value;
    const type = $("type").value;
    const brut = Number($("brut").value);
    if(!ville || !brut) return alert("Champs manquants");

    const { data } = await supabase.auth.getUser();
    const operator = data.user.email;

    await supabase.from("pesees").insert({
      ville, type, brut, net: brut, operator
    });

    $("brut").value="";
    loadHistorique();
  }catch(e){ showFatal(e.message); }
}

async function loadHistorique(){
  const { data } = await supabase.from("pesees").select("*").order("created_at",{ascending:false});
  $("histTable").innerHTML = data.map(r=>`
    <tr>
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.ville}</td>
      <td>${r.type}</td>
      <td>${r.net}</td>
      <td>${r.operator}</td>
    </tr>
  `).join("");
}

async function addTrie(type,delta){
  await supabase.from("trie").insert({ type, delta });
  loadTrie();
}

async function loadTrie(){
  const { data } = await supabase.from("trie").select("*");
  $("pamTrie").textContent = data.filter(x=>x.type==="pam").reduce((a,b)=>a+b.delta,0);
  $("aslTrie").textContent = data.filter(x=>x.type==="asl").reduce((a,b)=>a+b.delta,0);
}
</script>

</body>
</html>
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pes√©e</title>

<!-- ‚úÖ GitHub Pages: chemins RELATIFS (important) -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#b22222">

<!-- ‚úÖ Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px;color:#ffffff}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
button:disabled{opacity:.6;cursor:not-allowed}
.smallBtn{padding:10px 12px;font-size:12px}
.danger{background:#8b0000;border-color:#5c0000}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:820px){.col-4,.col-3,.col-2,.col-6{grid-column:span 12}}
.big{font-size:34px;font-weight:900;margin:8px 0}
.badge{display:inline-block;padding:4px 10px;border:1px solid #222634;border-radius:999px;font-size:12px;color:#ffffff}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
th{font-size:12px;color:#ffffff;white-space:nowrap;text-align:left}
.right{text-align:right}
.center{min-height:90vh;display:flex;align-items:center;justify-content:center}
.max420{max-width:420px;width:100%}
hr{border:0;border-top:1px solid #222634;margin:14px 0}

/* ‚úÖ IMPORTANT: on garde les messages visibles (sinon ‚Äú√ßa fait rien‚Äù) */
#loginMsg, #status{
  margin:10px 0;
  font-size:12px;
  white-space:pre-wrap;
  color:#ffd27a;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card max420">
    <h2 style="margin-top:0">Connexion</h2>

    <label>Email</label>
    <input id="email" type="email" autocomplete="username" inputmode="email">

    <label>Mot de passe</label>
    <input id="password" type="password" autocomplete="current-password">

    <div style="margin-top:12px;display:grid;gap:10px">
      <button id="btnLogin" onclick="login()">SE CONNECTER</button>
      <button class="danger" onclick="resetCache()">RESET CACHE (si √ßa bug sur un autre tel)</button>
    </div>

    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="smallBtn" onclick="show('pesee')">PES√âE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="show('trie')">TRIE</button>
        <button class="smallBtn" onclick="loadAll()">üîÑ Rafra√Æchir</button>
        <button class="smallBtn" onclick="syncAll()">‚ü≥ SYNC</button>
        <button class="smallBtn" onclick="logout()">üö™ D√©connexion</button>
        <span class="badge" id="badgeUser">Connect√©</span>
        <span class="badge" id="badgeNet">R√©seau : ?</span>
        <span class="badge" id="badgeAdmin">Utilisateur</span>
        <span class="badge" id="badgeStore">Donn√©es : ?</span>
      </div>

      <div id="status">Pr√™t.</div>

      <!-- PAGE PES√âE -->
      <div id="pagePesee">
        <h2>Pes√©e</h2>

        <div class="grid">
          <div class="col-4">
            <label>Ville</label>
            <select id="ville"></select>
          </div>

          <div class="col-4">
            <label>Type</label>
            <select id="type">
              <option value="PAM">PAM</option>
              <option value="ASL">ASL</option>
              <option value="ABJ">ABJ</option>
              <option value="FRIGO">Frigo</option>
              <option value="HF">Hors froid</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nb bacs</label>
            <input id="nb" type="number" inputmode="numeric" min="1" step="1" value="1">
          </div>

          <div class="col-2">
            <label>Brut (kg)</label>
            <input id="brut" type="number" inputmode="decimal" step="0.1" placeholder="Ex: 120.5">
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="net">0</span> kg</div>
          </div>

          <div class="col-12">
            <button onclick="saveSafe()">ENREGISTRER</button>
          </div>
        </div>
      </div>

      <!-- PAGE HIST -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>

        <div id="adminPanel" style="display:none">
          <hr>
          <h3>Admin ‚Äì Villes</h3>

          <div class="grid">
            <div class="col-6">
              <label>Ajouter une ville</label>
              <input id="newCity" type="text" placeholder="Ex: Toulouse">
            </div>
            <div class="col-6" style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
              <button class="smallBtn" onclick="addCity()">‚ûï Ajouter</button>
              <button class="smallBtn" onclick="loadCities()">üîÑ Recharger</button>
            </div>
            <div class="col-12">
              <div class="tableWrap">
                <table>
                  <thead><tr><th>Ville</th><th class="right">Action</th></tr></thead>
                  <tbody id="citiesAdmin"></tbody>
                </table>
              </div>
            </div>
          </div>

          <hr>
          <h3>Admin ‚Äì Historique</h3>
          <button class="smallBtn danger" onclick="clearAll()">üßπ Vider tout l‚Äôhistorique</button>
        </div>

        <hr>

        <h3>Historique pes√©es</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Ville</th><th>Type</th><th class="right">Nb</th><th class="right">Net</th><th>Op√©rateur</th><th>Source</th>
                <th id="thAdmin" style="display:none">Admin</th>
              </tr>
            </thead>
            <tbody id="histMix"></tbody>
          </table>
        </div>

        <hr>
        <h2>Trie (historique)</h2>

        <h3>PAM tri√©</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="pamTrieTotalsHist"></tbody>
          </table>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+ / -</th><th>Source</th></tr></thead>
            <tbody id="pamTrieHistHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>ASL tri√©</h3>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="aslTrieTotalsHist"></tbody>
          </table>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+ / -</th><th>Source</th></tr></thead>
            <tbody id="aslTrieHistHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>Trie KG (plastiques / nrep‚Ä¶)</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th>Date/Heure</th><th>Cat√©gorie</th><th>Bac</th><th class="right">Nb bacs</th><th class="right">Brut</th><th class="right">Tare</th><th class="right">Net</th><th>Op√©rateur</th><th>Source</th></tr>
            </thead>
            <tbody id="trieKgHist"></tbody>
          </table>
        </div>
      </div>

      <!-- PAGE TRIE -->
      <div id="pageTrie" style="display:none">
        <h2>Trie</h2>

        <h3>Trie (PAM) : boutons +1 / -1</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button onclick="addPamTrie(+1)">+1 PAM tri√©</button>
          <button class="danger" onclick="addPamTrie(-1)">-1 PAM tri√©</button>
          <button class="smallBtn" onclick="syncPamTriePending()">‚ü≥ SYNC PAM (<span id="pamTriePendingCount">0</span>)</button>
        </div>

        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="pamTrieTotals"></tbody>
          </table>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+ / -</th><th>Source</th></tr></thead>
            <tbody id="pamTrieHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>Trie (ASL) : boutons +1 / -1</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button onclick="addAslTrie(+1)">+1 ASL tri√©</button>
          <button class="danger" onclick="addAslTrie(-1)">-1 ASL tri√©</button>
          <button class="smallBtn" onclick="syncAslTriePending()">‚ü≥ SYNC ASL (<span id="aslTriePendingCount">0</span>)</button>
        </div>

        <div class="tableWrap">
          <table>
            <thead><tr><th>Jour</th><th class="right">Total</th></tr></thead>
            <tbody id="aslTrieTotals"></tbody>
          </table>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+ / -</th><th>Source</th></tr></thead>
            <tbody id="aslTrieHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>Trie en KG (avec tare ABJ / ASL)</h3>
        <div class="grid">

          <div class="col-6">
            <label>Cat√©gorie</label>
            <select id="trieKgCat">
              <option value="PAM Pile">PAM Pile</option>
              <option value="Plastique dur">Plastique dur</option>
              <option value="Plastique mou">Plastique mou</option>
              <option value="ASL autre">ASL autre</option>
              <option value="N-DIB">N-DIB</option>
              <option value="NREP Ecomaison">NREP Ecomaison</option>
              <option value="NREP Refashion">NREP Refashion</option>
            </select>
          </div>

          <div class="col-3">
            <label>Bac</label>
            <select id="trieKgBac">
              <option value="ABJ">ABJ (43kg)</option>
              <option value="ASL">ASL (45kg)</option>
              <option value="PAM">PAM (59kg)</option>
            </select>
          </div>

          <div class="col-3">
            <label>Nb bacs</label>
            <input id="trieKgNb" type="number" inputmode="numeric" min="1" step="1" value="1">
          </div>

          <div class="col-6">
            <label>Brut (kg)</label>
            <input id="trieKgBrut" type="number" inputmode="decimal" step="0.1" placeholder="Ex: 80.2">
          </div>

          <div class="col-6" style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
            <button onclick="saveTrieKg()">ENREGISTRER KG</button>
            <button class="smallBtn" onclick="syncTrieKgPending()">‚ü≥ SYNC KG (<span id="trieKgPendingCount">0</span>)</button>
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="trieKgNet">0</span> kg</div>
          </div>

        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr><th>Date/Heure</th><th>Cat√©gorie</th><th>Bac</th><th class="right">Nb</th><th class="right">Net</th><th>Source</th></tr>
            </thead>
            <tbody id="trieKgMini"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================
   ‚úÖ CONFIG SUPABASE
========================= */
const SUPABASE_URL = "https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";

/* ‚úÖ Affiche les erreurs JS √† l‚Äô√©cran */
window.onerror = function(msg, src, line, col){
  const box = document.getElementById("loginMsg") || document.getElementById("status");
  if(box) box.textContent = "‚ùå JS ERROR\n" + msg + "\n" + (src||"") + ":" + line + ":" + col;
};
window.addEventListener("unhandledrejection", (e)=>{
  const box = document.getElementById("loginMsg") || document.getElementById("status");
  if(box) box.textContent = "‚ùå PROMISE ERROR\n" + (e.reason?.message || e.reason || e);
});

if(!window.supabase){
  const box = document.getElementById("loginMsg");
  if(box) box.textContent = "‚ùå Supabase SDK non charg√©. V√©rifie ta connexion / bloqueur / DNS.";
}

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   ‚úÖ UTILS
========================= */
const $ = (id)=>document.getElementById(id);
const r1 = (x)=>Math.round(x*10)/10;
const num = (x)=>{ const v=Number(String(x).replace(",", ".")); return Number.isFinite(v)?v:0; };

function setStatus(msg){ const el=$("status"); if(el) el.textContent = msg||""; }
function setLoginMsg(msg){ const el=$("loginMsg"); if(el) el.textContent = msg||""; }

function refreshNetwork(){ $("badgeNet").textContent = "R√©seau : " + (navigator.onLine ? "OK" : "HORS-LIGNE"); }
window.addEventListener("online", refreshNetwork);
window.addEventListener("offline", refreshNetwork);

/* =========================
   ‚úÖ TARES
========================= */
const T = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const A = { PAM:"PAM", ASL:"ASL", ABJ:"ABJ", FRIGO:"F", HF:"HF" };

/* =========================
   ‚úÖ OFFLINE KEYS
========================= */
const PENDING_KEY = "pesees_pending_v5";
const HISTORY_CACHE_KEY = "pesees_history_cache_v5";
const CACHE_META_KEY = "pesees_history_cache_meta_v5";

const PAM_TRIE_PENDING_KEY = "pam_trie_pending_v2";
const PAM_TRIE_CACHE_KEY   = "pam_trie_cache_v2";

const ASL_TRIE_PENDING_KEY = "asl_trie_pending_v2";
const ASL_TRIE_CACHE_KEY   = "asl_trie_cache_v2";

const TRIEKG_PENDING_KEY = "trie_kg_pending_v1";
const TRIEKG_CACHE_KEY   = "trie_kg_cache_v1";

let currentUser = null;
let isAdminUser = false;
let lastHistorySource = "CACHE";

function ymdLocalFromISO(iso){
  const d=new Date(iso);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

/* =========================
   ‚úÖ RESET CACHE (pour les autres t√©l√©phones)
========================= */
async function resetCache(){
  try{
    setLoginMsg("Reset cache‚Ä¶");
    // localStorage
    localStorage.clear();

    // unregister SW
    if("serviceWorker" in navigator){
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs) await r.unregister();
    }

    // refresh hard with cache-bust
    const u = new URL(location.href);
    u.searchParams.set("v", String(Date.now()));
    location.href = u.toString();
  }catch(e){
    setLoginMsg("‚ùå Reset cache erreur: " + (e?.message||String(e)));
  }
}

/* =========================
   ‚úÖ ADMIN
========================= */
async function checkAdmin(){
  try{
    const { data, error } = await supabase.rpc("is_admin");
    if(error) throw error;
    return !!data;
  }catch{
    return false;
  }
}
function setAdminUI(){
  $("badgeAdmin").textContent = isAdminUser ? "ADMIN" : "Utilisateur";
  $("adminPanel").style.display = isAdminUser ? "block" : "none";
  $("thAdmin").style.display = isAdminUser ? "table-cell" : "none";
}

/* =========================
   ‚úÖ NAV PAGES
========================= */
function show(p){
  $("pagePesee").style.display = (p==="pesee") ? "block" : "none";
  $("pageHist").style.display  = (p==="hist")  ? "block" : "none";
  $("pageTrie").style.display  = (p==="trie")  ? "block" : "none";

  if(p==="hist" || p==="trie"){
    loadTrieAll();
  }
}

/* =========================
   ‚úÖ PES√âE CALCUL
========================= */
function calc(){
  const nb = Math.max(1, Math.floor(num($("nb").value)));
  $("nb").value = nb;
  const brut = num($("brut").value);
  const tare = (T[$("type").value] || 0) * nb;
  const net = Math.max(0, brut - tare);
  $("net").textContent = r1(net);
}
["input","change"].forEach(ev=>{
  $("type").addEventListener(ev, calc);
  $("nb").addEventListener(ev, calc);
  $("brut").addEventListener(ev, calc);
});

/* =========================
   ‚úÖ OFFLINE PENDING PES√âE
========================= */
function getPending(){ try{ return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]"); }catch{ return []; } }
function setPending(arr){ localStorage.setItem(PENDING_KEY, JSON.stringify(arr||[])); }
function addPending(row){ const arr=getPending(); arr.unshift(row); setPending(arr); }
function removePending(client_id){ setPending(getPending().filter(x=>x.client_id!==client_id)); }

/* =========================
   ‚úÖ CACHE PES√âE
========================= */
function getHistoryCache(){ try{ return JSON.parse(localStorage.getItem(HISTORY_CACHE_KEY) || "[]"); }catch{ return []; } }
function setHistoryCache(rows, source){
  localStorage.setItem(HISTORY_CACHE_KEY, JSON.stringify(rows||[]));
  localStorage.setItem(CACHE_META_KEY, JSON.stringify({ updatedAt: Date.now(), source: source||"LIVE" }));
}
function getHistoryMeta(){ try{ return JSON.parse(localStorage.getItem(CACHE_META_KEY) || "null"); }catch{ return null; } }

function setStoreBadge(){
  const meta = getHistoryMeta();
  const info = meta?.updatedAt ? new Date(meta.updatedAt).toLocaleString() : "‚Äî";
  $("badgeStore").textContent = `Donn√©es : ${lastHistorySource} (${info})`;
}

/* =========================
   ‚úÖ RENDER HIST PES√âE
========================= */
function renderHistory(){
  const rows = getHistoryCache();
  const tb = $("histMix");
  tb.innerHTML = "";
  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="${isAdminUser?8:7}">Aucune donn√©e</td></tr>`;
    return;
  }
  rows.forEach(r=>{
    const src = lastHistorySource==="LIVE" ? "LIVE" : "CACHE";
    const adminCell = isAdminUser ? `<td><button class="smallBtn danger" onclick="deleteRow(${r.id})">Suppr</button></td>` : "";
    tb.innerHTML += `
      <tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.ville||""}</td>
        <td>${r.type||""}</td>
        <td class="right">${r.nb||""}</td>
        <td class="right">${r.net||""}</td>
        <td>${r.user_email||""}</td>
        <td>${src}</td>
        ${adminCell}
      </tr>`;
  });
}

/* =========================
   ‚úÖ LOAD PES√âE DATA
========================= */
async function loadData(){
  try{
    const { data, error } = await supabase
      .from("pesees")
      .select("id, created_at, ville, type, nb, net, client_id, user_email")
      .order("created_at", { ascending:false })
      .limit(1200);
    if(error) throw error;

    lastHistorySource="LIVE";
    setHistoryCache(data||[], "LIVE");
    setStoreBadge();
    renderHistory();
  }catch(e){
    lastHistorySource="CACHE";
    setStoreBadge();
    setStatus("‚ö†Ô∏è Supabase indisponible : affichage depuis le CACHE.");
    renderHistory();
  }
}

/* =========================
   ‚úÖ CITIES
========================= */
async function loadCities(){
  try{
    const { data, error } = await supabase.from("villes").select("id, nom").order("nom", { ascending:true }).limit(500);
    if(error) throw error;

    const sel = $("ville");
    sel.innerHTML = "";
    (data||[]).forEach(v=>{
      const opt=document.createElement("option");
      opt.value=v.nom; opt.textContent=v.nom;
      sel.appendChild(opt);
    });
    if(!sel.options.length) sel.innerHTML="<option>‚Äî</option>";

    const tb=$("citiesAdmin");
    tb.innerHTML="";
    if(!isAdminUser){
      tb.innerHTML = `<tr><td colspan="2">Admin uniquement</td></tr>`;
      return;
    }
    (data||[]).forEach(v=>{
      tb.innerHTML += `
        <tr>
          <td>${v.nom}</td>
          <td class="right"><button class="smallBtn danger" onclick="deleteCity(${v.id}, '${String(v.nom).replace(/'/g,"&#39;")}')">Suppr</button></td>
        </tr>`;
    });
    if(!(data||[]).length) tb.innerHTML=`<tr><td colspan="2">Aucune ville</td></tr>`;
  }catch(e){
    setStatus("‚ùå VILLES: " + (e?.message||String(e)));
  }
}
async function addCity(){
  if(!isAdminUser) return alert("Admin uniquement");
  const name=($("newCity").value||"").trim();
  if(!name) return alert("Entre une ville.");
  try{
    const { error } = await supabase.from("villes").insert({ nom:name });
    if(error) throw error;
    $("newCity").value="";
    await loadCities();
  }catch(e){
    alert("‚ùå " + (e?.message||String(e)));
  }
}
async function deleteCity(id, nom){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("Supprimer la ville : " + nom + " ?")) return;
  try{
    const { error } = await supabase.from("villes").delete().eq("id", id);
    if(error) throw error;
    await loadCities();
  }catch(e){
    alert("‚ùå " + (e?.message||String(e)));
  }
}

/* =========================
   ‚úÖ SAVE PES√âE (avec op√©rateur)
========================= */
async function saveSafe(){
  try{
    calc();
    const nb = Math.max(1, Math.floor(num($("nb").value)));
    const brut = num($("brut").value);
    const tare = (T[$("type").value] || 0) * nb;
    const net = Math.max(0, brut - tare);
    const ville = ($("ville").value||"").trim();
    const type = A[$("type").value];

    if(!ville || ville==="‚Äî") return alert("Choisis une ville.");
    if(brut<=0) return alert("Entre un poids brut.");
    if(brut<tare) return alert("Brut inf√©rieur √† la tare.");

    const { data: u } = await supabase.auth.getUser();
    if(!u?.user) return alert("Connecte-toi.");

    const client_id = "p_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    const payload = { client_id, ville, type, nb, brut:r1(brut), tare:r1(tare), net:r1(net), user_email: u.user.email||null };

    setStatus("Insertion‚Ä¶");
    const { error } = await supabase.from("pesees").upsert(payload, { onConflict:"client_id" });
    if(error) throw error;

    $("brut").value="";
    calc();
    setStatus("‚úÖ Enregistr√©");
    await loadData();
    show("pesee");
  }catch(e){
    setStatus("‚ùå " + (e?.message||String(e)));
  }
}

/* =========================
   ‚úÖ ADMIN DELETE / CLEAR
========================= */
async function deleteRow(id){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("Supprimer cette ligne ?")) return;
  try{
    const { error } = await supabase.from("pesees").delete().eq("id", id);
    if(error) throw error;
    await loadData();
  }catch(e){
    alert("‚ùå " + (e?.message||String(e)));
  }
}
async function clearAll(){
  if(!isAdminUser) return alert("Admin uniquement");
  if(!confirm("‚ö†Ô∏è Vider TOUT l‚Äôhistorique ?")) return;
  try{
    // ‚úÖ TRUC IMPORTANT: delete() sans filtre ne marche pas selon RLS.
    // On force un filtre large:
    const { error } = await supabase.from("pesees").delete().gte("id", 0);
    if(error) throw error;
    await loadData();
  }catch(e){
    alert("‚ùå " + (e?.message||String(e)));
  }
}

/* =========================
   ‚úÖ LOGIN / LOGOUT (avec messages clairs)
========================= */
async function login(){
  try{
    $("btnLogin").disabled = true;
    const email = ($("email").value||"").trim();
    const password = $("password").value||"";
    if(!email || !password){
      setLoginMsg("‚ö†Ô∏è Email + mot de passe obligatoires.");
      $("btnLogin").disabled = false;
      return;
    }

    setLoginMsg("Connexion‚Ä¶");
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;

    // check session
    const { data: u } = await supabase.auth.getUser();
    currentUser = u?.user || null;
    if(!currentUser) throw new Error("Connexion OK mais utilisateur introuvable (session).");

    isAdminUser = await checkAdmin();
    setAdminUI();

    $("badgeUser").textContent = "Connect√© : " + (currentUser.email||"");
    $("loginScreen").style.display="none";
    $("app").style.display="block";

    await loadCities();
    await loadData();
    await loadPamTrieData();
    await loadAslTrieData();
    await loadTrieKgData();
    loadTrieAll();

    setLoginMsg("");
    setStatus("‚úÖ Connect√©");
    show("pesee");
  }catch(e){
    setLoginMsg("‚ùå " + (e?.message || String(e)));
  }finally{
    $("btnLogin").disabled = false;
  }
}

async function logout(){
  try{
    setStatus("D√©connexion‚Ä¶");
    await supabase.auth.signOut();
    location.reload();
  }catch(e){
    setStatus("‚ùå " + (e?.message||String(e)));
  }
}

/* =========================
   ‚úÖ LOAD / SYNC ALL
========================= */
async function loadAll(){
  refreshNetwork();
  await loadCities();
  await loadData();
  await loadPamTrieData();
  await loadAslTrieData();
  await loadTrieKgData();
  loadTrieAll();
}
async function syncAll(){
  await syncPamTriePending();
  await syncAslTriePending();
  await syncTrieKgPending();
  await loadAll();
}
/* =========================
   ‚úÖ TRIE PAM (+1/-1)
========================= */
function getPamTriePending(){ try{return JSON.parse(localStorage.getItem(PAM_TRIE_PENDING_KEY)||"[]");}catch{return [];} }
function setPamTriePending(arr){ localStorage.setItem(PAM_TRIE_PENDING_KEY, JSON.stringify(arr||[])); $("pamTriePendingCount").textContent=String((arr||[]).length); }
function getPamTrieCache(){ try{return JSON.parse(localStorage.getItem(PAM_TRIE_CACHE_KEY)||"[]");}catch{return [];} }
function setPamTrieCache(rows){ localStorage.setItem(PAM_TRIE_CACHE_KEY, JSON.stringify(rows||[])); }

async function addPamTrie(delta){
  const client_id="t_pam_"+Date.now()+"_"+Math.random().toString(16).slice(2);
  try{
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user) return alert("Connecte-toi.");
    if(!navigator.onLine) throw new Error("offline");

    const payload={ client_id, delta, user_email: u.user.email||null };
    const { error } = await supabase.from("pam_trie").upsert(payload,{ onConflict:"client_id" });
    if(error) throw error;

    await loadPamTrieData();
    loadTrieAll();
  }catch{
    const arr=getPamTriePending(); arr.unshift({ client_id, local_created_at: Date.now(), delta });
    setPamTriePending(arr);
    loadTrieAll();
  }
}

async function syncPamTriePending(){
  const arr=getPamTriePending();
  $("pamTriePendingCount").textContent=String(arr.length);
  if(!arr.length || !navigator.onLine) return;

  const { data: u } = await supabase.auth.getUser();
  if(!u?.user) return;

  const toSend=[...arr].reverse();
  for(const row of toSend){
    const payload={ client_id: row.client_id, delta: row.delta, user_email: u.user.email||null };
    const { error } = await supabase.from("pam_trie").upsert(payload,{ onConflict:"client_id" });
    if(!error){
      setPamTriePending(getPamTriePending().filter(x=>x.client_id!==row.client_id));
    }else{
      break;
    }
  }
  await loadPamTrieData();
  loadTrieAll();
}

async function loadPamTrieData(){
  try{
    const { data, error } = await supabase
      .from("pam_trie")
      .select("created_at, delta")
      .order("created_at",{ ascending:false })
      .limit(2000);
    if(error) throw error;
    setPamTrieCache(data||[]);
  }catch{
    // offline => cache only
  }
}

function buildPamTrieMerged(){
  const pending=getPamTriePending().map(p=>({ created_at:new Date(p.local_created_at).toISOString(), delta:p.delta, _source:"ATTENTE" }));
  const cached=getPamTrieCache().map(r=>({ ...r, _source:(navigator.onLine?"LIVE":"CACHE") }));
  const all=[...pending,...cached].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  const totals={};
  for(const r of all){
    const day=ymdLocalFromISO(r.created_at);
    totals[day]=(totals[day]||0)+(Number(r.delta)||0);
  }
  const totalsArr=Object.keys(totals).sort((a,b)=>b.localeCompare(a)).map(day=>({ day, total: totals[day] }));
  return { all, totalsArr };
}

function renderPamTrieTables(totalsId, histId){
  const { all, totalsArr } = buildPamTrieMerged();
  const tbT=$(totalsId); tbT.innerHTML = totalsArr.length
    ? totalsArr.map(r=>`<tr><td>${r.day}</td><td class="right"><b>${r.total}</b></td></tr>`).join("")
    : `<tr><td colspan="2">Aucune donn√©e</td></tr>`;

  const tbH=$(histId); tbH.innerHTML = all.length
    ? all.slice(0,400).map(r=>{
        const dt=new Date(r.created_at).toLocaleString();
        const v=(r.delta>0?("+"+r.delta):String(r.delta));
        return `<tr><td>${dt}</td><td class="right"><b>${v}</b></td><td>${r._source}</td></tr>`;
      }).join("")
    : `<tr><td colspan="3">Aucune donn√©e</td></tr>`;
}

/* =========================
   ‚úÖ TRIE ASL (+1/-1)
========================= */
function getAslTriePending(){ try{return JSON.parse(localStorage.getItem(ASL_TRIE_PENDING_KEY)||"[]");}catch{return [];} }
function setAslTriePending(arr){ localStorage.setItem(ASL_TRIE_PENDING_KEY, JSON.stringify(arr||[])); $("aslTriePendingCount").textContent=String((arr||[]).length); }
function getAslTrieCache(){ try{return JSON.parse(localStorage.getItem(ASL_TRIE_CACHE_KEY)||"[]");}catch{return [];} }
function setAslTrieCache(rows){ localStorage.setItem(ASL_TRIE_CACHE_KEY, JSON.stringify(rows||[])); }

async function addAslTrie(delta){
  const client_id="t_asl_"+Date.now()+"_"+Math.random().toString(16).slice(2);
  try{
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user) return alert("Connecte-toi.");
    if(!navigator.onLine) throw new Error("offline");

    const payload={ client_id, delta, user_email: u.user.email||null };
    const { error } = await supabase.from("asl_trie").upsert(payload,{ onConflict:"client_id" });
    if(error) throw error;

    await loadAslTrieData();
    loadTrieAll();
  }catch{
    const arr=getAslTriePending(); arr.unshift({ client_id, local_created_at: Date.now(), delta });
    setAslTriePending(arr);
    loadTrieAll();
  }
}

async function syncAslTriePending(){
  const arr=getAslTriePending();
  $("aslTriePendingCount").textContent=String(arr.length);
  if(!arr.length || !navigator.onLine) return;

  const { data: u } = await supabase.auth.getUser();
  if(!u?.user) return;

  const toSend=[...arr].reverse();
  for(const row of toSend){
    const payload={ client_id: row.client_id, delta: row.delta, user_email: u.user.email||null };
    const { error } = await supabase.from("asl_trie").upsert(payload,{ onConflict:"client_id" });
    if(!error){
      setAslTriePending(getAslTriePending().filter(x=>x.client_id!==row.client_id));
    }else{
      break;
    }
  }
  await loadAslTrieData();
  loadTrieAll();
}

async function loadAslTrieData(){
  try{
    const { data, error } = await supabase
      .from("asl_trie")
      .select("created_at, delta")
      .order("created_at",{ ascending:false })
      .limit(2000);
    if(error) throw error;
    setAslTrieCache(data||[]);
  }catch{
    // offline => cache only
  }
}

function buildAslTrieMerged(){
  const pending=getAslTriePending().map(p=>({ created_at:new Date(p.local_created_at).toISOString(), delta:p.delta, _source:"ATTENTE" }));
  const cached=getAslTrieCache().map(r=>({ ...r, _source:(navigator.onLine?"LIVE":"CACHE") }));
  const all=[...pending,...cached].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  const totals={};
  for(const r of all){
    const day=ymdLocalFromISO(r.created_at);
    totals[day]=(totals[day]||0)+(Number(r.delta)||0);
  }
  const totalsArr=Object.keys(totals).sort((a,b)=>b.localeCompare(a)).map(day=>({ day, total: totals[day] }));
  return { all, totalsArr };
}

function renderAslTrieTables(totalsId, histId){
  const { all, totalsArr } = buildAslTrieMerged();
  const tbT=$(totalsId); tbT.innerHTML = totalsArr.length
    ? totalsArr.map(r=>`<tr><td>${r.day}</td><td class="right"><b>${r.total}</b></td></tr>`).join("")
    : `<tr><td colspan="2">Aucune donn√©e</td></tr>`;

  const tbH=$(histId); tbH.innerHTML = all.length
    ? all.slice(0,400).map(r=>{
        const dt=new Date(r.created_at).toLocaleString();
        const v=(r.delta>0?("+"+r.delta):String(r.delta));
        return `<tr><td>${dt}</td><td class="right"><b>${v}</b></td><td>${r._source}</td></tr>`;
      }).join("")
    : `<tr><td colspan="3">Aucune donn√©e</td></tr>`;
}

/* =========================
   ‚úÖ TRIE KG (avec tare)
========================= */
function getTrieKgPending(){ try{return JSON.parse(localStorage.getItem(TRIEKG_PENDING_KEY)||"[]");}catch{return [];} }
function setTrieKgPending(arr){ localStorage.setItem(TRIEKG_PENDING_KEY, JSON.stringify(arr||[])); $("trieKgPendingCount").textContent=String((arr||[]).length); }
function getTrieKgCache(){ try{return JSON.parse(localStorage.getItem(TRIEKG_CACHE_KEY)||"[]");}catch{return [];} }
function setTrieKgCache(rows){ localStorage.setItem(TRIEKG_CACHE_KEY, JSON.stringify(rows||[])); }

function calcTrieKg(){
  const bac = $("trieKgBac").value;
  const nb = Math.max(1, Math.floor(num($("trieKgNb").value)));
  $("trieKgNb").value = nb;
  const brut = num($("trieKgBrut").value);
  const tare = (T[bac]||0)*nb;
  const net = Math.max(0, brut - tare);
  $("trieKgNet").textContent = r1(net);
  return { bac, nb, brut, tare, net };
}
["input","change"].forEach(ev=>{
  $("trieKgBac").addEventListener(ev, calcTrieKg);
  $("trieKgNb").addEventListener(ev, calcTrieKg);
  $("trieKgBrut").addEventListener(ev, calcTrieKg);
  $("trieKgCat").addEventListener(ev, calcTrieKg);
});

async function saveTrieKg(){
  try{
    const { bac, nb, brut, tare, net } = calcTrieKg();
    const cat = $("trieKgCat").value;
    if(brut<=0) return alert("Entre un brut.");
    if(brut<tare) return alert("Brut inf√©rieur √† la tare.");

    const { data: u } = await supabase.auth.getUser();
    if(!u?.user) return alert("Connecte-toi.");

    const client_id="kg_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    const payload = {
      client_id,
      category: cat,
      bac_type: bac,
      nb,
      brut: r1(brut),
      tare: r1(tare),
      net: r1(net),
      user_email: u.user.email||null
    };

    if(!navigator.onLine) throw new Error("offline");

    const { error } = await supabase.from("trie_kg").upsert(payload,{ onConflict:"client_id" });
    if(error) throw error;

    $("trieKgBrut").value="";
    calcTrieKg();
    await loadTrieKgData();
    loadTrieAll();
  }catch{
    const { bac, nb, brut, tare, net } = calcTrieKg();
    const cat = $("trieKgCat").value;
    const client_id="kg_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    const arr=getTrieKgPending();
    arr.unshift({ client_id, local_created_at: Date.now(), category:cat, bac_type:bac, nb, brut:r1(brut), tare:r1(tare), net:r1(net) });
    setTrieKgPending(arr);
    loadTrieAll();
  }
}

async function syncTrieKgPending(){
  const arr=getTrieKgPending();
  if(!arr.length || !navigator.onLine) return;

  const { data: u } = await supabase.auth.getUser();
  if(!u?.user) return;

  const toSend=[...arr].reverse();
  for(const row of toSend){
    const payload = {
      client_id: row.client_id,
      category: row.category,
      bac_type: row.bac_type,
      nb: row.nb,
      brut: row.brut,
      tare: row.tare,
      net: row.net,
      user_email: u.user.email||null
    };
    const { error } = await supabase.from("trie_kg").upsert(payload,{ onConflict:"client_id" });
    if(!error){
      setTrieKgPending(getTrieKgPending().filter(x=>x.client_id!==row.client_id));
    }else{
      break;
    }
  }
  await loadTrieKgData();
  loadTrieAll();
}

async function loadTrieKgData(){
  try{
    const { data, error } = await supabase
      .from("trie_kg")
      .select("created_at, category, bac_type, nb, brut, tare, net, user_email")
      .order("created_at",{ ascending:false })
      .limit(2000);
    if(error) throw error;
    setTrieKgCache(data||[]);
  }catch{
    // offline => cache only
  }
}

function buildTrieKgMerged(){
  const pending=getTrieKgPending().map(p=>({
    created_at:new Date(p.local_created_at).toISOString(),
    category:p.category, bac_type:p.bac_type, nb:p.nb, brut:p.brut, tare:p.tare, net:p.net,
    user_email:"",
    _source:"ATTENTE"
  }));
  const cached=getTrieKgCache().map(r=>({ ...r, _source:(navigator.onLine?"LIVE":"CACHE") }));
  const all=[...pending,...cached].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  return all;
}

function renderTrieKg(){
  const all = buildTrieKgMerged();

  const mini = $("trieKgMini");
  mini.innerHTML = all.length
    ? all.slice(0,150).map(r=>`
      <tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.category||""}</td>
        <td>${r.bac_type||""}</td>
        <td class="right">${r.nb||""}</td>
        <td class="right"><b>${r.net||""}</b></td>
        <td>${r._source}</td>
      </tr>`).join("")
    : `<tr><td colspan="6">Aucune donn√©e</td></tr>`;

  const hist = $("trieKgHist");
  if(hist){
    hist.innerHTML = all.length
      ? all.slice(0,500).map(r=>`
        <tr>
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${r.category||""}</td>
          <td>${r.bac_type||""}</td>
          <td class="right">${r.nb||""}</td>
          <td class="right">${r.brut||""}</td>
          <td class="right">${r.tare||""}</td>
          <td class="right"><b>${r.net||""}</b></td>
          <td>${r.user_email||""}</td>
          <td>${r._source}</td>
        </tr>`).join("")
      : `<tr><td colspan="9">Aucune donn√©e</td></tr>`;
  }
}

/* =========================
   ‚úÖ RENDER ALL TRIE TABLES
========================= */
function loadTrieAll(){
  setPamTriePending(getPamTriePending());
  setAslTriePending(getAslTriePending());
  setTrieKgPending(getTrieKgPending());

  renderPamTrieTables("pamTrieTotals","pamTrieHist");
  renderPamTrieTables("pamTrieTotalsHist","pamTrieHistHist");

  renderAslTrieTables("aslTrieTotals","aslTrieHist");
  renderAslTrieTables("aslTrieTotalsHist","aslTrieHistHist");

  renderTrieKg();
}

/* =========================
   ‚úÖ INIT
========================= */
(async ()=>{
  refreshNetwork();
  calc();
  calcTrieKg();

  // badge cache
  const meta = getHistoryMeta();
  lastHistorySource = meta?.source || "CACHE";
  setStoreBadge();

  // auto session
  try{
    const { data } = await supabase.auth.getUser();
    if(data?.user){
      currentUser=data.user;
      isAdminUser = await checkAdmin();
      setAdminUI();

      $("badgeUser").textContent = "Connect√© : " + (currentUser.email||"");
      $("loginScreen").style.display="none";
      $("app").style.display="block";

      await loadCities();
      await loadData();
      await loadPamTrieData();
      await loadAslTrieData();
      await loadTrieKgData();
      loadTrieAll();

      show("pesee");
    }else{
      // reste sur login
      setLoginMsg("");
    }
  }catch(e){
    setLoginMsg("‚ùå Init: " + (e?.message||String(e)));
  }
})();

/* =========================
   ‚úÖ SERVICE WORKER (relatif)
   (Si tu n‚Äôas pas sw.js, commente ces 3 lignes)
========================= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}
</script>
</body>
</html>
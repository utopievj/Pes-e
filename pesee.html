<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pesée</title>

<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#fff}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border-radius:16px;padding:16px}
label{display:block;font-size:12px;margin:6px 0 4px}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #333;background:#0f1118;color:#fff}
button{padding:14px;border-radius:12px;border:none;background:#b22222;color:#fff;font-weight:800}
.smallBtn{padding:10px 12px;font-size:12px}
.danger{background:#8b0000}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
@media(max-width:820px){.col-6,.col-4,.col-3,.col-2{grid-column:span 12}}
.big{font-size:36px;font-weight:900;margin:10px 0}
.tableWrap{overflow:auto;border-radius:12px;border:1px solid #222;margin-top:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222}
th{text-align:left;font-size:12px}
.right{text-align:right}
.hidden{display:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="wrap">
  <div class="card" style="max-width:420px;margin:auto">
    <h2>Connexion</h2>
    <label>Email</label>
    <input id="email" type="email">
    <label>Mot de passe</label>
    <input id="password" type="password">
    <button onclick="login()">SE CONNECTER</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap hidden">
  <div class="card">

    <!-- NAV -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button class="smallBtn" onclick="show('pesee')">PESÉE</button>
      <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
      <button class="smallBtn" onclick="show('trie')">TRI</button>
      <button class="smallBtn danger" onclick="logout()">X</button>
    </div>

    <!-- PAGE PESÉE -->
    <div id="pagePesee">
      <div class="grid">
        <div class="col-4">
          <label>Ville</label>
          <select id="ville"></select>
        </div>
        <div class="col-4">
          <label>Type</label>
          <select id="type">
            <option value="PAM">PAM</option>
            <option value="ASL">ASL</option>
            <option value="ABJ">ABJ</option>
            <option value="FRIGO">F</option>
            <option value="HF">HF</option>
          </select>
        </div>
        <div class="col-2">
          <label>Nb</label>
          <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
        </div>
        <div class="col-2">
          <label>Brut</label>
          <input id="brut" type="number" step="0.1">
        </div>
        <div class="col-12">
          <div class="big">NET : <span id="net">0</span> kg</div>
        </div>
        <div class="col-12">
          <button onclick="saveSafe()">VALIDER</button>
        </div>
      </div>
    </div>

    <!-- PAGE HISTORIQUE -->
    <div id="pageHist" class="hidden">
      <h2>Historique</h2>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>Date</th><th>Ville</th><th>Type</th><th class="right">Net</th></tr>
          </thead>
          <tbody id="hist"></tbody>
        </table>
      </div>
    </div>

    <!-- PAGE TRI -->
    <div id="pageTrie" class="hidden">
      <h2>Trie</h2>

      <div class="grid">
        <div class="col-3">
          <label>Date début</label>
          <input id="t_d1" type="date">
        </div>
        <div class="col-3">
          <label>Date fin</label>
          <input id="t_d2" type="date">
        </div>
        <div class="col-3">
          <label>Ville</label>
          <select id="t_ville"><option value="">Toutes</option></select>
        </div>
        <div class="col-3">
          <label>Type</label>
          <select id="t_type">
            <option value="">Tous</option>
            <option>PAM</option><option>ASL</option><option>ABJ</option><option>F</option><option>HF</option>
          </select>
        </div>
        <div class="col-4">
          <label>Trier par</label>
          <select id="t_sort">
            <option value="created_at">Date</option>
            <option value="net">Net</option>
            <option value="ville">Ville</option>
          </select>
        </div>
        <div class="col-2">
          <label>Ordre</label>
          <select id="t_dir"><option value="desc">Desc</option><option value="asc">Asc</option></select>
        </div>
        <div class="col-6" style="display:flex;gap:8px;align-items:end">
          <button class="smallBtn" onclick="loadTrie()">Filtrer</button>
          <button class="smallBtn" onclick="exportTrie()">Export CSV</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>Date</th><th>Ville</th><th>Type</th><th class="right">Nb</th><th class="right">Net</th></tr>
          </thead>
          <tbody id="trieTable"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0"
);

const T={PAM:59,ASL:45,ABJ:43,FRIGO:0,HF:0};
const $=id=>document.getElementById(id);

/* NAV */
function show(p){
  ["pagePesee","pageHist","pageTrie"].forEach(id=>$(id).classList.add("hidden"));
  if(p==="pesee") $("pagePesee").classList.remove("hidden");
  if(p==="hist"){$("pageHist").classList.remove("hidden");loadHist();}
  if(p==="trie"){$("pageTrie").classList.remove("hidden");loadTrieCities();}
}

/* CALCUL */
function calc(){
  const nb=+$("nb").value||0;
  const brut=+$("brut").value||0;
  const net=Math.max(0,brut-(T[$("type").value]*nb));
  $("net").textContent=net.toFixed(1);
}
["input","change"].forEach(e=>{
  $("nb").addEventListener(e,calc);
  $("type").addEventListener(e,calc);
  $("brut").addEventListener(e,calc);
});

/* SAVE */
async function saveSafe(){
  calc();
  await supabase.from("pesees").insert({
    ville:$("ville").value,
    type:$("type").value==="FRIGO"?"F":$("type").value,
    nb:+$("nb").value,
    brut:+$("brut").value,
    net:+$("net").textContent
  });
  $("brut").value="";
  calc();
}

/* HIST */
async function loadHist(){
  const {data}=await supabase.from("pesees").select("*").order("created_at",{ascending:false}).limit(200);
  $("hist").innerHTML=(data||[]).map(r=>`
    <tr>
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.ville}</td>
      <td>${r.type}</td>
      <td class="right">${r.net}</td>
    </tr>`).join("");
}

/* TRI */
let trieRows=[];
async function loadTrieCities(){
  const {data}=await supabase.from("villes").select("nom").order("nom");
  $("t_ville").innerHTML=`<option value="">Toutes</option>`+(data||[]).map(v=>`<option>${v.nom}</option>`).join("");
}
async function loadTrie(){
  let q=supabase.from("pesees").select("created_at,ville,type,nb,net").limit(2000);
  if($("t_d1").value) q=q.gte("created_at",$("t_d1").value+"T00:00:00");
  if($("t_d2").value) q=q.lte("created_at",$("t_d2").value+"T23:59:59");
  if($("t_ville").value) q=q.eq("ville",$("t_ville").value);
  if($("t_type").value) q=q.eq("type",$("t_type").value);
  q=q.order($("t_sort").value,{ascending:$("t_dir").value==="asc"});
  const {data}=await q;
  trieRows=data||[];
  $("trieTable").innerHTML=trieRows.map(r=>`
    <tr>
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.ville}</td>
      <td>${r.type}</td>
      <td class="right">${r.nb}</td>
      <td class="right">${r.net}</td>
    </tr>`).join("");
}
function exportTrie(){
  if(!trieRows.length) return;
  const csv=[["date","ville","type","nb","net"],...trieRows.map(r=>[
    new Date(r.created_at).toLocaleString(),r.ville,r.type,r.nb,r.net
  ])].map(r=>r.join(";")).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="trie.csv";a.click();
}

/* LOGIN */
async function login(){
  const {error}=await supabase.auth.signInWithPassword({
    email:$("email").value,
    password:$("password").value
  });
  if(!error){
    $("loginScreen").classList.add("hidden");
    $("app").classList.remove("hidden");
    loadCities();show("pesee");
  }
}
async function logout(){await supabase.auth.signOut();location.reload();}

/* VILLES */
async function loadCities(){
  const {data}=await supabase.from("villes").select("nom").order("nom");
  $("ville").innerHTML=(data||[]).map(v=>`<option>${v.nom}</option>`).join("");
}

/* AUTO */
(async()=>{
  const {data}=await supabase.auth.getUser();
  if(data?.user){
    $("loginScreen").classList.add("hidden");
    $("app").classList.remove("hidden");
    loadCities();show("pesee");
  }
})();
</script>
</body>
</html>
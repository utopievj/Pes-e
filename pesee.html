<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pes√©e</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px;color:#a8b3d6}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
.smallBtn{padding:10px;font-size:12px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-2{grid-column:span 2}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:760px){.col-4,.col-2,.col-6{grid-column:span 12}}
.big{font-size:32px;font-weight:900}
.net{margin-top:10px;padding:12px;border:1px solid #222634;border-radius:12px;background:#0f1118}
.warn{color:#ffcc66;font-size:12px;display:none;margin-top:6px}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
th{font-size:12px;color:#a8b3d6;white-space:nowrap;text-align:left}
.right{text-align:right}
#status{margin:10px 0;font-size:12px;white-space:pre-wrap;color:#ffd27a}
</style>
</head>
<body>
<div class="wrap"><div class="card">

<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
  <button class="smallBtn" onclick="show('pesee')">PES√âE</button>
  <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
  <button class="smallBtn" onclick="loadData()">üîÑ Rafra√Æchir</button>
  <button class="smallBtn" onclick="testCount()">üß™ TEST DB</button>
</div>

<div id="status">Pr√™t.</div>

<div id="pagePesee">
  <h2>Pes√©e</h2>
  <div class="grid">
    <div class="col-4">
      <label>Ville</label>
      <select id="ville">
        <option>Boulanger Tarbes</option><option>Pau</option><option>Envie</option>
        <option>Assat</option><option>Coaraze</option><option>Espoey</option>
      </select>
    </div>

    <div class="col-4">
      <label>Type</label>
      <select id="type">
        <option value="PAM">PAM</option>
        <option value="ASL">ASL</option>
        <option value="ABJ">ABJ</option>
        <option value="FRIGO">Frigo</option>
        <option value="HF">Hors froid</option>
      </select>
    </div>

    <div class="col-2">
      <label>Nb</label>
      <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
    </div>

    <div class="col-2">
      <label>Brut (kg)</label>
      <input id="brut" type="number" step="0.1">
    </div>

    <div class="col-12">
      <div class="net">
        <div>Tare : <b id="tare">0</b> kg</div>
        <div class="big">Net : <span id="net">0</span> kg</div>
        <div id="warn" class="warn">‚ö†Ô∏è Brut inf√©rieur √† la tare</div>
      </div>
    </div>

    <div class="col-6">
      <label>PIN</label>
      <input id="pin" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>

    <div class="col-6" style="display:flex;align-items:end">
      <button onclick="save()">ENREGISTRER</button>
    </div>
  </div>
</div>

<div id="pageHist" style="display:none">
  <h2>Historique</h2>
  <div class="tableWrap">
    <table>
      <thead>
        <tr><th>Date</th><th>Ville</th><th>Type</th><th>Nb</th><th class="right">Net</th></tr>
      </thead>
      <tbody id="hist"></tbody>
    </table>
  </div>
</div>

</div></div>

<script>
const SUPABASE_URL="https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const T={PAM:59,ASL:45,ABJ:43,FRIGO:0,HF:0};
const A={PAM:"PAM",ASL:"ASL",ABJ:"ABJ",FRIGO:"F",HF:"HF"};
const $=id=>document.getElementById(id);
const r1=x=>Math.round(x*10)/10;
const num=x=>{const v=Number(String(x).replace(",","."));return Number.isFinite(v)?v:0;};

function setStatus(s){ $("status").textContent = s; }

function show(p){
  $("pagePesee").style.display = p==="pesee" ? "block" : "none";
  $("pageHist").style.display  = p==="hist"  ? "block" : "none";
  if(p==="hist") loadData();
}

function calc(){
  const n=Number($("nb").value);
  const b=num($("brut").value);
  const t=(T[$("type").value]||0)*n;
  $("tare").textContent=r1(t);
  $("net").textContent=r1(Math.max(0,b-t));
  $("warn").style.display=(b>0 && b<t)?"block":"none";
}
["input","change"].forEach(ev=>{
  $("type").addEventListener(ev,calc);
  $("nb").addEventListener(ev,calc);
  $("brut").addEventListener(ev,calc);
});

async function save(){
  try{
    calc();
    const n=Number($("nb").value);
    const b=num($("brut").value);
    const t=(T[$("type").value]||0)*n;
    if(b<=0) return alert("Entre un brut.");
    if(b<t) return alert("Brut < tare.");

    const p=$("pin").value.trim();
    if(!p) return alert("Entre le PIN.");

    setStatus("Connexion‚Ä¶");
    const { error: e1 } = await supabase.auth.signInWithPassword({
      email:"comptoir@sirmet.local",
      password:p
    });
    if(e1) throw e1;

    setStatus("Insertion‚Ä¶");
    const { error: e2 } = await supabase.from("pesees").insert({
      ville:$("ville").value,
      type:A[$("type").value],
      nb:n,
      brut:r1(b),
      tare:r1(t),
      net:r1(b-t)
    });
    if(e2) throw e2;

    $("brut").value=""; $("pin").value=""; calc();
    setStatus("‚úÖ Enregistr√©. Je charge l‚Äôhistorique‚Ä¶");
    await loadData();
    show("hist");
  }catch(err){
    setStatus("‚ùå ERREUR:\n" + (err?.message || String(err)));
  }
}

async function loadData(){
  try{
    setStatus("Chargement historique‚Ä¶");
    const { data, error } = await supabase
      .from("pesees")
      .select("created_at, ville, type, nb, net")
      .order("created_at", { ascending:false })
      .limit(300);

    if(error) throw error;

    setStatus("‚úÖ Lignes re√ßues : " + (data?.length || 0));
    const tb=$("hist");
    tb.innerHTML="";
    if(!data || data.length===0){
      tb.innerHTML="<tr><td colspan='5'>Aucune donn√©e</td></tr>";
      return;
    }
    data.forEach(e=>{
      tb.innerHTML += `<tr>
        <td>${new Date(e.created_at).toLocaleString()}</td>
        <td>${e.ville}</td>
        <td>${e.type}</td>
        <td>${e.nb}</td>
        <td class="right">${e.net}</td>
      </tr>`;
    });
  }catch(err){
    setStatus("‚ùå ERREUR HISTORIQUE:\n" + (err?.message || String(err)));
  }
}

async function testCount(){
  try{
    setStatus("Test DB‚Ä¶");
    const { count, error } = await supabase
      .from("pesees")
      .select("*", { count:"exact", head:true });
    if(error) throw error;
    setStatus("‚úÖ COUNT Supabase = " + count);
  }catch(err){
    setStatus("‚ùå TEST DB:\n" + (err?.message || String(err)));
  }
}

calc();
</script>
</body>
</html>
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pes√©e</title>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:900px;margin:auto;padding:18px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:10px 0 6px;font-size:12px;color:#a8b3d6}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
button{width:100%;padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
.big{font-size:34px;font-weight:900}
.net{margin-top:14px;padding:14px;border:1px solid #222634;border-radius:14px;background:#0f1118}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}
.col-2{grid-column:span 2}
.col-6{grid-column:span 6}
.col-12{grid-column:span 12}
@media(max-width:760px){.col-4,.col-2,.col-6{grid-column:span 12}}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #222634;vertical-align:middle}
th{font-size:12px;color:#a8b3d6}
.smallBtn{width:auto;padding:6px 10px;border-radius:10px;font-size:12px}
.danger{background:#8b0000;border-color:#5c0000}
.warn{margin-top:8px;color:#ffcc66;font-size:12px;display:none}
</style>
</head>

<body>

<!-- üîê √âCRAN PIN -->
<div id="login" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
  <div class="card" style="max-width:320px;width:100%">
    <h2 style="text-align:center">Code PIN</h2>
    <input id="pinInput" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button id="pinBtn">ENTRER</button>
    <div id="errPin" style="display:none;color:#ff5a6a;text-align:center;margin-top:10px">
      Code incorrect
    </div>
  </div>
</div>

<!-- üßÆ APPLICATION -->
<div id="app" style="display:none">
<div class="wrap">
<div class="card">

<h2>Pes√©e</h2>

<div class="grid">
  <div class="col-4">
    <label>Ville</label>
    <select id="ville">
      <option>Boulanger Tarbes</option>
      <option>Pau</option>
      <option>Envie</option>
      <option>Assat</option>
      <option>Coaraze</option>
      <option>Espoey</option>
    </select>
  </div>

  <div class="col-4">
    <label>Type de bac</label>
    <select id="type">
      <option value="PAM">PAM</option>
      <option value="ASL">ASL</option>
      <option value="ABJ">ABJ</option>
      <option value="FRIGO">Frigo</option>
      <option value="HF">Hors froid</option>
    </select>
  </div>

  <div class="col-2">
    <label>Nombre</label>
    <select id="nb">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>
  </div>

  <div class="col-2">
    <label>Poids brut (kg)</label>
    <input id="brut" type="number" step="0.1" value="" placeholder="Ex : 120.5">
  </div>

  <div class="col-12">
    <div class="net">
      <div>Tare : <b id="tare">0</b> kg</div>
      <div class="big">Net : <span id="net">0</span> kg</div>
      <div id="warn" class="warn">‚ö†Ô∏è Brut inf√©rieur √† la tare : net forc√© √† 0 (enregistrement bloqu√©)</div>
    </div>
  </div>

  <div class="col-6"><button id="saveBtn">ENREGISTRER</button></div>
  <div class="col-6"><button id="resetBtn">R√âINITIALISER</button></div>
</div>

<h3>Historique (local)</h3>
<button id="clearAllBtn" class="danger">VIDER L‚ÄôHISTORIQUE</button>

<table>
  <thead>
    <tr>
      <th>Date</th><th>Ville</th><th>Type</th><th>Nb</th><th>Net</th><th></th>
    </tr>
  </thead>
  <tbody id="hist"></tbody>
</table>

</div>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const PIN = "2580";          // üîê change si tu veux
const KEY = "pesee_hist_v1"; // stockage local
/* ========================================= */

const $ = (id)=>document.getElementById(id);

const T = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const AFF = { PAM:"PAM", ASL:"ASL", ABJ:"ABJ", FRIGO:"F", HF:"HF" };

const r1 = (x)=> Math.round(x*10)/10;
const num = (x)=> {
  const v = Number(String(x).replace(",", "."));
  return Number.isFinite(v) ? v : 0;
};

function checkPin(){
  if ($("pinInput").value === PIN){
    $("login").style.display="none";
    $("app").style.display="block";
    render();
  } else {
    $("errPin").style.display="block";
  }
}

function calc(){
  const n = Number($("nb").value);
  const b = num($("brut").value);
  const t = (T[$("type").value] || 0) * n;
  $("tare").textContent = r1(t);

  let nnet = b - t;
  const neg = nnet < 0;
  if (neg) nnet = 0;

  $("net").textContent = r1(nnet);
  $("warn").style.display = (neg && b>0) ? "block" : "none";
}

function load(){
  try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
  catch { return []; }
}
function store(arr){
  localStorage.setItem(KEY, JSON.stringify(arr));
}

function render(){
  const data = load().slice().reverse();
  const tb = $("hist");
  tb.innerHTML = "";

  if(data.length === 0){
    tb.innerHTML = `<tr><td colspan="6" style="color:#a8b3d6">Aucune pes√©e</td></tr>`;
    return;
  }

  for(const e of data){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.ville}</td>
      <td>${e.type}</td>
      <td>${e.nb}</td>
      <td><b>${e.net}</b></td>
      <td><button class="smallBtn danger" data-del="${e.id}">X</button></td>
    `;
    tb.appendChild(tr);
  }
}

function save(){
  calc();
  const n = Number($("nb").value);
  const b = num($("brut").value);
  const t = (T[$("type").value] || 0) * n;
  const nnet = b - t;

  if (b <= 0) { alert("Entre un poids brut."); return; }
  if (b < t)  { alert("Brut inf√©rieur √† la tare. Corrige le brut."); return; }

  const entry = {
    id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random()),
    date: new Date().toLocaleString(),
    ville: $("ville").value,
    type: AFF[$("type").value],
    nb: n,
    net: r1(nnet)
  };

  const arr = load();
  arr.push(entry);
  store(arr);
  render();
  resetForm(false);
}

function resetForm(){
  $("type").value = "PAM";
  $("nb").value = "1";
  $("brut").value = "";
  calc();
}

function clearAll(){
  if(confirm("Vider tout l‚Äôhistorique ?")){
    localStorage.removeItem(KEY);
    render();
  }
}

/* events */
$("pinBtn").addEventListener("click", checkPin);
$("pinInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") checkPin(); });

["input","change"].forEach(ev=>{
  $("type").addEventListener(ev, calc);
  $("nb").addEventListener(ev, calc);
  $("brut").addEventListener(ev, calc);
});

$("saveBtn").addEventListener("click", save);
$("resetBtn").addEventListener("click", resetForm);
$("clearAllBtn").addEventListener("click", clearAll);

$("hist").addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-del]");
  if(!btn) return;
  const id = btn.getAttribute("data-del");
  if(!confirm("Supprimer cette pes√©e ?")) return;
  const arr = load().filter(x=>x.id!==id);
  store(arr);
  render();
});

calc();
</script>

</body>
</html>
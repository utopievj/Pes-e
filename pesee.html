<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pesée</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===== BASE ===== */
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#0b0c10;
  color:#ffffff;
}
.container{
  max-width:900px;
  margin:auto;
  padding:16px;
}
.card{
  background:#12141b;
  border-radius:16px;
  padding:16px;
}
.hidden{display:none}

/* ===== TEXTE ===== */
h1,h2,h3,label,th,td{
  color:#ffffff !important;
}
small,.muted,.hint,.description{
  display:none !important;
}

/* ===== FORM ===== */
label{
  display:block;
  margin-bottom:4px;
  font-size:14px;
}
input,select{
  width:100%;
  padding:14px;
  font-size:18px;
  border-radius:12px;
  border:1px solid #333;
  background:#0f1118;
  color:#ffffff;
}

/* ===== BOUTONS ===== */
button{
  padding:16px;
  font-size:18px;
  font-weight:800;
  border-radius:14px;
  border:none;
  background:#b22222;
  color:#ffffff;
}
button:active{background:#d32f2f}
.btn-row{display:flex;gap:8px;flex-wrap:wrap}
.small{padding:10px 14px;font-size:14px}

/* ===== PESÉE ===== */
.net{
  font-size:46px;
  font-weight:900;
  margin:12px 0;
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #222;
}
th{text-align:left}
.right{text-align:right}

/* ===== LOGIN ===== */
#loginMsg{
  margin-top:10px;
  color:#ffb347;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="container">
  <div class="card">
    <h2>Connexion</h2>

    <label>Email</label>
    <input id="email" type="email">

    <label>Mot de passe</label>
    <input id="password" type="password">

    <br>
    <button onclick="login()">SE CONNECTER</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="container hidden">
  <div class="card">

    <div class="btn-row">
      <button class="small" onclick="showPage('pesee')">PESÉE</button>
      <button class="small" onclick="showPage('hist')">HISTORIQUE</button>
      <button class="small" onclick="logout()">DÉCONNEXION</button>
    </div>

    <!-- PESÉE -->
    <div id="pagePesee">
      <label>Ville</label>
      <select id="ville"></select>

      <label>Type</label>
      <select id="type">
        <option value="PAM">PAM</option>
        <option value="ASL">ASL</option>
        <option value="ABJ">ABJ</option>
        <option value="F">F</option>
        <option value="HF">HF</option>
      </select>

      <label>Nombre</label>
      <select id="nb">
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
      </select>

      <label>Poids brut (kg)</label>
      <input id="brut" type="number" step="0.1">

      <div class="net">Net : <span id="net">0</span> kg</div>

      <button onclick="enregistrer()">ENREGISTRER</button>
    </div>

    <!-- HISTORIQUE -->
    <div id="pageHist" class="hidden">
      <h2>Historique</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Ville</th>
            <th>Type</th>
            <th class="right">Net</th>
          </tr>
        </thead>
        <tbody id="hist"></tbody>
      </table>
    </div>

  </div>
</div>

<script>
/* ===== SUPABASE ===== */
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0"
);

const TARE={PAM:59,ASL:45,ABJ:43,F:0,HF:0};
const $=id=>document.getElementById(id);

/* ===== NAV ===== */
function showPage(p){
  $("pagePesee").classList.toggle("hidden",p!=="pesee");
  $("pageHist").classList.toggle("hidden",p!=="hist");
  if(p==="hist") loadHist();
}

/* ===== CALCUL ===== */
function calc(){
  const nb=+$("nb").value||0;
  const brut=+$("brut").value||0;
  const t=TARE[$("type").value]*nb;
  $("net").textContent=Math.max(0,brut-t).toFixed(1);
}
["change","input"].forEach(e=>{
  $("nb").addEventListener(e,calc);
  $("type").addEventListener(e,calc);
  $("brut").addEventListener(e,calc);
});

/* ===== SAVE ===== */
async function enregistrer(){
  calc();
  await supabase.from("pesees").insert({
    ville:$("ville").value,
    type:$("type").value,
    nb:+$("nb").value,
    brut:+$("brut").value,
    net:+$("net").textContent
  });
  $("brut").value="";
  calc();
}

/* ===== HIST ===== */
async function loadHist(){
  const {data}=await supabase
    .from("pesees")
    .select("*")
    .order("created_at",{ascending:false})
    .limit(200);

  $("hist").innerHTML=(data||[]).map(r=>`
    <tr>
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.ville}</td>
      <td>${r.type}</td>
      <td class="right">${r.net}</td>
    </tr>
  `).join("");
}

/* ===== LOGIN ===== */
async function login(){
  const msg=$("loginMsg");
  msg.textContent="Connexion…";
  const {error}=await supabase.auth.signInWithPassword({
    email:$("email").value,
    password:$("password").value
  });
  if(error){msg.textContent=error.message;return;}
  $("loginScreen").classList.add("hidden");
  $("app").classList.remove("hidden");
  loadVilles();
}

/* ===== LOGOUT ===== */
async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

/* ===== VILLES ===== */
async function loadVilles(){
  const {data}=await supabase.from("villes").select("nom").order("nom");
  $("ville").innerHTML=(data||[]).map(v=>`<option>${v.nom}</option>`).join("");
}

/* ===== AUTO ===== */
(async()=>{
  const {data}=await supabase.auth.getUser();
  if(data?.user){
    $("loginScreen").classList.add("hidden");
    $("app").classList.remove("hidden");
    loadVilles();
  }
})();
</script>
</body>
</html>
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pesée</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#fff}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border-radius:16px;padding:16px}
button{padding:14px;border-radius:12px;border:none;background:#b22222;color:#fff;font-weight:800}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #333;background:#0f1118;color:#fff}
.smallBtn{padding:10px;font-size:12px}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center}
.badge{background:#222;padding:6px 10px;border-radius:999px;font-size:12px}
#status{margin-top:10px;color:#ffd27a;white-space:pre-wrap}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card" style="max-width:420px;width:100%">
    <h2>Connexion</h2>

    <label>Email</label>
    <input id="email" type="email">

    <label>Mot de passe</label>
    <input id="password" type="password">

    <button onclick="login()">SE CONNECTER</button>
    <button style="margin-top:10px;background:#8b0000" onclick="resetCache()">RESET CACHE</button>

    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="smallBtn" onclick="show('pesee')">PESÉE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="show('trie')">TRIE</button>
        <button class="smallBtn" onclick="logout()">Déconnexion</button>
        <span class="badge" id="badgeUser">—</span>
        <span class="badge" id="badgeNet">Réseau ?</span>
      </div>

      <div id="status">Prêt.</div>

      <!-- PESÉE -->
      <div id="pagePesee">
        <h2>Pesée</h2>

        <label>Ville</label>
        <input id="ville">

        <label>Type</label>
        <select id="type">
          <option value="PAM">PAM</option>
          <option value="ASL">ASL</option>
          <option value="ABJ">ABJ</option>
        </select>

        <label>Nb bacs</label>
        <input id="nb" type="number" value="1">

        <label>Brut (kg)</label>
        <input id="brut" type="number">

        <h2>Net : <span id="net">0</span> kg</h2>

        <button onclick="saveSafe()">ENREGISTRER</button>
      </div>

      <div id="pageHist" style="display:none"><h2>Historique</h2></div>
      <div id="pageTrie" style="display:none"><h2>Trie</h2></div>

    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";

const $ = id => document.getElementById(id);
const TARES = { PAM:59, ASL:45, ABJ:43 };

function setStatus(t){ $("status").textContent=t||""; }
function setLoginMsg(t){ $("loginMsg").textContent=t||""; }

/* ================= ERREURS VISIBLES ================= */
function showError(msg){
  let e=document.getElementById("globalError");
  if(!e){
    e=document.createElement("div");
    e.id="globalError";
    e.style="position:fixed;bottom:10px;left:10px;right:10px;background:#8b0000;color:#fff;padding:12px;border-radius:12px;z-index:9999";
    document.body.appendChild(e);
  }
  e.textContent="❌ "+msg;
}

window.onerror=(m)=>showError(m);
window.onunhandledrejection=(e)=>showError(e.reason?.message||e.reason);

/* ================= SUPABASE ================= */
let supabase=null;
setTimeout(()=>{
  if(!window.supabase){
    showError("Supabase ne charge pas (réseau / DNS / bloqueur)");
  }else{
    supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
  }
},2000);
/* ================= UI ================= */
function show(p){
  $("pagePesee").style.display=p==="pesee"?"block":"none";
  $("pageHist").style.display=p==="hist"?"block":"none";
  $("pageTrie").style.display=p==="trie"?"block":"none";
}

function calc(){
  const nb=Number($("nb").value)||1;
  const brut=Number($("brut").value)||0;
  const tare=(TARES[$("type").value]||0)*nb;
  $("net").textContent=Math.max(0,brut-tare);
}
["nb","brut","type"].forEach(id=>$(id).oninput=calc);

/* ================= AUTH ================= */
async function login(){
  try{
    if(!supabase) throw "Supabase non prêt";
    setLoginMsg("Connexion...");
    const {error}=await supabase.auth.signInWithPassword({
      email:$("email").value,
      password:$("password").value
    });
    if(error) throw error.message;

    const {data}=await supabase.auth.getUser();
    $("badgeUser").textContent=data.user.email;
    $("loginScreen").style.display="none";
    $("app").style.display="block";
    refreshNetwork();
  }catch(e){
    setLoginMsg("❌ "+e);
    showError(e);
  }
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

/* ================= SAVE ================= */
async function saveSafe(){
  try{
    if(!supabase) throw "Supabase non prêt";
    calc();
    const payload={
      ville:$("ville").value,
      type:$("type").value,
      nb:Number($("nb").value),
      net:Number($("net").textContent),
      operator:(await supabase.auth.getUser()).data.user.email
    };
    const {error}=await supabase.from("pesees").insert(payload);
    if(error) throw error.message;
    setStatus("✅ Enregistré");
  }catch(e){
    showError(e);
  }
}

/* ================= UTILS ================= */
function resetCache(){
  localStorage.clear();
  location.reload();
}

function refreshNetwork(){
  $("badgeNet").textContent="Réseau : "+(navigator.onLine?"OK":"HORS-LIGNE");
}
window.addEventListener("online",refreshNetwork);
window.addEventListener("offline",refreshNetwork);

</script>
</body>
</html>
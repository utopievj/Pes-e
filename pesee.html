<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>PesÃ©e</title>

<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px;color:#ffffff}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
.smallBtn{padding:10px 12px;font-size:12px}
.danger{background:#8b0000;border-color:#5c0000}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:820px){.col-4,.col-3,.col-2,.col-6{grid-column:span 12}}
.big{font-size:34px;font-weight:900;margin:8px 0}
.badge{display:inline-block;padding:4px 10px;border:1px solid #222634;border-radius:999px;font-size:12px;color:#ffffff}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
th{font-size:12px;color:#ffffff;text-align:left}
.right{text-align:right}
.center{min-height:90vh;display:flex;align-items:center;justify-content:center}
.max420{max-width:420px;width:100%}
hr{border:0;border-top:1px solid #222634;margin:14px 0}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card max420">
    <h2>Connexion</h2>
    <label>Email</label>
    <input id="email" type="email">
    <label>Mot de passe</label>
    <input id="password" type="password">
    <button onclick="login()">SE CONNECTER</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="smallBtn" onclick="show('pesee')">PESÃ‰E</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="loadData()">ðŸ”„</button>
        <button class="smallBtn" onclick="syncPending()">âŸ³ (<span id="pendingCount">0</span>)</button>
        <button class="smallBtn" onclick="logout()">ðŸšª</button>
        <span class="badge" id="badgeUser"></span>
        <span class="badge" id="badgeAdmin"></span>
      </div>

      <!-- PAGE PESÃ‰E -->
      <div id="pagePesee">
        <h2>PesÃ©e</h2>

        <div class="grid">
          <div class="col-4">
            <label>Ville</label>
            <select id="ville"></select>
          </div>

          <div class="col-4">
            <label>Type</label>
            <select id="type">
              <option value="PAM">PAM</option>
              <option value="ASL">ASL</option>
              <option value="ABJ">ABJ</option>
              <option value="FRIGO">F</option>
              <option value="HF">HF</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nb</label>
            <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>

          <div class="col-2">
            <label>Brut</label>
            <input id="brut" type="number" step="0.1">
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="net">0</span> kg</div>
            <button onclick="saveSafe()">ENREGISTRER</button>
          </div>
        </div>
      </div>

      <!-- PAGE HISTORIQUE -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Ville</th><th>Type</th>
                <th class="right">Nb</th><th class="right">Net</th>
              </tr>
            </thead>
            <tbody id="histMix"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "TA_CLE_ANON"
);

function show(p){
  pagePesee.style.display = p==='pesee'?'block':'none';
  pageHist.style.display = p==='hist'?'block':'none';
}

async function login(){
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if(error) loginMsg.textContent = error.message;
  else location.reload();
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function loadData(){
  const { data } = await supabase.from("pesees")
    .select("*")
    .order("created_at",{ascending:false});
  histMix.innerHTML="";
  (data||[]).forEach(r=>{
    histMix.innerHTML+=`
      <tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.ville}</td>
        <td>${r.type}</td>
        <td class="right">${r.nb}</td>
        <td class="right">${r.net}</td>
      </tr>`;
  });
}

(async()=>{
  const { data } = await supabase.auth.getUser();
  if(data?.user){
    loginScreen.style.display="none";
    app.style.display="block";
    badgeUser.textContent=data.user.email;
    loadData();
  }
})();
</script>

</body>
</html>
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pes√©e</title>

<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:1100px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:13px}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800}
button:hover{background:#d32f2f}
.smallBtn{padding:8px 12px;font-size:12px}
.danger{background:#8b0000}
.badge{padding:4px 10px;border-radius:999px;border:1px solid #333;font-size:12px}
.tableWrap{overflow:auto;border:1px solid #222;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222;text-align:left}
.right{text-align:right}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center}
#status,#loginMsg{white-space:pre-wrap;font-size:12px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card" style="max-width:420px;width:100%">
    <h2>Connexion</h2>

    <label>Email</label>
    <input id="email" type="email">

    <label>Mot de passe</label>
    <input id="password" type="password">

    <div style="margin-top:12px;display:grid;gap:8px">
      <button onclick="login()">SE CONNECTER</button>
      <button class="smallBtn danger" onclick="resetTotal()">RESET CACHE</button>
    </div>

    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="smallBtn" onclick="show('pesee')">PES√âE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="show('trie')">TRIE</button>
        <button class="smallBtn" onclick="logout()">üö™</button>
        <span class="badge" id="badgeUser">‚Äî</span>
        <span class="badge" id="badgeNet">‚Äî</span>
      </div>

      <div id="status"></div>

      <!-- PAGE PES√âE -->
      <div id="pagePesee">
        <h2>Pes√©e</h2>

        <label>Ville</label>
        <input id="ville">

        <label>Type</label>
        <select id="type">
          <option>PAM</option>
          <option>ASL</option>
          <option>ABJ</option>
        </select>

        <label>Brut (kg)</label>
        <input id="brut" type="number" inputmode="decimal">

        <button onclick="savePesee()">ENREGISTRER</button>
      </div>

      <!-- PAGE HISTORIQUE -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Ville</th>
                <th>Type</th>
                <th class="right">Net</th>
                <th>Op√©rateur</th>
              </tr>
            </thead>
            <tbody id="histTable"></tbody>
          </table>
        </div>
      </div>

      <!-- PAGE TRIE -->
      <div id="pageTrie" style="display:none">
        <h2>Trie</h2>

        <h3>PAM</h3>
        <button onclick="addTrie('pam',1)">+1</button>
        <button class="danger" onclick="addTrie('pam',-1)">-1</button>

        <h3>ASL</h3>
        <button onclick="addTrie('asl',1)">+1</button>
        <button class="danger" onclick="addTrie('asl',-1)">-1</button>

        <div class="tableWrap">
          <table>
            <thead><tr><th>Date</th><th>Cat√©gorie</th><th class="right">Œî</th></tr></thead>
            <tbody id="trieTable"></tbody>;
          </table>
        </div>
      </div>

    </div>
  </div>
</div>
<script>
/* ========= CONFIG SUPABASE ========= */
const SUPABASE_URL = "https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";

/* ========= HELPERS ========= */
const $ = (id)=>document.getElementById(id);
const r1 = (x)=>Math.round(x*10)/10;
const num = (x)=>{ const v=Number(String(x).replace(",", ".")); return Number.isFinite(v)?v:0; };

function setStatus(msg){ const el=$("status"); if(el) el.textContent = msg || ""; }
function setLoginMsg(msg){ const el=$("loginMsg"); if(el) el.textContent = msg || ""; }
function refreshNetwork(){
  const el=$("badgeNet");
  if(el) el.textContent = "R√©seau : " + (navigator.onLine ? "OK" : "HORS-LIGNE");
}

/* ========= BANDEAU / DIAGNOSTIC ========= */
function showDiag(title, details){
  const msg = `‚ùå ${title}\n\n${details || ""}\n\nActions:\n- Clique RESET CACHE\n- Ouvre le lien en ajoutant ?v=${Date.now()}\n- V√©rifie que l'heure/date du t√©l√©phone est correcte\n- D√©sactive VPN / DNS priv√© / bloqueur`;
  setLoginMsg(msg);
}

/* ========= SAFETY: SDK SUPABASE ========= */
function ensureSupabaseSDK(){
  if(!window.supabase){
    showDiag(
      "Supabase SDK non charg√©",
      "Cause fr√©quente: r√©seau qui bloque jsdelivr / cache PWA / DNS priv√© / bloqueur.\n\nTest: ouvre https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2 dans le navigateur."
    );
    return false;
  }
  return true;
}

/* ========= INIT CLIENT ========= */
let sb = null;
function initClient(){
  if(!ensureSupabaseSDK()) return null;
  if(sb) return sb;

  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storage: window.localStorage
    }
  });
  return sb;
}

/* ========= CACHE KEYS ========= */
const PENDING_PES_KEY = "pesees_pending_v1";
const CACHE_PES_KEY   = "pesees_cache_v1";
const TRIE_PENDING_KEY = "trie_pending_v1";
const TRIE_CACHE_KEY   = "trie_cache_v1";

/* ========= RESET ========= */
function resetTotal(){
  try{
    localStorage.removeItem(PENDING_PES_KEY);
    localStorage.removeItem(CACHE_PES_KEY);
    localStorage.removeItem(TRIE_PENDING_KEY);
    localStorage.removeItem(TRIE_CACHE_KEY);
  }catch{}
  // hard reload to bypass PWA cache
  location.href = location.pathname + "?v=" + Date.now();
}

/* ========= UI NAV ========= */
function show(p){
  $("pagePesee").style.display = (p==="pesee") ? "block" : "none";
  $("pageHist").style.display  = (p==="hist")  ? "block" : "none";
  $("pageTrie").style.display  = (p==="trie")  ? "block" : "none";

  if(p==="hist") loadAll();
  if(p==="trie") loadTrieUI();
}

/* ========= LOCAL DATA ========= */
function getJSON(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch{ return fallback; }
}
function setJSON(key, v){ localStorage.setItem(key, JSON.stringify(v)); }

function addPendingPes(row){
  const arr = getJSON(PENDING_PES_KEY, []);
  arr.unshift(row);
  setJSON(PENDING_PES_KEY, arr);
}
function removePendingPes(client_id){
  const arr = getJSON(PENDING_PES_KEY, []).filter(x=>x.client_id!==client_id);
  setJSON(PENDING_PES_KEY, arr);
}

/* ========= PES√âE ========= */
function tareFor(type){
  const t = String(type||"").toUpperCase();
  if(t==="PAM") return 59;
  if(t==="ASL") return 45;
  if(t==="ABJ") return 43;
  return 0;
}

async function savePesee(){
  const client = initClient();
  if(!client) return;

  const ville = ($("ville").value || "").trim();
  const type = ($("type").value || "").trim();
  const brut = num($("brut").value);
  if(!ville) return alert("Ville obligatoire");
  if(!type) return alert("Type obligatoire");
  if(brut<=0) return alert("Brut incorrect");

  const tare = tareFor(type);
  const net = Math.max(0, brut - tare);

  const { data: ures, error: uerr } = await client.auth.getUser();
  if(uerr || !ures?.user){
    showDiag("Session invalide", "Tu sembles d√©connect√©. Reconnecte-toi.");
    return;
  }

  const operator = ures.user.email || "‚Äî";
  const client_id = "p_" + Date.now() + "_" + Math.random().toString(16).slice(2);

  const payload = { client_id, ville, type, brut: r1(brut), tare: r1(tare), net: r1(net), operator };

  try{
    if(!navigator.onLine) throw new Error("offline");

    const { error } = await client.from("pesees").insert(payload);
    if(error) throw error;

    $("brut").value = "";
    setStatus("‚úÖ Pes√©e enregistr√©e");
    await loadAll();
    show("hist");
  }catch(e){
    addPendingPes({ ...payload, local_created_at: Date.now() });
    setStatus("‚ö†Ô∏è Hors-ligne / erreur: enregistr√© EN ATTENTE");
    await loadAll();
    show("hist");
  }
}

async function syncPeseePending(){
  const client = initClient();
  if(!client) return;

  if(!navigator.onLine) return;

  const pend = getJSON(PENDING_PES_KEY, []);
  if(!pend.length) return;

  const { data: ures } = await client.auth.getUser();
  if(!ures?.user) return;

  const toSend = [...pend].reverse();
  for(const row of toSend){
    try{
      // upsert by client_id if you created unique constraint
      const { error } = await client.from("pesees").upsert(row, { onConflict: "client_id" });
      if(error) throw error;
      removePendingPes(row.client_id);
    }catch{
      break;
    }
  }
}

/* ========= TRIE (+1/-1 PAM/ASL) ========= */
function addPendingTrie(row){
  const arr = getJSON(TRIE_PENDING_KEY, []);
  arr.unshift(row);
  setJSON(TRIE_PENDING_KEY, arr);
}
function removePendingTrie(client_id){
  const arr = getJSON(TRIE_PENDING_KEY, []).filter(x=>x.client_id!==client_id);
  setJSON(TRIE_PENDING_KEY, arr);
}

async function addTrie(cat, delta){
  if(delta!==1 && delta!==-1) return;
  const client = initClient();
  if(!client) return;

  const { data: ures, error: uerr } = await client.auth.getUser();
  if(uerr || !ures?.user){
    showDiag("Session invalide", "Reconnecte-toi.");
    return;
  }

  const operator = ures.user.email || "‚Äî";
  const client_id = "t_" + cat + "_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  const payload = { client_id, category: cat, delta, operator };

  try{
    if(!navigator.onLine) throw new Error("offline");

    const { error } = await client.from("trie").insert(payload);
    if(error) throw error;

    setStatus("‚úÖ Trie enregistr√©");
    await loadTrieUI();
  }catch(e){
    addPendingTrie({ ...payload, local_created_at: Date.now() });
    setStatus("‚ö†Ô∏è Hors-ligne / erreur: trie EN ATTENTE");
    await loadTrieUI();
  }
}

async function syncTriePending(){
  const client = initClient();
  if(!client) return;
  if(!navigator.onLine) return;

  const pend = getJSON(TRIE_PENDING_KEY, []);
  if(!pend.length) return;

  const toSend = [...pend].reverse();
  for(const row of toSend){
    try{
      const { error } = await client.from("trie").upsert(row, { onConflict: "client_id" });
      if(error) throw error;
      removePendingTrie(row.client_id);
    }catch{
      break;
    }
  }
}

/* ========= LOAD + RENDER ========= */
function renderHist(rows){
  const tb = $("histTable");
  tb.innerHTML = "";
  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="5">Aucune donn√©e</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${new Date(r.created_at || r.local_created_at || Date.now()).toLocaleString()}</td>
      <td>${r.ville||"‚Äî"}</td>
      <td>${r.type||"‚Äî"}</td>
      <td class="right"><b>${r.net ?? "‚Äî"}</b></td>
      <td>${r.operator||"‚Äî"}</td>
    </tr>
  `).join("");
}

function renderTrie(rows){
  const tb = $("trieTable");
  tb.innerHTML = "";
  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="3">Aucune donn√©e</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${new Date(r.created_at || r.local_created_at || Date.now()).toLocaleString()}</td>
      <td>${String(r.category||"").toUpperCase()}</td>
      <td class="right"><b>${r.delta>0?("+"+r.delta):r.delta}</b></td>
    </tr>
  `).join("");
}

async function loadAll(){
  const client = initClient();
  if(!client) return;

  refreshNetwork();

  // sync pending first
  await syncPeseePending();
  await syncTriePending();

  // load pes√©es
  let live = [];
  try{
    const { data, error } = await client.from("pesees").select("*").order("created_at",{ ascending:false }).limit(300);
    if(error) throw error;
    live = data || [];
    setJSON(CACHE_PES_KEY, live);
  }catch{
    live = getJSON(CACHE_PES_KEY, []);
  }

  const pend = getJSON(PENDING_PES_KEY, []).map(p=>({
    ...p,
    created_at: new Date(p.local_created_at).toISOString()
  }));

  const merged = [...pend, ...live].sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  renderHist(merged);

  await loadTrieUI();
}

async function loadTrieUI(){
  const client = initClient();
  if(!client) return;

  let live = [];
  try{
    const { data, error } = await client.from("trie").select("*").order("created_at",{ ascending:false }).limit(500);
    if(error) throw error;
    live = data || [];
    setJSON(TRIE_CACHE_KEY, live);
  }catch{
    live = getJSON(TRIE_CACHE_KEY, []);
  }

  const pend = getJSON(TRIE_PENDING_KEY, []).map(p=>({
    ...p,
    created_at: new Date(p.local_created_at).toISOString()
  }));

  const merged = [...pend, ...live].sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  renderTrie(merged);
}

/* ========= AUTH ========= */
async function login(){
  const client = initClient();
  if(!client) return;

  refreshNetwork();

  const email = ($("email").value || "").trim();
  const password = ($("password").value || "");

  if(!email || !password){
    setLoginMsg("‚ùå Email + mot de passe obligatoires");
    return;
  }

  setLoginMsg("Connexion‚Ä¶");

  try{
    const { data, error } = await client.auth.signInWithPassword({ email, password });
    if(error) throw error;

    if(!data?.user){
      showDiag("Connexion impossible", "R√©ponse Supabase: user=null\n\nCause fr√©quente: session/cookies bloqu√©s.");
      return;
    }

    $("badgeUser").textContent = "Connect√© : " + (data.user.email || "‚Äî");
    $("loginScreen").style.display = "none";
    $("app").style.display = "block";
    setLoginMsg("");
    setStatus("‚úÖ Connect√©");

    await loadAll();
    show("pesee");
  }catch(e){
    // message d√©taill√© (tr√®s important)
    const errTxt = (e?.message || String(e) || "Erreur inconnue");
    showDiag("Erreur de connexion", errTxt);
  }
}

async function logout(){
  const client = initClient();
  if(!client) return;
  try{
    await client.auth.signOut();
  }catch{}
  location.reload();
}

/* ========= AUTO INIT ========= */
window.addEventListener("online", async ()=>{
  refreshNetwork();
  await loadAll();
});
window.addEventListener("offline", refreshNetwork);

(async ()=>{
  refreshNetwork();

  // si SDK bloqu√©, on affiche direct
  if(!ensureSupabaseSDK()) return;

  const client = initClient();
  try{
    const { data } = await client.auth.getUser();

    if(data?.user){
      $("badgeUser").textContent = "Connect√© : " + (data.user.email || "‚Äî");
      $("loginScreen").style.display = "none";
      $("app").style.display = "block";
      await loadAll();
      show("pesee");
    }else{
      // pas connect√©
      $("loginScreen").style.display = "flex";
      $("app").style.display = "none";
    }
  }catch(e){
    showDiag("Impossible de v√©rifier la session", (e?.message||String(e)));
  }
})();

/* Service worker */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/Pes-e/sw.js");
}
</script>
</body>
</html>
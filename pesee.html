<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pes√©e</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#fff}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border-radius:16px;padding:16px;border:1px solid #222634}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
button.danger{background:#8b0000;border-color:#5c0000}
.smallBtn{padding:8px 10px;font-size:12px}
input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:800px){.col-4,.col-6{grid-column:span 12}}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
th{text-align:left;font-size:12px}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center}
.badge{font-size:12px;border:1px solid #222634;border-radius:999px;padding:4px 10px}
#status,#loginMsg{white-space:pre-wrap;color:#ffd27a;font-size:12px;margin-top:10px}
.big{font-size:28px;font-weight:900}
hr{border:0;border-top:1px solid #222634;margin:14px 0}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card" style="max-width:420px;width:100%">
    <h2 style="margin-top:0">Connexion</h2>

    <label>Email</label>
    <input id="email" type="email" autocomplete="username" placeholder="ex: nom@mail.com">

    <label>Mot de passe</label>
    <input id="password" type="password" autocomplete="current-password" placeholder="********">

    <div style="margin-top:12px;display:grid;gap:10px">
      <button onclick="login()">SE CONNECTER</button>
      <button class="danger smallBtn" onclick="resetCache()">RESET CACHE (si √ßa bloque)</button>
      <button class="smallBtn" onclick="diag()">DIAG</button>
    </div>

    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
        <button class="smallBtn" onclick="show('pesee')">PES√âE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="show('trie')">TRIE</button>
        <button class="smallBtn" onclick="refreshAll()">üîÑ Rafra√Æchir</button>
        <button class="smallBtn" onclick="logout()">üö™ D√©connexion</button>
        <span class="badge" id="badgeUser">‚Äî</span>
        <span class="badge" id="badgeAdmin">‚Äî</span>
        <span class="badge" id="badgeNet">R√©seau: ?</span>
      </div>

      <div id="status">Pr√™t.</div>

      <!-- PAGE PES√âE -->
      <div id="pagePesee">
        <h2>Pes√©e</h2>

        <div class="grid">
          <div class="col-4">
            <label>Ville</label>
            <input id="ville" placeholder="Ex: Toulouse">
          </div>

          <div class="col-4">
            <label>Type</label>
            <select id="type">
              <option value="PAM">PAM</option>
              <option value="ASL">ASL</option>
              <option value="ABJ">ABJ</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nb bacs</label>
            <input id="nb" type="number" inputmode="numeric" min="1" step="1" value="1">
          </div>

          <div class="col-2">
            <label>Brut (kg)</label>
            <input id="brut" type="number" inputmode="decimal" step="0.1" placeholder="Ex: 120.5">
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="net">0</span> kg</div>
          </div>

          <div class="col-12">
            <button onclick="savePesee()">ENREGISTRER</button>
          </div>
        </div>
      </div>

      <!-- PAGE HIST -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Ville</th><th>Type</th>
                <th class="right">Nb</th><th class="right">Net</th><th>Op√©rateur</th>
              </tr>
            </thead>
            <tbody id="histTable"></tbody>
          </table>
        </div>
      </div>

      <!-- PAGE TRIE -->
      <div id="pageTrie" style="display:none">
        <h2>Trie</h2>

        <h3>PAM tri√©</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
          <button onclick="addTrie('pam', +1)">+1</button>
          <button class="danger" onclick="addTrie('pam', -1)">-1</button>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+/-</th></tr></thead>
            <tbody id="pamTrieHist"></tbody>
          </table>
        </div>

        <hr>

        <h3>ASL tri√©</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
          <button onclick="addTrie('asl', +1)">+1</button>
          <button class="danger" onclick="addTrie('asl', -1)">-1</button>
        </div>
        <div class="tableWrap">
          <table>
            <thead><tr><th>Date/Heure</th><th class="right">+/-</th></tr></thead>
            <tbody id="aslTrieHist"></tbody>
          </table>
        </div>

      </div>

    </div>
  </div>
</div>
<script>
/* ========= CONFIG SUPABASE ========= */
const SUPABASE_URL = "https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";

const ADMIN_EMAIL = "boyrieanthony2@gmail.com";

/* ========= HELPERS ========= */
const $ = (id)=>document.getElementById(id);
const r1 = (x)=>Math.round(x*10)/10;
const num = (x)=>{ const v=Number(String(x).replace(",", ".")); return Number.isFinite(v)?v:0; };

function setStatus(msg){ const el=$("status"); if(el) el.textContent = msg || ""; }
function setLoginMsg(msg){ const el=$("loginMsg"); if(el) el.textContent = msg || ""; }
function refreshNetwork(){ const el=$("badgeNet"); if(el) el.textContent = "R√©seau: " + (navigator.onLine ? "OK" : "HORS-LIGNE"); }

window.addEventListener("online", refreshNetwork);
window.addEventListener("offline", refreshNetwork);

/* ========= SDK CHECK ========= */
document.addEventListener("DOMContentLoaded", ()=>{
  refreshNetwork();
  if(!window.supabase){
    setLoginMsg("‚ùå Supabase SDK non charg√©.\n\n‚û°Ô∏è Essaye:\n- RESET CACHE\n- vider cache Chrome\n- ouvrir avec ?v=999\n- d√©sactiver bloqueur / DNS");
  }
});

/* ========= CLIENT ========= */
const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

/* ========= STATE ========= */
let currentUser = null;

/* ========= NAV ========= */
function show(p){
  $("pagePesee").style.display = (p==="pesee") ? "block" : "none";
  $("pageHist").style.display  = (p==="hist")  ? "block" : "none";
  $("pageTrie").style.display  = (p==="trie")  ? "block" : "none";

  if(p==="hist") loadHistorique();
  if(p==="trie") loadTrie();
}

/* ========= LOGIN ========= */
async function login(){
  try{
    if(!supabase) return setLoginMsg("‚ùå Supabase non pr√™t (SDK non charg√©).");

    const email = $("email").value.trim();
    const password = $("password").value;

    if(!email || !password) return setLoginMsg("‚ùå Email + mot de passe.");

    setLoginMsg("Connexion‚Ä¶");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;

    const { data } = await supabase.auth.getUser();
    currentUser = data?.user || null;
    if(!currentUser) throw new Error("Utilisateur introuvable apr√®s connexion.");

    $("badgeUser").textContent = "Connect√©: " + (currentUser.email || "‚Äî");
    $("badgeAdmin").textContent = (currentUser.email === ADMIN_EMAIL) ? "ADMIN" : "USER";

    $("loginScreen").style.display = "none";
    $("app").style.display = "block";

    setLoginMsg("");
    setStatus("‚úÖ Connect√©");
    refreshNetwork();

    calc();
    await refreshAll();
    show("pesee");
  }catch(e){
    setLoginMsg("‚ùå " + (e?.message || String(e)));
  }
}

async function logout(){
  try{
    if(!supabase) return location.reload();
    await supabase.auth.signOut();
    location.reload();
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

/* ========= RESET CACHE ========= */
function resetCache(){
  try{
    localStorage.clear();
    setLoginMsg("‚úÖ Cache local supprim√©. Recharge la page.");
  }catch(e){
    setLoginMsg("‚ùå Reset cache: " + (e?.message || String(e)));
  }
}

/* ========= DIAG ========= */
async function diag(){
  const info = [];
  info.push("Online: " + navigator.onLine);
  info.push("Supabase SDK: " + (!!window.supabase));
  info.push("Supabase client: " + (!!supabase));
  try{
    localStorage.setItem("_t","1"); localStorage.removeItem("_t");
    info.push("LocalStorage: OK");
  }catch{ info.push("LocalStorage: KO"); }

  if(supabase){
    try{
      const { data } = await supabase.auth.getUser();
      info.push("Session user: " + (data?.user?.email || "NONE"));
    }catch(e){
      info.push("Session read error: " + (e?.message || String(e)));
    }
  }

  alert(info.join("\n"));
}
</script>
<script>
/* ========= TARES ========= */
const T = { PAM:59, ASL:45, ABJ:43 };

/* ========= CALC ========= */
function calc(){
  const nb = Math.max(1, Math.floor(num($("nb").value || 1)));
  $("nb").value = String(nb);

  const brut = num($("brut").value);
  const type = $("type").value;

  const tare = (T[type] || 0) * nb;
  const net = Math.max(0, brut - tare);

  $("net").textContent = r1(net);
}

/* listeners */
["input","change"].forEach(ev=>{
  $("type").addEventListener(ev, calc);
  $("nb").addEventListener(ev, calc);
  $("brut").addEventListener(ev, calc);
});

/* ========= SAVE PES√âE ========= */
async function savePesee(){
  try{
    if(!supabase) throw new Error("Supabase non pr√™t (SDK).");

    calc();

    const ville = ($("ville").value || "").trim();
    const type = $("type").value;
    const nb = Math.max(1, Math.floor(num($("nb").value || 1)));
    const brut = num($("brut").value);

    const tare = (T[type] || 0) * nb;
    const net = Math.max(0, brut - tare);

    if(!ville) return alert("Entre une ville.");
    if(brut <= 0) return alert("Entre un brut > 0.");
    if(brut < tare) return alert("Brut < tare.");

    const { data } = await supabase.auth.getUser();
    const operator = data?.user?.email || null;

    const payload = { ville, type, nb, brut: r1(brut), tare: r1(tare), net: r1(net), operator };

    setStatus("Insertion‚Ä¶");
    const { error } = await supabase.from("pesees").insert(payload);
    if(error) throw error;

    $("brut").value = "";
    calc();

    setStatus("‚úÖ Enregistr√©");
    await loadHistorique();
    show("pesee");
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
    alert("Erreur:\n" + (e?.message || String(e)));
  }
}

/* ========= HIST ========= */
async function loadHistorique(){
  try{
    if(!supabase) return;

    const { data, error } = await supabase
      .from("pesees")
      .select("created_at, ville, type, nb, net, operator")
      .order("created_at", { ascending:false })
      .limit(800);

    if(error) throw error;

    const tb = $("histTable");
    tb.innerHTML = "";

    if(!data || !data.length){
      tb.innerHTML = `<tr><td colspan="6">Aucune donn√©e</td></tr>`;
      return;
    }

    tb.innerHTML = data.map(r=>`
      <tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.ville || "‚Äî"}</td>
        <td>${r.type || "‚Äî"}</td>
        <td class="right">${r.nb ?? "‚Äî"}</td>
        <td class="right">${r.net ?? "‚Äî"}</td>
        <td>${r.operator || "‚Äî"}</td>
      </tr>
    `).join("");
  }catch(e){
    setStatus("‚ö†Ô∏è HIST: " + (e?.message || String(e)));
  }
}

/* ========= TRIE (PAM/ASL +1/-1) ========= */
async function addTrie(kind, delta){
  try{
    if(!supabase) throw new Error("Supabase non pr√™t (SDK).");
    if(delta !== 1 && delta !== -1) return;

    const { data } = await supabase.auth.getUser();
    const user_email = data?.user?.email || null;

    const payload = { kind, delta, user_email };

    setStatus("Trie‚Ä¶");
    const { error } = await supabase.from("trie_events").insert(payload);
    if(error) throw error;

    setStatus("‚úÖ Trie enregistr√©");
    await loadTrie();
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
    alert("Erreur trie:\n" + (e?.message || String(e)));
  }
}

async function loadTrie(){
  try{
    if(!supabase) return;

    const { data, error } = await supabase
      .from("trie_events")
      .select("created_at, kind, delta")
      .order("created_at", { ascending:false })
      .limit(500);

    if(error) throw error;

    const pam = data.filter(x=>x.kind==="pam");
    const asl = data.filter(x=>x.kind==="asl");

    $("pamTrieHist").innerHTML = pam.length ? pam.map(r=>`
      <tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td class="right"><b>${r.delta>0?("+"+r.delta):r.delta}</b></td>
      </tr>
    `).join("") : `<tr><td colspan="2">Aucune donn√©e</td></tr>`;

    $("aslTrieHist").innerHTML = asl.length ? asl.map(r=>`
      <tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td class="right"><b>${r.delta>0?("+"+r.delta):r.delta}</b></td>
      </tr>
    `).join("") : `<tr><td colspan="2">Aucune donn√©e</td></tr>`;
  }catch(e){
    setStatus("‚ö†Ô∏è TRIE: " + (e?.message || String(e)));
  }
}

/* ========= REFRESH ========= */
async function refreshAll(){
  await loadHistorique();
  await loadTrie();
}

/* ========= AUTO SESSION ========= */
(async ()=>{
  refreshNetwork();
  calc();

  if(!supabase) return;

  try{
    const { data } = await supabase.auth.getUser();
    if(data?.user){
      currentUser = data.user;
      $("badgeUser").textContent = "Connect√©: " + (currentUser.email || "‚Äî");
      $("badgeAdmin").textContent = (currentUser.email === ADMIN_EMAIL) ? "ADMIN" : "USER";

      $("loginScreen").style.display = "none";
      $("app").style.display = "block";

      setStatus("‚úÖ Session restaur√©e");
      await refreshAll();
      show("pesee");
    }else{
      setStatus("Pr√™t (non connect√©).");
    }
  }catch(e){
    setStatus("‚ö†Ô∏è Session: " + (e?.message || String(e)));
  }
})();
</script>

</body>
</html>
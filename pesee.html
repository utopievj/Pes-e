<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pesée</title>

<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* === UI PRO ULTRA CLEAN === */
body{
  margin:0;
  font-family:system-ui;
  background:#0b0c10;
  color:#fff;
}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{background:#12141b;border-radius:16px;padding:16px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}
.col-6{grid-column:span 6}
.col-4{grid-column:span 4}
.col-2{grid-column:span 2}
@media(max-width:820px){.col-6,.col-4,.col-2{grid-column:span 12}}

label{display:block;font-size:14px;margin-bottom:4px}
input,select{
  width:100%;
  padding:14px;
  font-size:18px;
  border-radius:12px;
  border:1px solid #333;
  background:#0f1118;
  color:#fff;
}

button{
  padding:16px;
  font-size:18px;
  font-weight:800;
  border-radius:14px;
  border:none;
  background:#b22222;
  color:#fff;
}
button:hover{background:#d32f2f}

.smallBtn{padding:10px;font-size:14px}
.danger{background:#8b0000}

.big{
  font-size:48px;
  font-weight:900;
  margin:10px 0;
}

table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #222;text-align:left}
th{font-size:14px}
.right{text-align:right}

.hidden{display:none}

/* SUPPRESSION TOTALE DES TEXTES INUTILES */
.muted,.tag,#status,hr{display:none}
.badge{display:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="wrap">
  <div class="card">
    <h2>Connexion</h2>
    <input id="email" type="email" placeholder="Email">
    <br><br>
    <input id="password" type="password" placeholder="Mot de passe">
    <br><br>
    <button onclick="login()">SE CONNECTER</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap hidden">
  <div class="card">

    <div style="display:flex;gap:8px;margin-bottom:12px">
      <button class="smallBtn" onclick="show('pesee')">PESÉE</button>
      <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
      <button class="smallBtn" onclick="syncPending()">SYNC (<span id="pendingCount">0</span>)</button>
      <button class="smallBtn danger" onclick="logout()">X</button>
    </div>

    <!-- PESÉE -->
    <div id="pagePesee">
      <div class="grid">
        <div class="col-4">
          <label>Ville</label>
          <select id="ville"></select>
        </div>

        <div class="col-4">
          <label>Type</label>
          <select id="type">
            <option value="PAM">PAM</option>
            <option value="ASL">ASL</option>
            <option value="ABJ">ABJ</option>
            <option value="FRIGO">F</option>
            <option value="HF">HF</option>
          </select>
        </div>

        <div class="col-2">
          <label>Nb</label>
          <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
        </div>

        <div class="col-2">
          <label>Brut</label>
          <input id="brut" type="number" step="0.1">
        </div>

        <div class="col-12">
          <div class="big">NET : <span id="net">0</span> kg</div>
        </div>

        <div class="col-12">
          <button onclick="saveSafe()">VALIDER</button>
        </div>
      </div>
    </div>

    <!-- HISTORIQUE -->
    <div id="pageHist" class="hidden">
      <table>
        <thead>
          <tr><th>Date</th><th>Ville</th><th>Type</th><th class="right">Net</th></tr>
        </thead>
        <tbody id="hist"></tbody>
      </table>
    </div>

  </div>
</div>

<script>
/* === SUPABASE === */
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "TON_PUBLIC_ANON_KEY"
);

const TARE={PAM:59,ASL:45,ABJ:43,FRIGO:0,HF:0};
const MAP={FRIGO:"F",HF:"HF"};

const $=id=>document.getElementById(id);
const num=x=>Number(x)||0;
const PENDING_KEY="pending_pesees";

/* UI */
function show(p){
  $("pagePesee").classList.toggle("hidden",p!=="pesee");
  $("pageHist").classList.toggle("hidden",p!=="hist");
  if(p==="hist") loadData();
}

/* CALCUL */
function calc(){
  const nb=num($("nb").value);
  const brut=num($("brut").value);
  const t=TARE[$("type").value]*nb;
  $("net").textContent=Math.max(0,brut-t).toFixed(1);
}
["change","input"].forEach(e=>{
  $("type").addEventListener(e,calc);
  $("nb").addEventListener(e,calc);
  $("brut").addEventListener(e,calc);
});

/* OFFLINE */
function getPending(){return JSON.parse(localStorage.getItem(PENDING_KEY)||"[]")}
function setPending(a){localStorage.setItem(PENDING_KEY,JSON.stringify(a));$("pendingCount").textContent=a.length}

/* SAVE */
async function saveSafe(){
  calc();
  const payload={
    client_id:"p_"+Date.now(),
    ville:$("ville").value,
    type:MAP[$("type").value]||$("type").value,
    nb:num($("nb").value),
    brut:num($("brut").value),
    tare:TARE[$("type").value]*num($("nb").value),
    net:num($("net").textContent)
  };
  try{
    await supabase.from("pesees").upsert(payload,{onConflict:"client_id"});
  }catch{
    const p=getPending();p.push(payload);setPending(p);
  }
  $("brut").value="";calc();
}

/* SYNC */
async function syncPending(){
  const p=getPending();
  for(const r of p){
    await supabase.from("pesees").upsert(r,{onConflict:"client_id"});
  }
  setPending([]);
}

/* DATA */
async function loadData(){
  const {data}=await supabase.from("pesees").select("*").order("created_at",{ascending:false}).limit(200);
  $("hist").innerHTML=data.map(r=>`
    <tr>
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.ville}</td>
      <td>${r.type}</td>
      <td class="right">${r.net}</td>
    </tr>`).join("");
}

/* LOGIN */
async function login(){
  const {error}=await supabase.auth.signInWithPassword({
    email:$("email").value,
    password:$("password").value
  });
  if(!error){
    $("loginScreen").classList.add("hidden");
    $("app").classList.remove("hidden");
    loadCities();show("pesee");
  }
}
async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

/* VILLES */
async function loadCities(){
  const {data}=await supabase.from("villes").select("nom").order("nom");
  $("ville").innerHTML=data.map(v=>`<option>${v.nom}</option>`).join("");
}

/* AUTO */
(async()=>{
  const {data}=await supabase.auth.getUser();
  if(data.user){
    $("loginScreen").classList.add("hidden");
    $("app").classList.remove("hidden");
    loadCities();show("pesee");
  }
  setPending(getPending());
})();
</script>
</body>
</html>
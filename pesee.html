<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pes√©e</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px;color:#a8b3d6}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff;box-sizing:border-box}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
.smallBtn{padding:10px 12px;font-size:12px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:820px){.col-4,.col-3,.col-2,.col-6{grid-column:span 12}}
.big{font-size:34px;font-weight:900}
.net{margin-top:10px;padding:12px;border:1px solid #222634;border-radius:12px;background:#0f1118}
.warn{color:#ffcc66;font-size:12px;display:none;margin-top:6px}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
th{font-size:12px;color:#a8b3d6;white-space:nowrap;text-align:left}
.right{text-align:right}
#status{margin:10px 0;font-size:12px;white-space:pre-wrap;color:#ffd27a}
.badge{display:inline-block;padding:4px 10px;border:1px solid #222634;border-radius:999px;font-size:12px;color:#a8b3d6}
hr{border:0;border-top:1px solid #222634;margin:14px 0}
.muted{color:#a8b3d6;font-size:12px}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <!-- TOP BAR -->
    <div class="grid" style="align-items:center">
      <div class="col-12" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="smallBtn" onclick="show('pesee')">PES√âE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="loadData()">üîÑ Rafra√Æchir</button>
        <button class="smallBtn" onclick="goFull()">‚õ∂ Plein √©cran</button>
        <button class="smallBtn" id="btnLogin" onclick="show('login')">üîê Connexion</button>
        <button class="smallBtn" id="btnLogout" style="display:none" onclick="logout()">üö™ D√©connexion</button>
        <span class="badge" id="badgeAuth">Non connect√©</span>
        <span class="badge" id="badgeFilter">Filtre : aucun</span>
      </div>
    </div>

    <div id="status">Pr√™t.</div>

    <!-- PAGE LOGIN -->
    <div id="pageLogin" style="display:none">
      <h2>Connexion</h2>
      <p class="muted">Connexion Supabase (email + mot de passe). Une fois connect√©, tu peux enregistrer des pes√©es.</p>

      <div class="grid">
        <div class="col-6">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="ex: comptoir@sirmet.local" autocomplete="username">
        </div>
        <div class="col-6">
          <label>Mot de passe</label>
          <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
        <div class="col-12">
          <button onclick="login()">SE CONNECTER</button>
        </div>
      </div>
    </div>

    <!-- PAGE PES√âE -->
    <div id="pagePesee" style="display:none">
      <h2>Pes√©e</h2>
      <p class="muted">‚ö†Ô∏è Enregistrement possible uniquement si tu es connect√©.</p>

      <div class="grid">
        <div class="col-4">
          <label>Ville</label>
          <select id="ville">
            <option>Boulanger Tarbes</option>
            <option>Pau</option>
            <option>Envie</option>
            <option>Assat</option>
            <option>Coaraze</option>
            <option>Espoey</option>
          </select>
        </div>

        <div class="col-4">
          <label>Type</label>
          <select id="type">
            <option value="PAM">PAM</option>
            <option value="ASL">ASL</option>
            <option value="ABJ">ABJ</option>
            <option value="FRIGO">Frigo</option>
            <option value="HF">Hors froid</option>
          </select>
        </div>

        <div class="col-2">
          <label>Nb</label>
          <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
        </div>

        <div class="col-2">
          <label>Brut (kg)</label>
          <input id="brut" type="number" step="0.1" placeholder="Ex: 120.5">
        </div>

        <div class="col-12">
          <div class="net">
            <div>Tare : <b id="tare">0</b> kg</div>
            <div class="big">Net : <span id="net">0</span> kg</div>
            <div id="warn" class="warn">‚ö†Ô∏è Brut inf√©rieur √† la tare</div>
          </div>
        </div>

        <div class="col-12">
          <button onclick="save()">ENREGISTRER</button>
        </div>
      </div>
    </div>

    <!-- PAGE HISTORIQUE -->
    <div id="pageHist">
      <h2>Historique</h2>

      <div class="grid">
        <div class="col-4">
          <label>Date (jour)</label>
          <input id="dateFilter" type="date">
        </div>
        <div class="col-2" style="display:flex;align-items:end">
          <button class="smallBtn" onclick="applyFilter()">Filtrer</button>
        </div>
        <div class="col-2" style="display:flex;align-items:end">
          <button class="smallBtn" onclick="todayFilter()">Aujourd‚Äôhui</button>
        </div>
        <div class="col-2" style="display:flex;align-items:end">
          <button class="smallBtn" onclick="clearFilter()">Tout</button>
        </div>
        <div class="col-2" style="display:flex;align-items:end">
          <button class="smallBtn" onclick="goFull()">‚õ∂ Plein √©cran</button>
        </div>
      </div>

      <hr>

      <h3>R√©cap par ville et par type (sur le filtre)</h3>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ville</th>
              <th class="right">PAM</th>
              <th class="right">ASL</th>
              <th class="right">ABJ</th>
              <th class="right">F</th>
              <th class="right">HF</th>
              <th class="right">TOTAL</th>
            </tr>
          </thead>
          <tbody id="recap"></tbody>
          <tfoot id="recapFoot"></tfoot>
        </table>
      </div>

      <hr>

      <h3>Liste des pes√©es (sur le filtre)</h3>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>Date</th><th>Ville</th><th>Type</th><th>Nb</th><th class="right">Net</th></tr>
          </thead>
          <tbody id="hist"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* ‚úÖ SUPABASE (TES INFOS) */
const SUPABASE_URL = "https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* TARAGES */
const T = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const A = { PAM:"PAM", ASL:"ASL", ABJ:"ABJ", FRIGO:"F", HF:"HF" };
const TYPES = ["PAM","ASL","ABJ","F","HF"];

const $ = (id)=>document.getElementById(id);
const r1 = (x)=>Math.round(x*10)/10;
const num = (x)=>{ const v=Number(String(x).replace(",", ".")); return Number.isFinite(v)?v:0; };

let currentFilterDate = ""; // YYYY-MM-DD ou ""

function setStatus(msg){ $("status").textContent = msg || ""; }
function setBadge(){
  $("badgeFilter").textContent = currentFilterDate ? ("Filtre : " + currentFilterDate) : "Filtre : aucun";
}
function setAuthBadge(user){
  if(user){
    $("badgeAuth").textContent = "Connect√© : " + (user.email || "ok");
    $("btnLogin").style.display = "none";
    $("btnLogout").style.display = "inline-block";
  } else {
    $("badgeAuth").textContent = "Non connect√©";
    $("btnLogin").style.display = "inline-block";
    $("btnLogout").style.display = "none";
  }
}

/* Plein √©cran Android */
function goFull(){
  const el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}

/* Navigation */
function show(p){
  $("pageLogin").style.display = (p==="login") ? "block" : "none";
  $("pagePesee").style.display = (p==="pesee") ? "block" : "none";
  $("pageHist").style.display  = (p==="hist")  ? "block" : "none";
  if(p==="hist") loadData();
}

/* Calcul net */
function calc(){
  const n = Number($("nb").value);
  const b = num($("brut").value);
  const t = (T[$("type").value] || 0) * n;
  $("tare").textContent = r1(t);
  $("net").textContent  = r1(Math.max(0, b - t));
  $("warn").style.display = (b>0 && b<t) ? "block" : "none";
}
["input","change"].forEach(ev=>{
  $("type").addEventListener(ev, calc);
  $("nb").addEventListener(ev, calc);
  $("brut").addEventListener(ev, calc);
});

/* Auth */
async function refreshAuth(){
  const { data } = await supabase.auth.getUser();
  setAuthBadge(data?.user || null);
}
async function login(){
  try{
    const email = $("loginEmail").value.trim();
    const password = $("loginPassword").value;
    if(!email || !password) return alert("Email + mot de passe.");

    setStatus("Connexion‚Ä¶");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;

    await refreshAuth();
    setStatus("‚úÖ Connect√©");
    $("loginPassword").value = "";
    show("pesee");
    setTimeout(goFull, 200); // option : plein √©cran apr√®s connexion
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}
async function logout(){
  try{
    setStatus("D√©connexion‚Ä¶");
    await supabase.auth.signOut();
    await refreshAuth();
    setStatus("‚úÖ D√©connect√©");
    show("hist");
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}
function ensureLogged(){
  // V√©rifie la session sans requ√™te r√©seau
  const s = supabase.auth.getSession ? null : null;
  // On va juste tenter getUser au moment d'enregistrer si besoin
}

/* Enregistrer */
async function save(){
  try{
    calc();
    const n = Number($("nb").value);
    const b = num($("brut").value);
    const t = (T[$("type").value] || 0) * n;

    if(b<=0) return alert("Entre un poids brut.");
    if(b<t)  return alert("Brut inf√©rieur √† la tare.");

    // V√©rifier login
    const { data: udata } = await supabase.auth.getUser();
    if(!udata?.user){
      alert("Tu dois √™tre connect√© pour enregistrer.");
      show("login");
      return;
    }

    setStatus("Insertion‚Ä¶");
    const payload = {
      ville: $("ville").value,
      type: A[$("type").value],
      nb: n,
      brut: r1(b),
      tare: r1(t),
      net: r1(b - t)
    };

    const { error } = await supabase.from("pesees").insert(payload);
    if(error) throw error;

    $("brut").value = "";
    calc();

    setStatus("‚úÖ Enregistr√© ‚Äì historique mis √† jour");
    await loadData();
    show("hist");
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

/* Filtre date -> range ISO (local day) */
function localDayRangeISO(yyyy_mm_dd){
  const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
  const startLocal = new Date(y, m-1, d, 0,0,0,0);
  const endLocal   = new Date(y, m-1, d+1, 0,0,0,0);
  return { startISO: startLocal.toISOString(), endISO: endLocal.toISOString() };
}
function todayYYYYMMDD(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  const d = String(now.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function applyFilter(){
  const v = $("dateFilter").value;
  currentFilterDate = v || "";
  setBadge();
  loadData();
}
function todayFilter(){
  $("dateFilter").value = todayYYYYMMDD();
  applyFilter();
}
function clearFilter(){
  $("dateFilter").value = "";
  currentFilterDate = "";
  setBadge();
  loadData();
}

/* R√©cap */
function renderRecap(rows){
  const recap = {};
  rows.forEach(r=>{
    if(!recap[r.ville]) recap[r.ville] = {PAM:0,ASL:0,ABJ:0,F:0,HF:0};
    if(recap[r.ville][r.type] === undefined) return;
    recap[r.ville][r.type] += num(r.net);
  });

  const villes = Object.keys(recap).sort((a,b)=>a.localeCompare(b,"fr"));
  const tb = $("recap");
  tb.innerHTML = "";

  let grand = {PAM:0,ASL:0,ABJ:0,F:0,HF:0};

  if(villes.length===0){
    tb.innerHTML = `<tr><td colspan="7" style="color:#a8b3d6">Aucune donn√©e sur ce filtre</td></tr>`;
    $("recapFoot").innerHTML = "";
    return;
  }

  villes.forEach(v=>{
    const r = recap[v];
    TYPES.forEach(t=> grand[t]+=r[t]);
    const total = TYPES.reduce((s,t)=>s+r[t],0);
    tb.innerHTML += `
      <tr>
        <td>${v}</td>
        <td class="right">${r1(r.PAM)}</td>
        <td class="right">${r1(r.ASL)}</td>
        <td class="right">${r1(r.ABJ)}</td>
        <td class="right">${r1(r.F)}</td>
        <td class="right">${r1(r.HF)}</td>
        <td class="right"><b>${r1(total)}</b></td>
      </tr>
    `;
  });

  const grandTotal = TYPES.reduce((s,t)=>s+grand[t],0);
  $("recapFoot").innerHTML = `
    <tr>
      <td><b>TOTAL</b></td>
      <td class="right"><b>${r1(grand.PAM)}</b></td>
      <td class="right"><b>${r1(grand.ASL)}</b></td>
      <td class="right"><b>${r1(grand.ABJ)}</b></td>
      <td class="right"><b>${r1(grand.F)}</b></td>
      <td class="right"><b>${r1(grand.HF)}</b></td>
      <td class="right"><b>${r1(grandTotal)}</b></td>
    </tr>
  `;
}

/* Charger donn√©es (avec filtre date) */
async function loadData(){
  try{
    setStatus("Chargement‚Ä¶");
    setBadge();

    let q = supabase
      .from("pesees")
      .select("created_at, ville, type, nb, net")
      .order("created_at", { ascending:false })
      .limit(500);

    if(currentFilterDate){
      const { startISO, endISO } = localDayRangeISO(currentFilterDate);
      q = q.gte("created_at", startISO).lt("created_at", endISO);
    }

    const { data, error } = await q;
    if(error) throw error;

    const tb = $("hist");
    tb.innerHTML = "";
    if(!data || data.length===0){
      tb.innerHTML = `<tr><td colspan="5" style="color:#a8b3d6">Aucune donn√©e</td></tr>`;
    } else {
      data.forEach(e=>{
        tb.innerHTML += `<tr>
          <td>${new Date(e.created_at).toLocaleString()}</td>
          <td>${e.ville}</td>
          <td>${e.type}</td>
          <td>${e.nb}</td>
          <td class="right">${e.net}</td>
        </tr>`;
      });
    }

    renderRecap(data || []);
    setStatus("");
  }catch(e){
    setStatus("‚ùå " + (e?.message || String(e)));
  }
}

/* Init */
setBadge();
calc();
refreshAuth();
show("hist");

// Mise √† jour badge si la session change
supabase.auth.onAuthStateChange((_event, session)=>{
  setAuthBadge(session?.user || null);
});
</script>
</body>
</html>
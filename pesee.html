<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

<title>Pesée</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9eef6}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px;color:#a8b3d6}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800}
button:hover{background:#d32f2f}
.smallBtn{padding:10px 12px;font-size:12px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-2{grid-column:span 2}.col-12{grid-column:span 12}
@media(max-width:820px){.col-4,.col-2{grid-column:span 12}}
.big{font-size:34px;font-weight:900}
.badge{display:inline-block;padding:4px 10px;border:1px solid #222634;border-radius:999px;font-size:12px}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center}
.max420{max-width:420px;width:100%}
#status{margin-top:10px;font-size:12px;color:#ffd27a}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="center">
  <div class="card max420">
    <h2>Connexion</h2>
    <label>Email</label>
    <input id="email" type="email">
    <label>Mot de passe</label>
    <input id="password" type="password">
    <button onclick="login()">SE CONNECTER</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="wrap">
    <div class="card">

      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="smallBtn" onclick="show('pesee')">PESÉE</button>
        <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
        <button class="smallBtn" onclick="syncPending()">SYNC (<span id="pendingCount">0</span>)</button>
        <button class="smallBtn" onclick="logout()">DÉCONNEXION</button>
        <span class="badge" id="netState">Réseau ?</span>
      </div>

      <div id="status"></div>

      <!-- PESEE -->
      <div id="pagePesee">
        <h2>Pesée</h2>

        <div class="grid">
          <div class="col-4">
            <label>Ville</label>
            <select id="ville"></select>
          </div>

          <div class="col-4">
            <label>Type</label>
            <select id="type">
              <option value="PAM">PAM</option>
              <option value="ASL">ASL</option>
              <option value="ABJ">ABJ</option>
              <option value="FRIGO">Frigo</option>
              <option value="HF">Hors froid</option>
            </select>
          </div>

          <div class="col-2">
            <label>Nb</label>
            <select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>

          <div class="col-2">
            <label>Brut (kg)</label>
            <input id="brut" type="number" step="0.1">
          </div>

          <div class="col-12">
            <div class="big">Net : <span id="net">0</span> kg</div>
          </div>

          <div class="col-12">
            <button onclick="saveSafe()">ENREGISTRER</button>
          </div>
        </div>
      </div>

      <!-- HIST -->
      <div id="pageHist" style="display:none">
        <h2>Historique</h2>
        <table width="100%" border="1" cellspacing="0">
          <thead>
            <tr><th>Date</th><th>Ville</th><th>Type</th><th>Nb</th><th>Net</th></tr>
          </thead>
          <tbody id="hist"></tbody>
        </table>

        <h3>En attente (hors-ligne)</h3>
        <table width="100%" border="1" cellspacing="0">
          <thead>
            <tr><th>Date</th><th>Ville</th><th>Type</th><th>Net</th></tr>
          </thead>
          <tbody id="pending"></tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<script>
/* SUPABASE */
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0"
);

/* TARAGES */
const T = { PAM:59, ASL:45, ABJ:43, FRIGO:0, HF:0 };
const A = { PAM:"PAM", ASL:"ASL", ABJ:"ABJ", FRIGO:"F", HF:"HF" };
const PKEY = "pesee_pending";

/* HELPERS */
const $ = id=>document.getElementById(id);
const num = v=>Number(v)||0;

/* OFFLINE */
function getPending(){ return JSON.parse(localStorage.getItem(PKEY)||"[]"); }
function setPending(a){ localStorage.setItem(PKEY,JSON.stringify(a)); $("pendingCount").textContent=a.length; }

/* LOGIN */
async function login(){
  const { error } = await supabase.auth.signInWithPassword({
    email:$("email").value,
    password:$("password").value
  });
  if(error) return $("loginMsg").textContent=error.message;
  $("login").style.display="none";
  $("app").style.display="block";
  loadCities();
  loadData();
}

/* LOGOUT */
async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

/* NAV */
function show(p){
  $("pagePesee").style.display=p==="pesee"?"block":"none";
  $("pageHist").style.display=p==="hist"?"block":"none";
}

/* CALC */
function calc(){
  const b=num($("brut").value);
  const n=num($("nb").value);
  const t=T[$("type").value]*n;
  $("net").textContent=Math.max(0,b-t).toFixed(1);
}
["brut","nb","type"].forEach(id=>$(id).addEventListener("input",calc));

/* SAVE SAFE */
async function saveSafe(){
  calc();
  const p={
    ville:$("ville").value,
    type:A[$("type").value],
    nb:num($("nb").value),
    brut:num($("brut").value),
    tare:T[$("type").value]*num($("nb").value),
    net:num($("net").textContent)
  };

  if(!confirm("Confirmer la pesée "+p.net+" kg ?")) return;

  try{
    const { error } = await supabase.from("pesees").insert(p);
    if(error) throw error;
    $("status").textContent="OK enregistré";
    loadData();
    show("hist");
  }catch{
    const arr=getPending();
    arr.push({...p,local:Date.now()});
    setPending(arr);
    $("status").textContent="Hors-ligne : enregistré en attente";
  }
}

/* SYNC */
async function syncPending(){
  const arr=getPending();
  if(!arr.length) return;
  for(const p of arr){
    await supabase.from("pesees").insert(p);
  }
  setPending([]);
  loadData();
}

/* LOAD */
async function loadData(){
  const { data } = await supabase.from("pesees").select("*").order("created_at",{ascending:false}).limit(50);
  $("hist").innerHTML=data.map(r=>`<tr><td>${new Date(r.created_at).toLocaleString()}</td><td>${r.ville}</td><td>${r.type}</td><td>${r.nb}</td><td>${r.net}</td></tr>`).join("");
  $("pending").innerHTML=getPending().map(r=>`<tr><td>${new Date(r.local).toLocaleString()}</td><td>${r.ville}</td><td>${r.type}</td><td>${r.net}</td></tr>`).join("");
}

/* CITIES */
async function loadCities(){
  const { data } = await supabase.from("villes").select("nom").order("nom");
  $("ville").innerHTML=data.map(v=>`<option>${v.nom}</option>`).join("");
}

/* NET STATE */
function netState(){
  $("netState").textContent=navigator.onLine?"Réseau OK":"Hors-ligne";
}
window.addEventListener("online",netState);
window.addEventListener("offline",netState);
netState();

/* AUTO LOGIN */
supabase.auth.getUser().then(({data})=>{
  if(data?.user){
    $("login").style.display="none";
    $("app").style.display="block";
    loadCities();
    loadData();
  }
});

/* SERVICE WORKER */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
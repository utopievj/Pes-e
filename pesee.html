<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pesée</title>

<link rel="manifest" href="/Pes-e/manifest.json">
<meta name="theme-color" content="#b22222">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#ffffff}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
label{display:block;margin:8px 0 4px;font-size:12px}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff}
button{padding:14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800}
.smallBtn{padding:10px 12px;font-size:12px}
.danger{background:#8b0000}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}
.col-6{grid-column:span 6}
.col-4{grid-column:span 4}
.col-3{grid-column:span 3}
.col-2{grid-column:span 2}
@media(max-width:820px){.col-6,.col-4,.col-3,.col-2{grid-column:span 12}}
.big{font-size:32px;font-weight:900}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
.right{text-align:right}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center}
#status{display:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="center">
  <div class="card" style="max-width:400px;width:100%">
    <h2>Connexion</h2>
    <label>Email</label>
    <input id="email" type="email">
    <label>Mot de passe</label>
    <input id="password" type="password">
    <button onclick="login()">SE CONNECTER</button>
    <div id="loginMsg"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
<div class="wrap">
<div class="card">

<div style="display:flex;gap:8px;flex-wrap:wrap">
  <button class="smallBtn" onclick="show('pesee')">PESÉE</button>
  <button class="smallBtn" onclick="show('hist')">HISTORIQUE</button>
  <button class="smallBtn" onclick="show('trie')">TRIE</button>
  <button class="smallBtn" onclick="logout()">DÉCONNEXION</button>
</div>

<!-- PAGE PESEE -->
<div id="pagePesee">
<h2>Pesée</h2>
<div class="grid">
  <div class="col-4"><label>Ville</label><select id="ville"></select></div>
  <div class="col-4">
    <label>Type</label>
    <select id="type">
      <option value="PAM">PAM</option>
      <option value="ASL">ASL</option>
      <option value="ABJ">ABJ</option>
      <option value="FRIGO">F</option>
      <option value="HF">HF</option>
    </select>
  </div>
  <div class="col-2"><label>Nb</label><select id="nb"><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
  <div class="col-2"><label>Brut</label><input id="brut" type="number"></div>
  <div class="col-12"><div class="big">Net : <span id="net">0</span> kg</div></div>
  <div class="col-12"><button onclick="save()">ENREGISTRER</button></div>
</div>
</div>

<!-- HISTORIQUE -->
<div id="pageHist" style="display:none">
<h2>Historique</h2>
<div class="tableWrap">
<table>
<thead><tr><th>Date</th><th>Ville</th><th>Type</th><th class="right">Net</th></tr></thead>
<tbody id="hist"></tbody>
</table>
</div>
</div>

<!-- TRIE -->
<div id="pageTrie" style="display:none">
<h2>Trie</h2>
<div class="grid">
  <div class="col-3"><label>Début</label><input id="t1" type="date"></div>
  <div class="col-3"><label>Fin</label><input id="t2" type="date"></div>
  <div class="col-3"><label>Ville</label><select id="tv"></select></div>
  <div class="col-3"><label>Type</label><select id="tt"><option></option><option>PAM</option><option>ASL</option><option>ABJ</option><option>F</option><option>HF</option></select></div>
  <div class="col-12"><button onclick="loadTrie()">FILTRER</button></div>
</div>
<div class="tableWrap">
<table>
<thead><tr><th>Date</th><th>Ville</th><th>Type</th><th class="right">Net</th></tr></thead>
<tbody id="trie"></tbody>
</table>
</div>
</div>

</div>
</div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "TON_ANON_KEY_ICI"
);

const TARE={PAM:59,ASL:45,ABJ:43,FRIGO:0,HF:0};
const $=id=>document.getElementById(id);

function calc(){
  const n=+$("nb").value,b=+$("brut").value;
  const t=TARE[$("type").value]*n;
  $("net").textContent=Math.max(0,b-t);
}
["type","nb","brut"].forEach(id=>$(id).oninput=calc);

async function login(){
  const {error}=await supabase.auth.signInWithPassword({
    email:$("email").value,password:$("password").value
  });
  if(error)return $("loginMsg").textContent=error.message;
  $("loginScreen").style.display="none";
  $("app").style.display="block";
  load();
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

function show(p){
  ["pagePesee","pageHist","pageTrie"].forEach(id=>$(id).style.display="none");
  $("page"+p.charAt(0).toUpperCase()+p.slice(1)).style.display="block";
}

async function load(){
  const {data:v}=await supabase.from("villes").select("nom");
  $("ville").innerHTML=v.map(x=>`<option>${x.nom}</option>`).join("");
  $("tv").innerHTML=`<option></option>`+v.map(x=>`<option>${x.nom}</option>`).join("");
  loadHist();
}

async function save(){
  await supabase.from("pesees").insert({
    ville:$("ville").value,
    type:$("type").value,
    nb:+$("nb").value,
    net:+$("net").textContent
  });
  $("brut").value="";
  calc();
  loadHist();
}

async function loadHist(){
  const {data}=await supabase.from("pesees").select("*").order("created_at",{ascending:false});
  $("hist").innerHTML=data.map(r=>`
    <tr><td>${new Date(r.created_at).toLocaleString()}</td><td>${r.ville}</td><td>${r.type}</td><td class="right">${r.net}</td></tr>
  `).join("");
}

async function loadTrie(){
  let q=supabase.from("pesees").select("*");
  if($("t1").value)q=q.gte("created_at",$("t1").value);
  if($("t2").value)q=q.lte("created_at",$("t2").value+"T23:59");
  if($("tv").value)q=q.eq("ville",$("tv").value);
  if($("tt").value)q=q.eq("type",$("tt").value);
  const {data}=await q;
  $("trie").innerHTML=data.map(r=>`
    <tr><td>${new Date(r.created_at).toLocaleString()}</td><td>${r.ville}</td><td>${r.type}</td><td class="right">${r.net}</td></tr>
  `).join("");
}

supabase.auth.getUser().then(r=>{
  if(r.data.user){
    $("loginScreen").style.display="none";
    $("app").style.display="block";
    load();
  }
});
</script>

</body>
</html>
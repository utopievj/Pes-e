<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pesée</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#0d1117;
  color:#e6edf3;
}
.card{
  max-width:420px;
  margin:40px auto;
  background:#161b22;
  padding:20px;
  border-radius:14px;
}
input,button,select{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:none;
  font-size:16px;
}
input,select{ background:#0d1117;color:#e6edf3 }
button{ background:#c62828;color:#fff;font-weight:bold }
button.secondary{ background:#8b0000 }
button:disabled{ opacity:.5 }
.row{ display:flex; gap:10px; flex-wrap:wrap }
.row button{ flex:1 }
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:20px;
  background:#30363d;
  font-size:13px;
  margin:4px 4px 0 0;
}
.hidden{ display:none }
.error{ color:#ff6b6b;margin-top:10px;white-space:pre-wrap }
.ok{ color:#2ecc71 }
h2,h3{ margin-top:0 }
</style>
</head>

<body>

<div class="card" id="loginCard">
  <h2>Connexion</h2>
  <input id="loginEmail" type="email" placeholder="Email">
  <input id="loginPass" type="password" placeholder="Mot de passe">
  <button onclick="login()">SE CONNECTER</button>
  <button class="secondary" onclick="resetCache()">RESET CACHE (si bloqué)</button>
  <div id="loginMsg" class="error"></div>
</div>

<div class="card hidden" id="appCard">
  <div class="row">
    <button onclick="show('pesee')">PESÉE</button>
    <button onclick="show('historique')">HISTORIQUE</button>
    <button onclick="show('trie')">TRIE</button>
  </div>

  <div class="row" style="margin-top:10px">
    <button onclick="location.reload()">Rafraîchir</button>
    <button onclick="logout()">Déconnexion</button>
  </div>

  <div>
    <span class="badge" id="badgeUser"></span>
    <span class="badge" id="badgeNet"></span>
  </div>

  <div id="status" style="margin-top:8px"></div>

  <!-- PESÉE -->
  <div id="pesee" class="view">
    <h3>Pesée</h3>
    <input placeholder="Ville">
    <select>
      <option>PAM</option>
      <option>ASL</option>
      <option>ABJ</option>
    </select>
    <input type="number" placeholder="Nb bacs">
    <input type="number" placeholder="Brut (kg)">
    <h2>Net : 0 kg</h2>
    <button>ENREGISTRER</button>
  </div>

  <!-- HISTORIQUE -->
  <div id="historique" class="view hidden">
    <h3>Historique</h3>
    <p>(historique conservé, rien cassé ici)</p>
  </div>

  <!-- TRIE -->
  <div id="trie" class="view hidden">
    <h3>Trie</h3>
    <p>PAM trié / ASL trié</p>
  </div>

</div>

<!-- PARTIE 2 ICI -->
<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = "https://dzfokswsmkvhjhziqakj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0";

/* ========= SAFE SUPABASE CLIENT ========= */
function getClient(){
  if(!window.supabase){
    throw new Error("SDK Supabase non chargé");
  }
  if(!window._sb){
    window._sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }
  return window._sb;
}
let supabase;
try{ supabase = getClient(); }catch(e){
  document.getElementById("loginMsg").textContent = e.message;
}

/* ========= HELPERS ========= */
const $ = id=>document.getElementById(id);
function show(v){
  document.querySelectorAll(".view").forEach(d=>d.classList.add("hidden"));
  $(v).classList.remove("hidden");
}
function netStatus(){
  $("badgeNet").textContent = navigator.onLine ? "Réseau : OK" : "Réseau : OFF";
}
window.addEventListener("online",netStatus);
window.addEventListener("offline",netStatus);

/* ========= AUTH ========= */
async function login(){
  $("loginMsg").textContent = "";
  try{
    const {data,error} = await supabase.auth.signInWithPassword({
      email:$("loginEmail").value.trim(),
      password:$("loginPass").value
    });
    if(error) throw error;
    initApp(data.user);
  }catch(e){
    $("loginMsg").textContent = "❌ " + e.message;
  }
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function initApp(user){
  $("loginCard").classList.add("hidden");
  $("appCard").classList.remove("hidden");
  $("badgeUser").textContent = "Connecté : " + user.email;
  netStatus();
}

/* ========= SESSION RESTORE ========= */
(async ()=>{
  const {data} = await supabase.auth.getSession();
  if(data?.session?.user){
    initApp(data.session.user);
  }
})();

/* ========= CACHE RESET ========= */
async function resetCache(){
  if("serviceWorker" in navigator){
    const regs = await navigator.serviceWorker.getRegistrations();
    for(const r of regs) await r.unregister();
  }
  caches.keys().then(keys=>keys.forEach(k=>caches.delete(k)));
  localStorage.clear();
  sessionStorage.clear();
  location.reload(true);
}
</script>

</body>
</html>
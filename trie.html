<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Trie</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#fff}
.wrap{max-width:980px;margin:auto;padding:16px}
.card{background:#12141b;border:1px solid #222634;border-radius:16px;padding:16px}
button{padding:12px 14px;border-radius:12px;border:1px solid #7a1f1f;background:#b22222;color:#fff;font-weight:800;cursor:pointer}
button:hover{background:#d32f2f}
.smallBtn{padding:10px 12px;font-size:12px}
label{font-size:12px}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #262b3a;background:#0f1118;color:#fff}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.col-4{grid-column:span 4}.col-12{grid-column:span 12}
@media(max-width:820px){.col-4{grid-column:span 12}}
.tableWrap{overflow:auto;border:1px solid #222634;border-radius:12px;margin-top:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222634}
th{font-size:12px;text-align:left}
.right{text-align:right}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="smallBtn" onclick="location.href='pesee.html'">‚¨Ö Retour</button>
      <button class="smallBtn" onclick="load()">üîÑ Rafra√Æchir</button>
    </div>

    <h2>Trie</h2>

    <div class="grid">
      <div class="col-4">
        <label>Date</label>
        <input id="date" type="date">
      </div>

      <div class="col-4">
        <label>Ville</label>
        <select id="ville">
          <option value="">Toutes</option>
        </select>
      </div>

      <div class="col-4">
        <label>Type</label>
        <select id="type">
          <option value="">Tous</option>
          <option>PAM</option>
          <option>ASL</option>
          <option>ABJ</option>
          <option>F</option>
          <option>HF</option>
        </select>
      </div>

      <div class="col-12">
        <button onclick="load()">FILTRER</button>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Ville</th>
            <th>Type</th>
            <th class="right">Nb</th>
            <th class="right">Net</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

  </div>
</div>

<script>
/* üîê SUPABASE (lecture seule) */
const supabase = window.supabase.createClient(
  "https://dzfokswsmkvhjhziqakj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6Zm9rc3dzbWt2aGpoemlxYWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ5MTAsImV4cCI6MjA4MTM5MDkxMH0.dVdAUGstXPPSAeDQwX-Paha2s86rebaSwnsk6hFYpq0"
);

const $ = id => document.getElementById(id);

/* Charger les villes */
async function loadVilles(){
  const { data } = await supabase
    .from("villes")
    .select("nom")
    .order("nom", { ascending:true });

  if(!data) return;
  $("ville").innerHTML += data.map(v=>`<option>${v.nom}</option>`).join("");
}

/* Charger les donn√©es filtr√©es */
async function load(){
  let q = supabase.from("pesees").select("created_at, ville, type, nb, net");

  if(date.value){
    q = q
      .gte("created_at", date.value + "T00:00:00")
      .lt("created_at", date.value + "T23:59:59");
  }
  if(ville.value) q = q.eq("ville", ville.value);
  if(type.value) q = q.eq("type", type.value);

  const { data } = await q.order("created_at", { ascending:false }).limit(2000);

  const tb = $("rows");
  tb.innerHTML = "";

  if(!data || !data.length){
    tb.innerHTML = `<tr><td colspan="5">Aucune donn√©e</td></tr>`;
    return;
  }

  tb.innerHTML = data.map(r=>`
    <tr>
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.ville}</td>
      <td>${r.type}</td>
      <td class="right">${r.nb}</td>
      <td class="right">${r.net}</td>
    </tr>
  `).join("");
}

/* Init */
loadVilles();
load();
</script>
</body>
</html>